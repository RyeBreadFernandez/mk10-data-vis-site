"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8573],{54939:(J,S,n)=>{n.d(S,{P:()=>W,o:()=>L});var e=n(2543),x=n.n(e),i=n(96540),M=n(45214),g=n(24705),D=n(10096),I=n(31678),R=n(85927);const L=v=>{const[f,y]=(0,i.useState)(v),{value:j=[]}=(0,g.A)(async()=>D.TP.licensedAccessControlEnabled()&&D.TP.hasPermission(I.AccessControlAction.ActionRolesList)?(0,R.RL)(f):Promise.resolve([]),[f]);return[{roleOptions:j},y]},W=v=>{const[f,y]=(0,i.useState)({});return(0,M.A)(()=>{if(!D.TP.licensedAccessControlEnabled()||!D.TP.hasPermission(I.AccessControlAction.ActionRolesList))return;const j=Object.keys(f).map(d=>typeof d=="number"?d:parseInt(d,10)),U=(0,e.difference)(v,j);Promise.all(U.map(d=>(0,R.RL)(d).then(A=>[d,A]))).then(d=>{y({...f,...Object.fromEntries(d)})})},[v]),f}},20996:(J,S,n)=>{n.r(S),n.d(S,{default:()=>at});var e=n(74848),x=n(2543),i=n(96540),M=n(71468),g=n(67061),D=n(67647),I=n(55852),R=n(96374),L=n(48840),W=n(19384),v=n(9025),f=n(21780),y=n(37425),j=n(54939),U=n(69529),d=n(72109),A=n(8484);function Q(){return(0,e.jsx)(U.p,{variant:"call-to-action",message:(0,A.t)("groupsync.empty-state.title","You haven't created any group mappings yet"),children:(0,e.jsxs)(A.x6,{i18nKey:"groupsync.empty-state.pro-tip",children:["Want to manage Grafana access through groups in your Identity Provider? Create group mappings to Grafana RBAC roles."," ",(0,e.jsx)(d.Y,{external:!0,href:"https://grafana.com/docs/grafana/latest/administration/group-attribute-sync",children:"Learn more"})]})})}var N=n(88575),V=n(10354),K=n(10096),X=n(24705),C=n(17172);const Y=50;function Z(o,t,r){const s={page:o,perPage:t};return typeof r.groupID=="string"&&r.groupID.trim().length>0&&(s.groupID=r.groupID),(0,C.AI)().get("/api/groupsync/groups",s)}async function w(o,t){await(0,C.AI)().post(`/api/groupsync/groups/${o}`,t)}async function b(o,t){await(0,C.AI)().put(`/api/groupsync/groups/${o}`,t)}async function k(o){await(0,C.AI)().delete(`/api/groupsync/groups/${o}`)}function q(o,t){const[r,s]=(0,i.useState)([]),[c,l]=(0,i.useState)(!0),[u,O]=(0,i.useState)(!1),[P,p]=(0,i.useState)(0),[a,G]=(0,i.useState)(o),[m,T]=(0,i.useState)(t);(0,X.A)(async()=>{l(!0);const h=await Z(a,Y,m);s(h.groups),p(h.total),l(!1),u||O(!0)},[a,m]);function $(h){T({...m,groupID:h})}async function E(h){let z=a;h&&(G(1),z=1),l(!0);const B=await Z(z,Y,m);s(B.groups),p(B.total),l(!1)}return{groups:r,loading:c,initialized:u,total:P,page:a,setPage:G,filters:m,setGroupIDFilter:$,refresh:E}}const H={groupID:"",mappings:{}};function _(o=H){const[t,r]=(0,i.useState)(o);return{group:t,setGroupID:s=>{r({...t,groupID:s})},setRoles:(s,c)=>{r(l=>{const u=(0,x.cloneDeep)(l.mappings);return u[s]===void 0?u[s]={roles:c}:u[s].roles=c,{...l,mappings:u}})},canSave:()=>!(t.groupID.length===0||(0,x.isEqual)(t.mappings,o.mappings)),save:s=>o.groupID===""?w(t.groupID,t.mappings[s]):b(t.groupID,t.mappings[s]),reset:()=>{r(H)}}}function tt({onSave:o}){const t=_(),[{roleOptions:r}]=(0,j.o)(K.TP.user.orgId),[s,c]=(0,i.useState)([]),[l,u]=(0,i.useState)(!1),O=p=>{p.preventDefault(),u(!0),t.save(K.TP.user.orgId).then(()=>{u(!1),c([]),o(t.group),t.reset()}).catch(a=>{console.error(a)})},P=p=>{t.setGroupID(p.currentTarget.value)};return(0,e.jsx)("form",{onSubmit:O,children:(0,e.jsxs)(g.B,{gap:1,alignItems:"end",children:[(0,e.jsx)(N.D,{label:"Group ID",style:{marginBottom:0},children:(0,e.jsx)(V.p,{type:"text",name:"groupID",value:t.group.groupID,onChange:P,width:50})}),(0,e.jsx)(N.D,{label:"Roles",style:{marginBottom:0},children:(0,e.jsx)(y.n,{appliedRoles:s,onRolesChange:p=>{c(p),t.setRoles(K.TP.user.orgId,p.map(a=>a.uid))},roleOptions:r,basicRoleDisabled:!0,canUpdateRoles:!0})}),(0,e.jsx)(I.$n,{type:"submit",disabled:!t.canSave()||l,children:"Save"})]})})}function et(o){const t=[];for(const r of o)for(const[s,c]of Object.entries(r.mappings))t.push({groupID:r.groupID,orgID:parseInt(s,10),roles:c.roles});return t}function nt(o){const t=new Set;return o.forEach(r=>t.add(r.orgID)),Array.from(t)}function st({groupsList:o}){const[t,r]=(0,i.useState)(!1);return(0,e.jsxs)(g.B,{direction:"column",gap:2,children:[(0,e.jsxs)(g.B,{justifyContent:"space-between",children:[(0,e.jsx)(g.B,{gap:1,children:(0,e.jsx)(D.Z,{value:o.filters.groupID,onChange:o.setGroupIDFilter,placeholder:"Search by group ID",width:60})}),(0,e.jsx)(I.$n,{onClick:()=>r(!t),children:t?"Close":"New"})]}),(0,e.jsx)(v.a,{in:t,children:(0,e.jsx)("div",{className:"cta-form",style:{marginBottom:0},children:(0,e.jsxs)(g.B,{direction:"column",gap:1,children:[(0,e.jsx)("h5",{children:"New group mapping"}),t&&(0,e.jsx)(tt,{onSave:()=>o.refresh(!0)})]})})})]})}function ot({userOrgs:o}){const[t,r]=(0,i.useState)(""),s=q(1,{groupID:""}),c=et(s.groups),l=nt(c);l.length===0&&l.push(1);const u=(0,j.P)(l),O=o.length===1;function P(){k(t).then(()=>{s.refresh(!1)}).finally(()=>{r("")})}const p=(0,i.useMemo)(()=>[{id:"groupID",header:"Group",cell:({cell:a})=>(0,e.jsx)("code",{children:a.value})},{id:"roles",header:"Roles",cell:({cell:a})=>{const{orgID:G,groupID:m}=a.row.original,T=u[a.row.original.orgID]||[],$=E=>{const h=s.groups.find(F=>F.groupID===m);if(h===void 0)throw new Error("expected groupsList to contain table item");const B={...(0,x.cloneDeep)(h).mappings[G],roles:E.map(F=>F.uid)};b(m,B)};return(0,e.jsx)(y.n,{appliedRoles:T.filter(E=>a.row.original.roles.includes(E.uid)),onRolesChange:$,roleOptions:T,basicRoleDisabled:!0,apply:!0,canUpdateRoles:!0})}},{id:"delete",header:"",cell:({cell:a})=>(0,e.jsx)(g.B,{justifyContent:"end",children:(0,e.jsx)(I.$n,{variant:"secondary",onClick:()=>r(a.row.original.groupID),icon:"trash-alt","aria-label":"Delete group mapping"})})}],[s,u]);return(0,e.jsxs)(f.YW,{navId:"groupsync",children:[(0,e.jsx)(R.u,{isOpen:!(0,x.isEmpty)(t),title:"Delete group mappings",body:"Are you sure you want to delete all mappings for this group?",confirmText:"Delete",onConfirm:P,onDismiss:()=>r("")}),(0,e.jsx)(f.YW.Contents,{isLoading:s.loading&&!s.initialized,children:(0,e.jsxs)(g.B,{direction:"column",gap:1,children:[(0,e.jsx)(st,{groupsList:s,singleOrg:O}),s.initialized&&s.groups.length>0?(0,e.jsx)(L.j,{columns:p,data:c,getRowId:a=>`${a.orgID}/${a.groupID}`}):(0,e.jsx)(Q,{}),s.total>50&&(0,e.jsx)(g.B,{justifyContent:"end",children:(0,e.jsx)(W.d,{currentPage:s.page,numberOfPages:Math.ceil(s.total/50),onNavigate:a=>{s.setPage(a)}})})]})})]})}const rt=o=>({userOrgs:o.organization.userOrgs}),at=(0,M.connect)(rt,{})(ot)}}]);

//# sourceMappingURL=GroupSync.09f3bcbe7c8a3de55d57.js.map