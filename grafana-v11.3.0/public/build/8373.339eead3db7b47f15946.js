"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8373],{31099:(fe,q,t)=>{t.d(q,{A:()=>z});var e=t(74848),n=t(32196),A=t(1932),p=t(96540),E=t(49785),T=t(42941),F=t(40845),O=t(67061),$=t(94753),S=t(10354),H=t(21744),Q=t(88575),k=t(55852),U=t(8484),c=t(55740);const x=({field:s})=>{const a=(0,F.of)(v);return(0,e.jsxs)("div",{children:[(0,e.jsx)("span",{className:a.annotationTitle,children:"Custom annotation name and content"}),(0,e.jsx)(S.p,{placeholder:"Enter custom annotation name...",width:18,...s,className:a.customAnnotationInput})]})},v=s=>({annotationTitle:(0,n.css)({color:s.colors.text.primary,marginBottom:"3px"}),customAnnotationInput:(0,n.css)({marginTop:"5px",width:"100%"})}),j=x,N=({annotationField:s,annotations:a,annotation:i,index:d})=>{const{control:y}=(0,E.xW)();return(0,e.jsxs)(O.B,{direction:"column",gap:0,children:[(0,e.jsx)("label",{children:(0,e.jsx)(E.xI,{name:`annotations.${d}.key`,defaultValue:s.key,render:({field:{ref:l,...m}})=>{if(!c.J3[i])return(0,e.jsx)(j,{field:m});let W;switch(s.key){case c.YH.dashboardUID:W="Dashboard and panel";break;case c.YH.panelID:W="";break;default:W=c.J3[i]&&c.J3[i]+" (optional)"}return(0,e.jsx)("span",{"data-testid":`annotation-key-${d}`,children:(0,e.jsx)($.E,{color:"primary",variant:"bodySmall",children:W})})},control:y,rules:{required:{value:!!a[d]?.value,message:"Required."}}})}),(0,e.jsx)($.E,{variant:"bodySmall",color:"secondary",children:c.H8[i]})]})};var D=t(14578),V=t(78742);const ie=({dashboard:s,panel:a,dashboardUid:i,panelId:d,onEditClick:y,onDeleteClick:l})=>{const m=(0,F.of)(ce),W=(0,V.JM)(s?.uid||i),P=(0,V.D2)(s?.uid||i,a?.id?.toString()||d);return(0,e.jsxs)("div",{className:m.container,children:[s&&(0,e.jsxs)("a",{href:W,className:m.link,target:"_blank",rel:"noreferrer","data-testid":"dashboard-annotation",children:[s.title," ",(0,e.jsx)(D.I,{name:"external-link-alt"})]}),!s&&(0,e.jsxs)("span",{className:m.noLink,children:["Dashboard ",i," "]}),a&&(0,e.jsxs)("a",{href:P,className:m.link,target:"_blank",rel:"noreferrer","data-testid":"panel-annotation",children:[a.title||"<No title>"," ",(0,e.jsx)(D.I,{name:"external-link-alt"})]}),!a&&(0,e.jsxs)("span",{className:m.noLink,children:[" - Panel ",d]}),(s||a)&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(D.I,{name:"pen",onClick:y,className:m.icon}),(0,e.jsx)(D.I,{name:"trash-alt",onClick:l,className:m.icon})]})]})},ce=s=>({container:(0,n.css)({marginTop:"5px"}),noLink:(0,n.css)({color:s.colors.text.secondary}),link:(0,n.css)({color:s.colors.text.link,marginRight:s.spacing(1.5)}),icon:(0,n.css)({marginRight:s.spacing(1),cursor:"pointer"})}),Ae=ie;var xe=t(2543),Ee=t(40996),ve=t(70713),ye=t(91793),de=t(56034),ue=t(37390),Le=t(42418),te=t(67647),me=t(39558),Pe=t(49962);const re=Pe.H.injectEndpoints({endpoints:s=>({search:s.query({query:({query:a})=>{const i=new URLSearchParams({type:"dash-db",limit:"1000",page:"1",sort:"name_sort"});return a&&i.set("query",a),{url:`/api/search?${i.toString()}`}}}),dashboard:s.query({query:({uid:a})=>({url:`/api/dashboards/uid/${a}`})})})});var Be=t(41811),Ne=t(34214);const Me=(0,Be.A)(s=>{const{dashboard:a,meta:i}=structuredClone(s);return new Ne.G(a,i)});function be(s){return re.endpoints.dashboard.useQuery({uid:s??""},{skip:!s,selectFromResult:({currentData:i,data:d,...y})=>({dashboardModel:i?Me(i):void 0,...y})})}function pe(s,a){return s.title&&a.title?s.title.localeCompare(a.title):s.title&&!a.title?1:!s.title&&a.title?-1:0}const Re=({dashboardUid:s,panelId:a,isOpen:i,onChange:d,onDismiss:y})=>{const l=(0,F.of)(g),[m,W]=(0,p.useState)(s),[P,Y]=(0,p.useState)(a),[J,_]=(0,p.useState)(""),[R,b]=(0,p.useState)(""),[B,ee]=(0,p.useState)(""),{useSearchQuery:Z}=re,{currentData:K=[],isFetching:oe}=Z({query:R}),{dashboardModel:ne,isFetching:he}=be(m),Te=(0,p.useCallback)(C=>{W(C),Y(void 0)},[]),je=o(ne),De=je.filter(C=>C.title?.toLowerCase().includes(B.toLowerCase())).sort(pe)??[],f=je.find(C=>r(C)&&C.id?.toString()===P),I=(0,p.useMemo)(()=>K.map(C=>C.uid).indexOf(m??""),[K,m]),X=s&&s===m,ae=I>=0,le=(0,p.useCallback)(C=>{const se=I>=0;X&&se&&C?.scrollToItem(I,"smart")},[X,I]);(0,Ee.A)(()=>{b(J)},500,[J]);const Se=({index:C,style:se})=>{const G=K[C],Ie=m===G.uid;return(0,e.jsxs)("button",{type:"button",title:G.title,style:se,className:(0,n.cx)(l.rowButton,{[l.rowOdd]:C%2===1,[l.rowSelected]:Ie}),onClick:()=>Te(G.uid),children:[(0,e.jsx)("div",{className:(0,n.cx)(l.dashboardTitle,l.rowButtonTitle),children:G.title}),(0,e.jsxs)("div",{className:l.dashboardFolder,children:[(0,e.jsx)(D.I,{name:"folder"})," ",G.folderTitle??"Dashboards"]})]})},ge=({index:C,style:se})=>{const G=De[C],Ie=G.title||"<No title>",Oe=!!G.id&&P===G.id,Fe=G.type==="graph"||G.type==="timeseries",Ce=!r(G);return(0,e.jsxs)("button",{type:"button",style:se,disabled:Ce,className:(0,n.cx)(l.rowButton,l.panelButton,{[l.rowOdd]:C%2===1,[l.rowSelected]:Oe}),onClick:()=>Ce?xe.noop:Y(G.id),children:[(0,e.jsx)("div",{className:l.rowButtonTitle,title:Ie,children:Ie}),!Fe&&!Ce&&(0,e.jsx)(de.m,{content:"The alert tab and alert annotations are only supported on graph and timeseries panels.",children:(0,e.jsx)(D.I,{name:"exclamation-triangle",className:l.warnIcon,"data-testid":"warning-icon"})}),Ce&&(0,e.jsx)(de.m,{content:"This panel does not have a valid identifier.",children:(0,e.jsx)(D.I,{name:"info-circle","data-testid":"info-icon"})})]})};return(0,e.jsxs)(ue.a,{title:"Select dashboard and panel",closeOnEscape:!0,isOpen:i,onDismiss:y,className:l.modal,contentClassName:l.modalContent,children:[!ae&&s&&ne&&(0,e.jsxs)(Le.F,{title:"Current selection",severity:"info",topSpacing:0,bottomSpacing:1,className:l.modalAlert,children:[(0,e.jsxs)("div",{children:["Dashboard: ",ne.title," (",ne.uid,") in folder"," ",ne.meta?.folderTitle??"Dashboards"]}),f&&(0,e.jsxs)("div",{children:["Panel: ",f.title," (",f.id,")"]})]}),(0,e.jsxs)("div",{className:l.container,children:[(0,e.jsx)(te.Z,{value:J,onChange:_,title:"Search dashboard",placeholder:"Search dashboard",autoFocus:!0}),(0,e.jsx)(te.Z,{value:B,onChange:ee,title:"Search panel",placeholder:"Search panel"}),(0,e.jsxs)("div",{className:l.column,children:[oe&&(0,e.jsx)(me._,{text:"Loading dashboards...",className:l.loadingPlaceholder}),!oe&&(0,e.jsx)(ve.Ay,{children:({height:C,width:se})=>(0,e.jsx)(ye.Y1,{ref:le,itemSize:50,height:C,width:se,itemCount:K.length,children:Se})})]}),(0,e.jsxs)("div",{className:l.column,children:[!m&&!he&&(0,e.jsx)("div",{className:l.selectDashboardPlaceholder,children:(0,e.jsx)("div",{children:"Select a dashboard to get a list of available panels"})}),he&&(0,e.jsx)(me._,{text:"Loading dashboard...",className:l.loadingPlaceholder}),m&&!he&&(0,e.jsx)(ve.Ay,{children:({width:C,height:se})=>(0,e.jsx)(ye.Y1,{itemSize:32,height:se,width:C,itemCount:De.length,children:ge})})]})]}),(0,e.jsxs)(ue.a.ButtonRow,{children:[(0,e.jsx)(k.$n,{type:"button",variant:"secondary",onClick:y,fill:"text",children:"Cancel"}),(0,e.jsx)(k.$n,{type:"button",variant:"primary",disabled:!(m&&P),onClick:()=>{m&&P&&d(m,P)},children:"Confirm"})]})]})};function o(s){if(!s)return[];const a=s.panels.filter(y=>y.type!=="row"),i=s.panels.filter(y=>y.collapsed).flatMap(y=>y.panels??[]);return[...a,...i]}const r=s=>{const a=typeof s.id=="number",i=typeof s.type=="string",d="libraryPanel"in s;return a&&(i||d)},g=s=>{const a=(0,k.my)(s);return{container:(0,n.css)({display:"grid",gridTemplateColumns:"1fr 1fr",gridTemplateRows:"min-content auto",gap:s.spacing(2),flex:1}),column:(0,n.css)({flex:"1 1 auto"}),dashboardTitle:(0,n.css)({height:"22px",fontWeight:s.typography.fontWeightBold}),dashboardFolder:(0,n.css)({height:"20px",fontSize:s.typography.bodySmall.fontSize,color:s.colors.text.secondary,display:"flex",flexDirection:"row",justifyContent:"flex-start",columnGap:s.spacing(1),alignItems:"center"}),rowButton:(0,n.css)(a,{padding:s.spacing(.5),overflow:"hidden",textOverflow:"ellipsis",textAlign:"left",whiteSpace:"nowrap",cursor:"pointer",border:"2px solid transparent","&:disabled":{cursor:"not-allowed",color:s.colors.text.disabled}}),rowButtonTitle:(0,n.css)({textOverflow:"ellipsis",overflow:"hidden"}),rowSelected:(0,n.css)({borderColor:s.colors.primary.border}),rowOdd:(0,n.css)({backgroundColor:s.colors.background.secondary}),panelButton:(0,n.css)({display:"flex",gap:s.spacing(1),justifyContent:"space-between",alignItems:"center"}),loadingPlaceholder:(0,n.css)({height:"100%",display:"flex",justifyContent:"center",alignItems:"center"}),selectDashboardPlaceholder:(0,n.css)({width:"100%",height:"100%",display:"flex",flexDirection:"column",justifyContent:"center",textAlign:"center",fontWeight:s.typography.fontWeightBold}),modal:(0,n.css)({height:"100%"}),modalContent:(0,n.css)({flex:1,display:"flex",flexDirection:"column"}),modalAlert:(0,n.css)({flexGrow:0}),warnIcon:(0,n.css)({fill:s.colors.warning.main})}};var h=t(19338),u=t(271);const M=()=>{const s=(0,F.of)(w),[a,i]=(0,T.A)(!1),{control:d,register:y,watch:l,formState:{errors:m},setValue:W}=(0,E.xW)(),P=l("annotations"),{fields:Y,append:J,remove:_}=(0,E.jz)({control:d,name:"annotations"}),R=P.find(f=>f.key===c.YH.dashboardUID)?.value,b=Number(P.find(f=>f.key===c.YH.panelID)?.value),[B,ee]=(0,p.useState)(void 0),[Z,K]=(0,p.useState)(void 0),{dashboardModel:oe,isFetching:ne}=be(R);(0,p.useEffect)(()=>{if(ne||!oe)return;ee(oe);const I=o(oe).find(X=>X.id===b);K(I)},[b,oe,ne]);const he=(f,I)=>{const X=(0,A.jM)(P,ae=>{const le=ae.find(ge=>ge.key===c.YH.dashboardUID),Se=ae.find(ge=>ge.key===c.YH.panelID);le?le.value=f:ae.push({key:c.YH.dashboardUID,value:f}),Se?Se.value=I.toString():ae.push({key:c.YH.panelID,value:I.toString()})});W("annotations",X),i(!1)},Te=()=>{const f=P.filter(I=>I.key!==c.YH.dashboardUID&&I.key!==c.YH.panelID);W("annotations",f),ee(void 0),K(void 0)},je=()=>{i(!0)};function De(){return(0,e.jsxs)(O.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)($.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(U.x6,{i18nKey:"alerting.annotations.description",children:"Add more context to your alert notifications."})}),(0,e.jsx)(h.G,{contentText:`Annotations add metadata to provide more information on the alert in your alert notification messages.
          For example, add a Summary annotation to tell you which value caused the alert to fire or which server it happened on.
          Annotations can contain a combination of text and template code.`,title:"Annotations"})]})}return(0,e.jsx)(u.P,{stepNo:5,title:(0,U.t)("alerting.annotations.title","Configure notification message"),description:De(),fullWidth:!0,children:(0,e.jsxs)(O.B,{direction:"column",gap:1,children:[Y.map((f,I)=>{const X=P[I]?.key?.toLocaleLowerCase().endsWith("url"),ae=X?S.p:H.f,le=f.key;return(0,e.jsx)("div",{className:s.flexRow,children:(0,e.jsxs)("div",{children:[(0,e.jsx)(N,{annotationField:f,annotations:P,annotation:le,index:I}),R&&b&&f.key===c.YH.dashboardUID&&(0,e.jsx)(Ae,{dashboard:B,panel:Z,dashboardUid:R.toString(),panelId:b.toString(),onEditClick:je,onDeleteClick:Te}),(0,e.jsxs)("div",{className:s.annotationValueContainer,children:[(0,e.jsx)(Q.D,{hidden:f.key===c.YH.dashboardUID||f.key===c.YH.panelID,className:(0,n.cx)(s.flexRowItemMargin,s.field),invalid:!!m.annotations?.[I]?.value?.message,error:m.annotations?.[I]?.value?.message,children:(0,e.jsx)(ae,{"data-testid":`annotation-value-${I}`,className:(0,n.cx)(s.annotationValueInput,{[s.textarea]:!X}),...y(`annotations.${I}.value`),placeholder:X?"https://":f.key&&`Enter a ${f.key}...`||"Enter custom annotation content...",defaultValue:f.value})}),!c.J3[le]&&(0,e.jsx)(k.$n,{type:"button",className:s.deleteAnnotationButton,"aria-label":"delete annotation",icon:"trash-alt",variant:"secondary",onClick:()=>_(I)})]})]})},f.id)}),(0,e.jsx)(O.B,{direction:"row",gap:1,children:(0,e.jsxs)("div",{className:s.addAnnotationsButtonContainer,children:[(0,e.jsx)(k.$n,{icon:"plus",type:"button",variant:"secondary",onClick:()=>{J({key:"",value:""})},children:"Add custom annotation"}),!B&&(0,e.jsx)(k.$n,{type:"button",variant:"secondary",icon:"dashboard",onClick:()=>i(!0),children:"Link dashboard and panel"})]})}),a&&(0,e.jsx)(Re,{isOpen:!0,dashboardUid:R,panelId:b,onChange:he,onDismiss:()=>i(!1)})]})})},w=s=>({annotationValueInput:(0,n.css)({width:"394px"}),textarea:(0,n.css)({height:"76px"}),addAnnotationsButtonContainer:(0,n.css)({marginTop:s.spacing(1),gap:s.spacing(1),display:"flex"}),field:(0,n.css)({marginBottom:s.spacing(.5)}),flexRow:(0,n.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start"}),flexRowItemMargin:(0,n.css)({marginTop:s.spacing(1)}),deleteAnnotationButton:(0,n.css)({display:"inline-block",marginTop:"10px",marginLeft:"10px"}),annotationTitle:(0,n.css)({color:s.colors.text.primary,marginBottom:"3px"}),annotationContainer:(0,n.css)({marginTop:"5px"}),annotationDescription:(0,n.css)({color:s.colors.text.secondary}),annotationValueContainer:(0,n.css)({display:"flex"})}),z=M},19338:(fe,q,t)=>{t.d(q,{G:()=>O});var e=t(74848),n=t(32196),A=t(40845),p=t(60782),E=t(67061),T=t(14578),F=t(94753);function O({contentText:S,externalLink:H,linkText:Q,title:k="Need help?"}){const U=(0,A.of)($);return(0,e.jsx)(p.G,{content:(0,e.jsx)("div",{className:U.mutedText,children:S}),title:(0,e.jsxs)(E.B,{gap:.5,direction:"row",alignItems:"center",children:[(0,e.jsx)(T.I,{name:"question-circle"}),k]}),footer:H?(0,e.jsx)("a",{href:H,target:"_blank",rel:"noreferrer",children:(0,e.jsx)(E.B,{direction:"row",gap:.5,alignItems:"center",children:(0,e.jsxs)(F.E,{color:"link",children:[Q," ",(0,e.jsx)(T.I,{size:"sm",name:"external-link-alt"})]})})}):void 0,closeButton:!0,placement:"bottom-start",children:(0,e.jsx)("div",{className:U.helpInfo,children:(0,e.jsxs)(E.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(T.I,{name:"question-circle",size:"sm"}),(0,e.jsx)(F.E,{variant:"bodySmall",color:"primary",children:"Need help?"})]})})})}const $=S=>({mutedText:(0,n.css)({color:S.colors.text.secondary,fontSize:S.typography.size.sm}),helpInfo:(0,n.css)({cursor:"pointer",textDecoration:"underline"})})},271:(fe,q,t)=>{t.d(q,{P:()=>O});var e=t(74848),n=t(32196),A=t(40845),p=t(84167),E=t(67061),T=t(94753),F=t(15292);const O=({title:S,stepNo:H,children:Q,fullWidth:k=!1,description:U,switchMode:c})=>{const x=(0,A.of)($);return(0,e.jsx)("div",{className:x.parent,children:(0,e.jsx)(p.n,{className:(0,n.cx)(k&&x.fullWidth),label:(0,e.jsxs)(E.B,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[(0,e.jsxs)(T.E,{variant:"h3",children:[H,". ",S]}),c&&(0,e.jsx)(T.E,{variant:"bodySmall",children:(0,e.jsx)(F.K,{id:"query-and-expressions-advanced-options",value:c.isAdvancedMode,onChange:v=>{c.setAdvancedMode(v.currentTarget.checked)},label:"Advanced options",showLabel:!0,transparent:!0,className:x.reverse})})]}),children:(0,e.jsxs)(E.B,{direction:"column",children:[U&&(0,e.jsx)("div",{className:x.description,children:U}),Q]})})})},$=S=>({parent:(0,n.css)({display:"flex",flexDirection:"row",border:`solid 1px ${S.colors.border.weak}`,borderRadius:S.shape.radius.default,padding:`${S.spacing(2)} ${S.spacing(3)}`}),description:(0,n.css)({marginTop:`-${S.spacing(2)}`}),fullWidth:(0,n.css)({width:"100%"}),reverse:(0,n.css)({flexDirection:"row-reverse",gap:S.spacing(1)})})},97171:(fe,q,t)=>{t.d(q,{DI:()=>me,C1:()=>Pe,Ay:()=>Re});var e=t(74848),n=t(32196),A=t(96540),p=t(49785),E=t(40845),T=t(67061),F=t(94753),O=t(68402),$=t(55852),S=t(39558),H=t(88575),Q=t(76892),k=t(10354),U=t(99494),c=t(49962);const x=c.H.injectEndpoints({endpoints:o=>({getLabels:o.query({query:()=>({url:`/api/plugins/${U.W.Labels}/resources/v1/labels/keys`}),providesTags:["GrafanaLabels"]}),getLabelValues:o.query({query:({key:r})=>({url:`/api/plugins/${U.W.Labels}/resources/v1/labels/name/${r}`}),providesTags:["GrafanaLabels"]})})});var v=t(12210),j=t(75214),L=t(2146),N=t(90182);const D=(0,L.c)({ignoreCase:!1});function V(o,r){return D({label:o.label??"",value:o.value??"",data:{}},r)}const ie=(o,r,g)=>{const h=g.some(M=>M.label===o),u=o.trim().length;return!h&&!!u},ce=(0,A.forwardRef)(function({onChange:r,options:g,defaultValue:h,type:u,onOpenMenu:M=()=>{}},w){const z=(0,E.of)(Ae);return(0,e.jsx)("div",{ref:w,children:(0,e.jsx)(H.D,{disabled:!1,"data-testid":`alertlabel-${u}-picker`,className:z.resetMargin,children:(0,e.jsx)(N.l6,{placeholder:`Choose ${u}`,width:29,className:"ds-picker select-container",backspaceRemovesValue:!1,onChange:r,onOpenMenu:M,filterOption:V,isValidNewOption:ie,options:g,maxMenuHeight:500,noOptionsMessage:"No labels found",defaultValue:h,allowCustomValue:!0})})})}),Ae=()=>({resetMargin:(0,n.css)({marginBottom:0})}),xe=ce;var Ee=t(69087),ve=t(19338),ye=t(40111);function de({remove:o,index:r}){return(0,e.jsx)($.$n,{"aria-label":"delete label",icon:"trash-alt","data-testid":`delete-label-${r}`,variant:"secondary",onClick:()=>{o(r)}})}function ue({append:o}){return(0,e.jsx)($.$n,{icon:"plus",type:"button",variant:"secondary",onClick:o,children:"Add more"})}const Le=o=>{const{currentData:r,isLoading:g}=x.endpoints.getLabels.useQuery(void 0,{skip:o});return{loading:g,labelsOpsKeys:r}};function te(o=[],r){const g=new Set(r?r.map(h=>h.key):[]);return Array.from(o,h=>({label:h,value:h,isDisabled:g.has(h)}))}const me=({labels:o})=>{const r=o.reduce((g,h)=>(h.key&&(g[h.key]=h.value),g),{});return(0,e.jsx)(Ee.m,{labels:r})};function Pe({dataSourceName:o,onClose:r,initialLabels:g}){const h=(0,E.of)(pe),u=s=>{r(s.labelsInSubform)},M=()=>{r()},w=(0,A.useMemo)(()=>({labelsInSubform:g}),[g]),z=(0,p.mN)({defaultValues:w});return(0,e.jsx)(p.Op,{...z,children:(0,e.jsx)("form",{onSubmit:z.handleSubmit(u),children:(0,e.jsxs)(T.B,{direction:"column",gap:4,children:[(0,e.jsx)(F.E,{children:"Add labels to your rule for searching, silencing, or routing to a notification policy."}),(0,e.jsxs)(T.B,{direction:"column",gap:1,children:[(0,e.jsx)(Ne,{dataSourceName:o}),(0,e.jsx)(O.$,{v:2}),(0,e.jsx)(me,{labels:z.watch("labelsInSubform")}),(0,e.jsx)(O.$,{v:1}),(0,e.jsxs)("div",{className:h.confirmButton,children:[(0,e.jsx)($.$n,{type:"button",variant:"secondary",onClick:M,children:"Cancel"}),(0,e.jsx)($.$n,{type:"submit",children:"Save"})]})]})]})})})}const re=o=>!(0,j.F2)(o);function Be(o,r,g,h,u){const{isLoading:M,labels:w}=(0,ye.V)(o),{loading:z,labelsOpsKeys:s=[]}=Le(!r||g),a=(0,A.useMemo)(()=>s.reduce((B,ee)=>(B[ee.name]=new Set,B),{}),[s]),i=(0,A.useMemo)(()=>te(Object.keys(a).filter(re),h),[a,h]),d=(0,A.useMemo)(()=>te(Array.from(w.keys()).filter(re),h),[w,h]),y=[{label:"From alerts",options:d,expanded:!0},{label:"From system",options:i,expanded:!0}],l=w.has(u),m=a[u]!==void 0&&a[u]?.size>0,W=!l&&!m,P=!l&&a[u]?.size>0,{currentData:Y,isLoading:J=!1,error:_}=x.endpoints.getLabelValues.useQuery({key:u},{skip:!r||!u||l||P||W}),R=(0,A.useMemo)(()=>{if(l)return[];const B=a[u];if(B?.size>0)return te(B);if(!J&&Y?.values?.length&&!_){const Z=Y?.values.map(K=>K.name);return a[u]=new Set(Z),te(Z)}return[]},[l,a,u,J,Y,_]),b=(0,A.useCallback)(B=>re(B)?l||!r?te(w.get(B)):R:[],[w,r,R,l]);return{loading:M||z,keysFromExistingAlerts:d,groupedOptions:y,getValuesForLabel:b}}function Ne({dataSourceName:o}){const r=(0,E.of)(pe),{control:g,watch:h,formState:{errors:u}}=(0,p.xW)(),M=h("labelsInSubform"),{fields:w,remove:z,append:s}=(0,p.jz)({control:g,name:"labelsInSubform"}),a=(0,A.useCallback)(()=>{s({key:"",value:""})},[s]),{installed:i=!1,loading:d}=(0,v._)(U.W.Labels),[y,l]=(0,A.useState)(""),{loading:m,keysFromExistingAlerts:W,groupedOptions:P,getValuesForLabel:Y}=Be(o,i,d,M,y),J=(0,A.useMemo)(()=>Y(y),[y,Y]),_=m||d;return(0,e.jsxs)(e.Fragment,{children:[_&&(0,e.jsx)(S._,{text:"Loading existing labels"}),!_&&(0,e.jsxs)(T.B,{direction:"column",gap:1,alignItems:"flex-start",children:[w.map((R,b)=>(0,e.jsxs)("div",{className:(0,n.cx)(r.flexRow,r.centerAlignRow),children:[(0,e.jsx)(H.D,{className:r.labelInput,invalid:!!u.labelsInSubform?.[b]?.key?.message,error:u.labelsInSubform?.[b]?.key?.message,"data-testid":`labelsInSubform-key-${b}`,children:(0,e.jsx)(p.xI,{name:`labelsInSubform.${b}.key`,control:g,rules:{required:M[b]?.value?"Required.":!1},render:({field:{onChange:B,ref:ee,...Z}})=>(0,e.jsx)(xe,{...Z,defaultValue:R.key?{label:R.key,value:R.key}:void 0,options:i?P:W,onChange:K=>{B(K.value),l(K.value)},type:"key"})})}),(0,e.jsx)(Q.c,{className:r.equalSign,children:"="}),(0,e.jsx)(H.D,{className:r.labelInput,invalid:!!u.labelsInSubform?.[b]?.value?.message,error:u.labelsInSubform?.[b]?.value?.message,"data-testid":`labelsInSubform-value-${b}`,children:(0,e.jsx)(p.xI,{control:g,name:`labelsInSubform.${b}.value`,rules:{required:M[b]?.value?"Required.":!1},render:({field:{onChange:B,ref:ee,...Z}})=>(0,e.jsx)(xe,{...Z,defaultValue:R.value?{label:R.value,value:R.value}:void 0,options:J,onChange:K=>{B(K.value)},onOpenMenu:()=>{l(M[b].key)},type:"value"})})}),(0,e.jsx)(de,{index:b,remove:z})]},R.id)),(0,e.jsx)(ue,{append:a})]})]})}const Me=()=>{const o=(0,E.of)(pe),{register:r,control:g,watch:h,formState:{errors:u}}=(0,p.xW)(),M=h("labels"),{fields:w,remove:z,append:s}=(0,p.jz)({control:g,name:"labels"}),a=(0,A.useCallback)(()=>{s({key:"",value:""})},[s]);return(0,e.jsxs)(e.Fragment,{children:[w.map((i,d)=>(0,e.jsx)("div",{children:(0,e.jsxs)("div",{className:(0,n.cx)(o.flexRow,o.centerAlignRow),"data-testid":"alertlabel-input-wrapper",children:[(0,e.jsx)(H.D,{className:o.labelInput,invalid:!!u.labels?.[d]?.key?.message,error:u.labels?.[d]?.key?.message,children:(0,e.jsx)(k.p,{...r(`labels.${d}.key`,{required:{value:!!M[d]?.value,message:"Required."}}),placeholder:"key","data-testid":`label-key-${d}`,defaultValue:i.key})}),(0,e.jsx)(Q.c,{className:o.equalSign,children:"="}),(0,e.jsx)(H.D,{className:o.labelInput,invalid:!!u.labels?.[d]?.value?.message,error:u.labels?.[d]?.value?.message,children:(0,e.jsx)(k.p,{...r(`labels.${d}.value`,{required:{value:!!M[d]?.key,message:"Required."}}),placeholder:"value","data-testid":`label-value-${d}`,defaultValue:i.value})}),(0,e.jsx)(de,{index:d,remove:z})]})},i.id)),(0,e.jsx)(ue,{append:a})]})};function be(){return(0,e.jsxs)("div",{children:[(0,e.jsxs)(T.B,{direction:"column",gap:1,children:[(0,e.jsx)(F.E,{element:"h5",children:"Labels"}),(0,e.jsxs)(T.B,{direction:"row",gap:1,children:[(0,e.jsx)(F.E,{variant:"bodySmall",color:"secondary",children:"Add labels to your rule for searching, silencing, or routing to a notification policy."}),(0,e.jsx)(ve.G,{contentText:`The dropdown only displays labels that you have previously used for alerts.
            Select a label from the options below or type in a new one.`,title:"Labels"})]})]}),(0,e.jsx)(Me,{})]})}const pe=o=>({flexColumn:(0,n.css)({display:"flex",flexDirection:"column"}),flexRow:(0,n.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start"}),centerAlignRow:(0,n.css)({alignItems:"center",gap:o.spacing(.5)}),equalSign:(0,n.css)({alignSelf:"flex-start",width:"28px",justifyContent:"center",margin:0}),labelInput:(0,n.css)({width:"175px",margin:0}),confirmButton:(0,n.css)({display:"flex",flexDirection:"row",gap:o.spacing(1),marginLeft:"auto"})}),Re=be},40111:(fe,q,t)=>{t.d(q,{V:()=>S});var e=t(96540),n=t(79938),A=t(77583),p=t(24608);const{usePrometheusRuleNamespacesQuery:E,useLazyRulerRulesQuery:T}=n.hK,{useDiscoverDsFeaturesQuery:F}=A.L,O=(0,p.w)(),$={};function S(c){const{data:x,isLoading:v}=F({rulesSourceName:c}),[j,{data:L=$,isLoading:N}]=T(),{data:D=[],isLoading:V}=E({ruleSourceName:c},{skip:!O});(0,e.useEffect)(()=>{x?.rulerConfig&&!O&&j({rulerConfig:x.rulerConfig})},[x?.rulerConfig,j]);const ie=(0,e.useMemo)(()=>V||N?new Map:O?H(D):Q(L),[D,L,V,N]),ce=(0,e.useMemo)(()=>V||N?new Map:O?k(D):U(L),[D,L,V,N]);return{namespaceGroups:ie,labels:ce,isLoading:V||N||v}}function H(c){const x=new Map;return c.forEach(v=>{x.set(v.name,v.groups.map(j=>j.name))}),x}function Q(c){const x=new Map;return Object.entries(c).forEach(([v,j])=>{x.set(v,j.map(L=>L.name))}),x}function k(c){return c.flatMap(v=>v.groups).flatMap(v=>v.rules).reduce((v,j)=>(j.labels&&Object.entries(j.labels).forEach(([L,N])=>{if(!L||!N)return;const D=v.get(L);D?D.add(N):v.set(L,new Set([N]))}),v),new Map)}function U(c){const x=new Map;return Object.entries(c).flatMap(([j,L])=>L).flatMap(j=>j.rules).reduce((j,L)=>(L.labels&&Object.entries(L.labels).forEach(([N,D])=>{if(!N||!D)return;const V=j.get(N);V?V.add(D):j.set(N,new Set([D]))}),j),x)}}}]);

//# sourceMappingURL=8373.339eead3db7b47f15946.js.map