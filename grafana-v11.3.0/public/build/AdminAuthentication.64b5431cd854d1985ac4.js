"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5592],{51332:(ie,S,n)=>{n.r(S),n.d(S,{AuthConfigPageUnconnected:()=>pe,default:()=>V});var e=n(74848),f=n(96540),R=n(71468),g=n(61268),Q=n(14110),X=n(72109),se=n(27746),ye=n(71259),q=n(21780),W=n(2913),C=n(32196),_=n(40845),k=n(87978),j=n(94753),oe=n(15292),re=n(55852),T=n(3169),H=n(60610);const ve=o=>({allowInsecureEmail:o.authConfig.settings?.auth?.oauth_allow_insecure_email_lookup.toLowerCase()==="true"}),be={loadSettings:H.M5,saveSettings:H.DZ},xe=(0,R.connect)(ve,be)(({allowInsecureEmail:o,loadSettings:v,onClose:I,saveSettings:y})=>{const P=(0,T._2)(),O=async()=>{try{await y({updates:{auth:{oauth_allow_insecure_email_lookup:""+!o}}}),await v(!1),P.success("Settings saved")}catch{P.error("Failed to save settings")}},z=async()=>{try{await y({removals:{auth:["oauth_allow_insecure_email_lookup"]}}),await v(!1),P.success("Settings saved")}catch{P.error("Failed to save settings")}},L=(0,e.jsxs)(e.Fragment,{children:["Configure auth settings. Find out more in our"," ",(0,e.jsx)(X.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication/#settings",children:"documentation"}),"."]}),Y=(0,_.of)(Ae);return(0,e.jsxs)(k._,{title:"Auth Settings",subtitle:L,size:"md",onClose:I,children:[(0,e.jsxs)("div",{className:Y.advancedAuth,children:[(0,e.jsx)(j.E,{variant:"h4",children:"Advanced Auth"}),(0,e.jsx)(j.E,{variant:"h5",children:"Enable insecure email lookup"}),(0,e.jsx)(j.E,{variant:"body",color:"secondary",children:"Allow users to use the same email address to log into Grafana with different identity providers."}),(0,e.jsx)(oe.d,{value:o,onChange:O})]}),(0,e.jsx)(re.$n,{size:"md",variant:"secondary",className:Y.button,onClick:z,tooltip:"This action will disregard any saved changes and load the configuration from the configuration file.",children:"Reset"})]})}),Ae=o=>({advancedAuth:(0,C.css)({display:"flex",flexDirection:"column",gap:o.spacing(1)}),button:(0,C.css)({marginTop:o.spacing(2)})});var Se=n(67061),le=n(14578);const Ce=()=>{const o=(0,_.of)(de);return(0,e.jsxs)("div",{className:o.container,children:[(0,e.jsxs)(Se.B,{gap:1,alignItems:"center",children:[(0,e.jsx)(le.I,{name:"cog"}),(0,e.jsx)(j.E,{children:"Configuration required"})]}),(0,e.jsx)(j.E,{variant:"bodySmall",color:"secondary",children:"You have no authentication configuration created at the moment."}),(0,e.jsx)(X.Y,{href:"https://grafana.com/docs/grafana/latest/auth/overview/",external:!0,children:"Refer to the documentation on how to configure authentication"})]})},de=o=>({container:(0,C.css)({display:"flex",flexDirection:"column",gap:o.spacing(2),backgroundColor:o.colors.background.secondary,borderRadius:o.shape.radius.default,padding:o.spacing(3),width:"max-content",margin:o.spacing(3,"auto")})}),Ie=Ce;var je=n(8887),N=n(10860),ue=n(39938),ee=n(7250),ce=n(5328);function he({providerId:o,enabled:v,configPath:I,authType:y,onClick:P}){const O=(0,ce.h)({configPath:I,id:o}),[z,L]=ee.L[o]||["lock",o.toUpperCase()];return(0,e.jsxs)(N.Z,{href:O,onClick:P,children:[(0,e.jsx)(N.Z.Heading,{children:L}),(0,e.jsx)(N.Z.Meta,{children:y}),(0,je.n6)(z)&&(0,e.jsx)(N.Z.Figure,{children:(0,e.jsx)(le.I,{name:z,size:"xxxl"})}),(0,e.jsx)(N.Z.Actions,{children:(0,e.jsx)(ue.E,{text:v?"Enabled":"Not enabled",color:v?"green":"blue"})})]})}var J=n(73399);function fe(o){const{isLoading:v,providerStatuses:I,providers:y}=o.authConfig;return{isLoading:v,providerStatuses:I,providers:y}}const M={loadSettings:H.M5},Pe=(0,R.connect)(fe,M),pe=({providerStatuses:o,isLoading:v,loadSettings:I,providers:y})=>{(0,f.useEffect)(()=>{I()},[I]);const[P,O]=(0,f.useState)(!1),L=(0,J.getRegisteredAuthProviders)().filter(u=>!o[u.id]?.hide),Y=(u,U)=>{(0,Q.rR)("authentication_ui_provider_clicked",{provider:u,enabled:U})};y=y.filter(u=>u.provider!=="saml"),y=y.map(u=>u.provider==="ldap"?{...u,settings:{...u.settings,type:"LDAP"}}:u);const K=L.length?[...L.map(u=>({provider:u.id,settings:{...o[u.id],configPath:u.configPath,type:u.type}})),...y]:y;return(0,e.jsx)(q.YW,{navId:"authentication",subTitle:(0,e.jsxs)(e.Fragment,{children:["Manage your auth settings and configure single sign-on. Find out more in our"," ",(0,e.jsx)(X.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication",children:"documentation"}),"."]}),actions:W.$W.buildInfo.edition!==g.r.OpenSource&&(0,e.jsx)(se.I,{icon:"cog",variant:"canvas",onClick:()=>O(!0),children:"Auth settings"}),children:(0,e.jsx)(q.YW.Contents,{isLoading:v,children:K.length?(0,e.jsxs)(ye.x,{gap:3,minColumnWidth:34,children:[K.filter(({provider:u})=>!["grafana_com"].includes(u)).map(({provider:u,settings:U})=>(0,e.jsx)(he,{authType:U.type||"OAuth",providerId:u,enabled:U.enabled,onClick:()=>Y(u,U.enabled),configPath:U.configPath},u)),P&&(0,e.jsx)(xe,{onClose:()=>O(!1)})]}):(0,e.jsx)(Ie,{})})})},V=Pe(pe)},71703:(ie,S,n)=>{n.r(S),n.d(S,{ProviderConfigPage:()=>Le,default:()=>Ne});var e=n(74848),f=n(96540),R=n(54148),g=n(67061),Q=n(94753),X=n(39938),se=n(21780),ye=n(64915),q=n(31678),W=n(49785),C=n(26272),_=n(3591),k=n(17172),j=n(14110),oe=n(39601),re=n(38138),T=n(88575),H=n(15292),ve=n(57418),be=n(90613),F=n(55852),Re=n(83122),xe=n(29158),Ae=n(96374),Se=n(35339),le=n(32196),Ce=n(40845),de=n(10354),Ie=n(9226),je=n(90182),N=n(10880),ue=n(8227),ee=n(32264),ce=n(72109),he=n(10096),J=n(8484),fe=n(37390),M=n(5328);const Pe=({isOpen:a,onClose:t,onSuccess:s,isLoading:i})=>{const{handleSubmit:d,register:h,formState:{errors:l}}=(0,W.mN)({mode:"onBlur",defaultValues:{url:""}}),p=b=>b===""?"Please enter the .well-known/openid-configuration endpoint for your IdP":(0,M.K)(b)?!0:"Please enter a valid URL";return(0,e.jsx)(fe.a,{title:"OpenID Connect Discovery URL",onDismiss:t,onClickBackdrop:t,isOpen:a,children:(0,e.jsxs)("form",{onSubmit:b=>(b.stopPropagation(),d(s)(b)),children:[(0,e.jsx)(T.D,{label:"The .well-known/openid-configuration endpoint for your IdP",invalid:!!l.url,error:l.url?.message,htmlFor:"url",children:(0,e.jsx)(de.p,{...h("url",{validate:p}),width:80,id:"url"})}),(0,e.jsxs)(fe.a.ButtonRow,{children:[(0,e.jsx)(F.$n,{type:"submit",variant:"primary",disabled:i,children:i?(0,e.jsx)(J.x6,{i18nKey:"oauth.form.server-discovery-modal-loading",children:"Loading..."}):(0,e.jsx)(J.x6,{i18nKey:"oauth.form.server-discovery-modal-submit",children:"Submit"})}),(0,e.jsx)(F.$n,{type:"button",variant:"secondary",onClick:t,children:(0,e.jsx)(J.x6,{i18nKey:"oauth.form.server-discovery-modal-close",children:"Close"})})]})]})})},pe=({setValue:a})=>{const t=(0,_.J7)(),[s,i]=(0,f.useState)(!1),[d,h]=(0,f.useState)(!1),l=()=>i(!1),p=async b=>{h(!0);try{const B="/.well-known/openid-configuration",Z=new URL(b.url);Z.pathname.includes(B)||(b.url=Z.origin+B);const x=await(0,k.AI)().get(b.url);if(!x.token_endpoint||!x.authorization_endpoint){t.publish({type:C.r1.alertWarning.name,payload:["The URL provided is not a valid .well-known/openid-configuration endpoint"]});return}a("tokenUrl",x.token_endpoint),a("authUrl",x.authorization_endpoint),x.userinfo_endpoint&&a("apiUrl",x.userinfo_endpoint),t.publish({type:C.r1.alertSuccess.name,payload:["OpenID Connect Discovery URL has been successfully fetched."]})}catch{t.publish({type:C.r1.alertWarning.name,payload:["Failed to fetch URL or invalid content"]})}finally{l(),h(!1)}};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(F.$n,{type:"button",variant:"secondary",onClick:()=>{i(!0)},children:(0,e.jsx)(J.x6,{i18nKey:"oauth.form.server-discovery-action-button",children:"Enter OpenID Connect Discovery URL"})}),(0,e.jsx)(Pe,{isOpen:s,onClose:l,onSuccess:p,isLoading:d})]})};function V(a){return Array.isArray(a)&&a.every(t=>typeof t=="object"&&t!==null&&"value"in t)}const o={azuread:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","authUrl","tokenUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","allowedGroups","forceUseGraphApi","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],generic_oauth:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","authStyle","scopes","serverDiscoveryUrl","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["nameAttributePath","loginAttributePath","emailAttributeName","emailAttributePath","idTokenAttributeName","roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","defineAllowedGroups",{name:"allowedGroups",dependsOn:"defineAllowedGroups"},{name:"groupsAttributePath",dependsOn:"defineAllowedGroups"},"defineAllowedTeamsIds",{name:"teamIds",dependsOn:"defineAllowedTeamsIds"},{name:"teamsUrl",dependsOn:"defineAllowedTeamsIds"},{name:"teamIdsAttributePath",dependsOn:"defineAllowedTeamsIds"},"usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],google:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["validateHd","hostedDomain","allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],github:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","teamIds","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],gitlab:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],okta:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}]};function v(a){return{clientId:{label:"Client Id",type:"text",description:"The client Id of your OAuth2 app.",validation:{required:!0,message:"This field is required"}},clientSecret:{label:"Client secret",type:"secret",description:"The client secret of your OAuth2 app."},allowedOrganizations:{label:"Allowed organizations",type:"select",description:`List of comma- or space-separated organizations. The user should be a member 
of at least one organization to log in.`,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter organizations (my-team, myteam...) and press Enter to add"},allowedDomains:{label:"Allowed domains",type:"select",description:`List of comma- or space-separated domains. The user should belong to at least 
one domain to log in.`,multi:!0,allowCustomValue:!0,options:[]},authUrl:{label:"Auth URL",type:"text",description:"The authorization endpoint of your OAuth2 provider.",validation:{required:!0,validate:t=>(0,M.K)(t),message:"This field is required and must be a valid URL."}},authStyle:{label:"Auth style",type:"select",description:"It determines how client_id and client_secret are sent to Oauth2 provider. Default is AutoDetect.",multi:!1,options:[{value:"AutoDetect",label:"AutoDetect"},{value:"InParams",label:"InParams"},{value:"InHeader",label:"InHeader"}],defaultValue:{value:"AutoDetect",label:"AutoDetect"}},tokenUrl:{label:"Token URL",type:"text",description:"The token endpoint of your OAuth2 provider.",validation:{required:!0,validate:t=>(0,M.K)(t),message:"This field is required and must be a valid URL."}},scopes:{label:"Scopes",type:"select",description:"List of comma- or space-separated OAuth2 scopes.",multi:!0,allowCustomValue:!0,options:[]},allowedGroups:{label:"Allowed groups",type:"select",description:(0,e.jsxs)(e.Fragment,{children:["List of comma- or space-separated groups. The user should be a member of at least one group to log in."," ",a==="generic_oauth"&&"If you configure allowed_groups, you must also configure groups_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],validation:a==="azuread"?{validate:t=>typeof t=="string"?(0,ue.A)(t):V(t)?t.every(s=>s?.value&&(0,ue.A)(s.value)):!0,message:"Allowed groups must be Object Ids."}:void 0},apiUrl:{label:"API URL",type:"text",description:(0,e.jsxs)(e.Fragment,{children:["The user information endpoint of your OAuth2 provider. Information returned by this endpoint must be compatible with"," ",(0,e.jsx)(ce.Y,{href:"https://connect2id.com/products/server/docs/api/userinfo",external:!0,variant:"bodySmall",children:"OpenID UserInfo"}),"."]}),validation:{required:!1,validate:t=>typeof t!="string"?!1:t.length?(0,M.K)(t):!0,message:"This field must be a valid URL if set."}},roleAttributePath:{label:"Role attribute path",description:"JMESPath expression to use for Grafana role lookup.",type:"text",validation:{required:!1}},name:{label:"Display name",description:'Will be displayed on the login page as "Sign in with ...". Helpful if you use more than one identity providers or SSO protocols.',type:"text"},allowSignUp:{label:"Allow sign up",description:"If not enabled, only existing Grafana users can log in using OAuth.",type:"switch"},autoLogin:{label:"Auto login",description:"Log in automatically, skipping the login screen.",type:"switch"},signoutRedirectUrl:{label:"Sign out redirect URL",description:"The URL to redirect the user to after signing out from Grafana.",type:"text",validation:{required:!1}},emailAttributeName:{label:"Email attribute name",description:"Name of the key to use for user email lookup within the attributes map of OAuth2 ID token.",type:"text"},emailAttributePath:{label:"Email attribute path",description:"JMESPath expression to use for user email lookup from the user information.",type:"text"},nameAttributePath:{label:"Name attribute path",description:`JMESPath expression to use for user name lookup from the user ID token. 
This name will be used as the user\u2019s display name.`,type:"text"},loginAttributePath:{label:"Login attribute path",description:"JMESPath expression to use for user login lookup from the user ID token.",type:"text"},idTokenAttributeName:{label:"ID token attribute name",description:"The name of the key used to extract the ID token from the returned OAuth2 token.",type:"text"},roleAttributeStrict:{label:"Role attribute strict mode",description:"If enabled, denies user login if the Grafana role cannot be extracted using Role attribute path.",type:"switch"},allowAssignGrafanaAdmin:{label:"Allow assign Grafana admin",description:"If enabled, it will automatically sync the Grafana server administrator role.",type:"switch",hidden:!he.TP.isGrafanaAdmin},skipOrgRoleSync:{label:"Skip organization role sync",description:"Prevent synchronizing users\u2019 organization roles from your IdP.",type:"switch"},orgMapping:{label:"Organization mapping",description:y(a),type:"select",hidden:!he.TP.isGrafanaAdmin,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter mappings (my-team:1:Viewer...) and press Enter to add"},orgAttributePath:{label:"Organization attribute path",description:"JMESPath expression to use for organization lookup.",type:"text",hidden:!["generic_oauth","okta"].includes(a)},defineAllowedGroups:{label:"Define allowed groups",type:"switch"},defineAllowedTeamsIds:{label:"Define allowed teams ids",type:"switch"},forceUseGraphApi:{label:"Force use Graph API",description:"If enabled, Grafana will fetch the users' groups using the Microsoft Graph API.",type:"checkbox"},usePkce:{label:"Use PKCE",description:(0,e.jsxs)(e.Fragment,{children:["If enabled, Grafana will use"," ",(0,e.jsx)(ce.Y,{external:!0,variant:"bodySmall",href:"https://datatracker.ietf.org/doc/html/rfc7636",children:"Proof Key for Code Exchange (PKCE)"})," ","with the OAuth2 Authorization Code Grant."]}),type:"checkbox"},useRefreshToken:{label:"Use refresh token",description:"If enabled, Grafana will fetch a new access token using the refresh token provided by the OAuth2 provider.",type:"checkbox"},tlsClientCa:{label:"TLS client ca",description:"The file path to the trusted certificate authority list. Is not applicable on Grafana Cloud.",type:"text",hidden:!ee.$.localFileSystemAvailable},tlsClientCert:{label:"TLS client cert",description:"The file path to the certificate. Is not applicable on Grafana Cloud.",type:"text",hidden:!ee.$.localFileSystemAvailable},tlsClientKey:{label:"TLS client key",description:"The file path to the key. Is not applicable on Grafana Cloud.",type:"text",hidden:!ee.$.localFileSystemAvailable},tlsSkipVerifyInsecure:{label:"TLS skip verify",description:`If enabled, the client accepts any certificate presented by the server and any host 
name in that certificate. You should only use this for testing, because this mode leaves 
SSL/TLS susceptible to man-in-the-middle attacks.`,type:"switch"},groupsAttributePath:{label:"Groups attribute path",description:`JMESPath expression to use for user group lookup. If you configure allowed_groups, 
you must also configure groups_attribute_path.`,type:"text"},teamsUrl:{label:"Teams URL",description:(0,e.jsxs)(e.Fragment,{children:["The URL used to query for Team Ids. If not set, the default value is /teams."," ",a==="generic_oauth"&&"If you configure teams_url, you must also configure team_ids_attribute_path."]}),type:"text",validation:{validate:(t,s)=>{let i=!0;return s.teamIds.length&&(i=!!t),typeof t=="string"&&t.length&&(i=(0,M.K)(t)),i},message:"This field must be set if Team Ids are configured and must be a valid URL."}},teamIdsAttributePath:{label:"Team Ids attribute path",description:"The JMESPath expression to use for Grafana Team Id lookup within the results returned by the teams_url endpoint.",type:"text",validation:{validate:(t,s)=>s.teamIds.length?!!t:!0,message:"This field must be set if Team Ids are configured."}},teamIds:{label:"Team Ids",type:"select",description:(0,e.jsxs)(e.Fragment,{children:[a==="github"?"Integer":"String"," list of Team Ids. If set, the user must be a member of one of the given teams to log in."," ",a==="generic_oauth"&&"If you configure team_ids, you must also configure teams_url and team_ids_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter Team Ids and press Enter to add",validation:a==="github"?{validate:t=>typeof t=="string"?I(t):V(t)?t.every(s=>s?.value&&I(s.value)):!0,message:"Team Ids must be numbers."}:void 0},hostedDomain:{label:"Hosted domain",description:"The domain under which Grafana is hosted and accessible.",type:"text"},validateHd:{label:"Validate hosted domain",description:"If enabled, Grafana will match the Hosted Domain retrieved from the Google ID Token against the Allowed Domains list specified by the user.",type:"checkbox"},serverDiscoveryUrl:{label:"OpenID Connect Discovery URL",description:"The .well-known/openid-configuration endpoint for your IdP. The info extracted from this URL will be used to populate the Auth URL, Token URL and API URL fields.",type:"custom",content:t=>(0,e.jsx)(pe,{setValue:t})}}}function I(a){return/^-?\d+$/.test(a)}function y(a){switch(a){case"azuread":return'List of "<GroupID>:<OrgIdOrName>:<Role>" mappings.';case"github":return'List of "<GitHubTeamName>:<OrgIdOrName>:<Role>" mappings.';case"gitlab":return'List of "<GitlabGroupName>:<OrgIdOrName>:<Role>';case"google":return'List of "<GoogleGroupName>:<OrgIdOrName>:<Role>';default:return'List of "<ExternalName>:<OrgIdOrName>:<Role>" mappings.'}}const P=({field:a,register:t,errors:s,watch:i,setValue:d,control:h,unregister:l,secretConfigured:p,provider:b})=>{const[B,Z]=(0,f.useState)(p),x=typeof a!="string",r=x?a.name:a,$=x?i(a.dependsOn):null,c=v(b)[r],Te=(0,Ce.$j)();if((0,f.useEffect)(()=>{x&&($||l(r))},[l,r,$,x]),!a)return console.log("missing field:",r),null;if(c.hidden||x&&!i(a.dependsOn))return null;const w={label:c.label,required:!!c.validation?.required,invalid:!!s[r],error:c.validation?.message,description:c.description,defaultValue:c.defaultValue?.value};switch(c.type){case"text":return(0,e.jsx)(T.D,{...w,children:(0,e.jsx)(de.p,{...t(r,c.validation),type:c.type,id:r,autoComplete:"off"})},r);case"secret":return(0,e.jsx)(T.D,{...w,htmlFor:r,children:(0,e.jsx)(W.xI,{name:r,control:h,rules:c.validation,render:({field:{ref:Ue,value:D,...ae}})=>(0,e.jsx)(Ie.L4,{...ae,autoComplete:"off",id:r,value:typeof D=="string"?D:"",isConfigured:B,onReset:()=>{Z(!1),d(r,"")}})})},r);case"select":const te=i(r);let ne=c.options;return c.options?.length||(ne=V(te)?te:[]),(0,e.jsx)(T.D,{...w,htmlFor:r,children:(0,e.jsx)(W.xI,{rules:c.validation,name:r,control:h,render:({field:{ref:Ue,onChange:D,...ae},fieldState:{invalid:we}})=>(0,e.jsx)(je.l6,{...ae,placeholder:c.placeholder,isMulti:c.multi,invalid:we,inputId:r,options:ne,allowCustomValue:!!c.allowCustomValue,defaultValue:c.defaultValue,onChange:D,onCreateOption:ge=>{const G={value:ge,label:ge};D([...ne||[],G])}})})},r);case"switch":return(0,e.jsx)(T.D,{...w,children:(0,e.jsx)(H.d,{...t(r),id:r})},r);case"checkbox":return(0,e.jsx)(N.S,{...t(r),id:r,...w,className:(0,le.css)({marginBottom:Te.spacing(2)})},r);case"custom":return(0,e.jsx)(T.D,{...w,children:c.content?c.content(d):(0,e.jsx)(e.Fragment,{})},r);default:return console.error(`Unknown field type: ${c.type}`),null}},O={allowAssignGrafanaAdmin:!1,allowSignUp:!1,allowedDomains:[],allowedGroups:[],allowedOrganizations:[],apiUrl:"",authStyle:"",authUrl:"",autoLogin:!1,clientId:"",clientSecret:"",emailAttributeName:"",emailAttributePath:"",emptyScopes:!1,enabled:!1,extra:{},groupsAttributePath:"",hostedDomain:"",icon:"shield",name:"",roleAttributePath:"",roleAttributeStrict:!1,scopes:[],signoutRedirectUrl:"",skipOrgRoleSync:!1,teamIds:[],teamIdsAttributePath:"",teamsUrl:"",tlsClientCa:"",tlsClientCert:"",tlsClientKey:"",tlsSkipVerify:!1,tokenUrl:"",type:"",usePkce:!1,useRefreshToken:!1},z=a=>a?.length?Array.isArray(a)?a.map(t=>({label:t,value:t})):a.startsWith("[")&&a.endsWith("]")?JSON.parse(a).map(t=>({label:t,value:t})):a.split(/[\s,]/).map(t=>({label:t,value:t})):[];function L(a){if(!a)return O;const t=K(a.provider),s=U(v(a.provider),t),i={...a.settings};for(const d of s)i[d]=z(i[d]);return i}const Y=a=>a.length<=1?a.map(({value:t})=>t).join(","):JSON.stringify(a.map(({value:t})=>t)),K=a=>{const t=o[a],s=["enabled"];return Object.values(t).reduce((i,d)=>[...i,...d.fields.map(h=>typeof h=="string"?h:h.name)],s)};function u(a,t){let s=a;const i=K(t),d=U(v(t),i),h=Object.keys(s).filter(l=>i.includes(l)).reduce((l,p)=>({...l,[p]:s[p]}),{});for(const l of d){const p=s[l];p&&(V(p)?h[l]=Y(p):V([p])&&(h[l]=p.value))}return h}function U(a,t){return Object.entries(a).filter(([s,i])=>t.includes(s)&&i.type==="select").map(([s])=>s)}const me=(0,_.J7)(),Ee=({config:a,provider:t,isLoading:s})=>{const{register:i,handleSubmit:d,control:h,reset:l,watch:p,setValue:b,unregister:B,formState:{errors:Z,dirtyFields:x,isSubmitted:r}}=(0,W.mN)({defaultValues:L(a),mode:"onSubmit",reValidateMode:"onChange"}),[$,c]=(0,f.useState)(!1),[Te,w]=(0,f.useState)(!1),te=r&&!Te,ne=o[t],[Ue,D]=(0,f.useState)(!1),ae=(0,e.jsx)(re.W,{children:(0,e.jsx)(re.W.Item,{label:"Reset to default values",icon:"history-alt",onClick:()=>{D(!0)}})}),we=async m=>{c(!0),w(!1);const E=u(m,t);try{await(0,k.AI)().put(`/api/v1/sso-settings/${t}`,{id:a?.id,provider:a?.provider,settings:{...E}},{showErrorAlert:!1}),(0,j.rR)("grafana_authentication_ssosettings_saved",{provider:t,enabled:E.enabled}),me.publish({type:C.r1.alertSuccess.name,payload:["Settings saved"]}),l(m),setTimeout(()=>{oe.Ny.push("/admin/authentication")},300)}catch(A){let De="";(0,k.NF)(A)?De=A.data.message:A instanceof Error&&(De=A.message),me.publish({type:C.r1.alertError.name,payload:[De]}),w(!0),c(!1)}},ge=async()=>{try{await(0,k.AI)().delete(`/api/v1/sso-settings/${t}`,void 0,{showSuccessAlert:!1}),(0,j.rR)("grafana_authentication_ssosettings_removed",{provider:t}),me.publish({type:C.r1.alertSuccess.name,payload:["Settings reset to defaults"]}),setTimeout(()=>{oe.Ny.push("/admin/authentication")})}catch(m){let E="";(0,k.NF)(m)?E=m.data.message:m instanceof Error&&(E=m.message),me.publish({type:C.r1.alertError.name,payload:[E]})}},G=a?.settings.enabled,Ge=m=>{(0,j.rR)("grafana_authentication_ssosettings_save_attempt",{provider:t,enabled:m?!G:G}),m&&b("enabled",!G)};return(0,e.jsxs)(se.YW.Contents,{isLoading:s,children:[(0,e.jsxs)("form",{onSubmit:d(we),style:{maxWidth:"600px"},children:[(0,e.jsx)(Se.F,{confirmRedirect:!!Object.keys(x).length&&!te,onDiscard:()=>{(0,j.rR)("grafana_authentication_ssosettings_abandoned",{provider:t}),l()}}),(0,e.jsx)(T.D,{label:"Enabled",hidden:!0,children:(0,e.jsx)(H.d,{...i("enabled"),id:"enabled",label:"Enabled"})}),(0,e.jsx)(g.B,{gap:2,direction:"column",children:ne.filter(m=>!m.hidden).map((m,E)=>(0,e.jsx)(ve.M,{label:m.name,isOpen:E===0,children:m.fields.filter(A=>typeof A!="string"?!A.hidden:!0).map(A=>(0,e.jsx)(P,{field:A,control:h,errors:Z,setValue:b,register:i,watch:p,unregister:B,provider:t,secretConfigured:!!a?.settings.clientSecret},typeof A=="string"?A:A.name))},m.name))}),(0,e.jsx)(be.a,{display:"flex",gap:2,marginTop:5,children:(0,e.jsxs)(g.B,{alignItems:"center",gap:2,children:[(0,e.jsx)(F.$n,{type:"submit",disabled:$,onClick:()=>Ge(!0),variant:G?"secondary":void 0,children:$?G?"Disabling...":"Saving...":G?"Disable":"Save and enable"}),(0,e.jsx)(F.$n,{type:"submit",disabled:$,variant:"secondary",onClick:()=>Ge(!1),children:$?"Saving...":"Save"}),(0,e.jsx)(F.z9,{href:"/admin/authentication",variant:"secondary",children:"Discard"}),(0,e.jsx)(Re.m,{overlay:ae,placement:"bottom-start",children:(0,e.jsx)(xe.K,{tooltip:"More actions",title:"More actions",tooltipPlacement:"top",size:"md",variant:"secondary",name:"ellipsis-v",hidden:a?.source==="system"})})]})})]}),Ue&&(0,e.jsx)(Ae.u,{isOpen:!0,icon:"trash-alt",title:"Reset",body:(0,e.jsxs)(g.B,{direction:"column",gap:3,children:[(0,e.jsx)("span",{children:"Are you sure you want to reset this configuration?"}),(0,e.jsx)("small",{children:"After resetting these settings Grafana will use the provider configuration from the system (config file/environment variables) if any."})]}),confirmText:"Reset",onDismiss:()=>D(!1),onConfirm:async()=>{await ge(),D(!1)}})]})};var Oe=n(7250),ke=n(60610);const Fe=a=>{if(!a)return{text:"Authentication",subTitle:"Configure authentication providers",icon:"shield",id:"authentication"};const t=Oe.L[a.provider][1]||a.provider.toUpperCase();return{text:t||"",subTitle:`To configure ${t} OAuth2 you must register your application with ${t}. The provider will generate a Client ID and Client Secret for you to use.`,icon:a.settings.icon||"shield",id:a.provider}},Le=()=>{const a=(0,q.useDispatch)(),{isLoading:t,providers:s}=(0,q.useSelector)(l=>l.authConfig),{provider:i=""}=(0,R.g)(),d=s.find(l=>l.provider===i);if((0,f.useEffect)(()=>{a((0,ke.TD)(i))},[a,i]),!d||!d.provider||!Oe.L[d.provider])return(0,e.jsx)(ye.H,{});const h=Fe(d);return(0,e.jsx)(se.YW,{navId:"authentication",pageNav:h,renderTitle:l=>(0,e.jsxs)(g.B,{gap:2,alignItems:"center",children:[(0,e.jsx)(Q.E,{variant:"h1",children:l}),(0,e.jsx)(X.E,{text:d.settings.enabled?"Enabled":"Not enabled",color:d.settings.enabled?"green":"blue",icon:d.settings.enabled?"check":void 0})]}),children:(0,e.jsx)(Ee,{config:d,isLoading:t,provider:i})})},Ne=Le},7250:(ie,S,n)=>{n.d(S,{L:()=>f,o:()=>e});const e="admin/authentication/",f={github:["github","GitHub"],gitlab:["gitlab","GitLab"],google:["google","Google"],generic_oauth:["lock","Generic OAuth"],grafana_com:["grafana","Grafana.com"],azuread:["microsoft","Azure AD"],okta:["okta","Okta"]}},5328:(ie,S,n)=>{n.d(S,{K:()=>R,h:()=>f});var e=n(7250);function f(g){return e.o+(g.configPath||g.id)}const R=g=>{if(typeof g!="string")return!1;try{return new URL(g).protocol.includes("http")}catch{return!1}}},8227:(ie,S,n)=>{n.d(S,{A:()=>R});const e=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function f(g){return typeof g=="string"&&e.test(g)}const R=f}}]);

//# sourceMappingURL=AdminAuthentication.64b5431cd854d1985ac4.js.map