{"version":3,"file":"AlertingRuleForm.077a35908016c01d73f2.js","mappings":"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","sources":["webpack://grafana/./public/app/features/alerting/unified/AlertWarning.tsx","webpack://grafana/./public/app/features/alerting/unified/hooks/ruleGroup/useUpsertRuleFromRuleGroup.ts","webpack://grafana/./public/app/features/alerting/unified/components/export/GrafanaRuleExporter.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/GroupAndNamespaceFields.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/CloudEvaluationBehavior.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/RecordingRulesNameSpaceAndGroupStep.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/AlertRuleForm.tsx","webpack://grafana/./public/app/features/alerting/unified/CloneRuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/ExistingRuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/RuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/ModifyExportRuleForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/export/GrafanaModifyExport.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/AlertRuleNameInput.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/contactPoint/ContactPointDetails.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/contactPoint/ContactPointSelector.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/route-settings/MuteTimingFields.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/route-settings/RouteTimings.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/route-settings/RouteSettings.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/AlertManagerRouting.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/alert-rule-form/simplifiedRouting/SimplifiedRouting.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/labels/LabelsEditorModal.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/labels/LabelsFieldInForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/notificaton-preview/NotificationPreview.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/NotificationsStep.tsx","webpack://grafana/./public/app/features/alerting/unified/types/preview.ts","webpack://grafana/./public/app/features/alerting/unified/api/preview.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/PreviewRuleResult.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/PreviewRule.tsx","webpack://grafana/./public/app/features/alerting/unified/hooks/useRuleSourcesWithRuler.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/preview.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/CloudAlertPreview.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/ExpressionEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/ExpressionsEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryOptions.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryWrapper.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryRows.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/QueryEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/RecordingRuleEditor.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/CloudRulesSourcePicker.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/CloudDataSourceSelector.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/reducer.ts","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/SimpleCondition.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/SmartAlertTypeDetector.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/descriptions.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/useAlertQueryRunner.tsx","webpack://grafana/./public/app/features/alerting/unified/components/rule-editor/query-and-alert-condition/QueryAndExpressionsStep.tsx","webpack://grafana/./public/app/features/alerting/unified/utils/duplicate.ts","webpack://grafana/./public/app/plugins/datasource/parca/QueryEditor/Stack.tsx"],"sourcesContent":["import { css } from '@emotion/css';\nimport * as React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Alert, LinkButton, useStyles2 } from '@grafana/ui';\n\ninterface AlertWarningProps {\n  title: string;\n  children: React.ReactNode;\n}\nexport function AlertWarning({ title, children }: AlertWarningProps) {\n  return (\n    <Alert className={useStyles2(warningStyles).warning} severity=\"warning\" title={title}>\n      <p>{children}</p>\n      <LinkButton href=\"alerting/list\">To rule list</LinkButton>\n    </Alert>\n  );\n}\n\nconst warningStyles = (theme: GrafanaTheme2) => ({\n  warning: css({\n    margin: theme.spacing(4),\n  }),\n});\n","import { produce } from 'immer';\nimport { isEqual } from 'lodash';\n\nimport { t } from 'app/core/internationalization';\nimport { RuleGroupIdentifier, EditableRuleIdentifier } from 'app/types/unified-alerting';\nimport { PostableRuleDTO } from 'app/types/unified-alerting-dto';\n\nimport { alertRuleApi } from '../../api/alertRuleApi';\nimport { addRuleAction, updateRuleAction } from '../../reducers/ruler/ruleGroups';\nimport { isGrafanaRuleIdentifier, isGrafanaRulerRule } from '../../utils/rules';\nimport { useAsync } from '../useAsync';\n\nimport { useDeleteRuleFromGroup } from './useDeleteRuleFromGroup';\nimport { useProduceNewRuleGroup } from './useProduceNewRuleGroup';\n\n/**\n * This hook will add a single rule to a rule group – a new rule group will be created if it does not already exist.\n */\nexport function useAddRuleToRuleGroup() {\n  const [produceNewRuleGroup] = useProduceNewRuleGroup();\n  const [upsertRuleGroup] = alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation();\n\n  const successMessage = t('alerting.rules.add-rule.success', 'Rule added successfully');\n\n  return useAsync(async (ruleGroup: RuleGroupIdentifier, rule: PostableRuleDTO, interval?: string) => {\n    const { namespaceName } = ruleGroup;\n\n    // the new rule might have to be created in a new group, pass name and interval (optional) to the action\n    const action = addRuleAction({ rule, interval, groupName: ruleGroup.groupName });\n    const { newRuleGroupDefinition, rulerConfig } = await produceNewRuleGroup(ruleGroup, action);\n\n    const result = upsertRuleGroup({\n      rulerConfig,\n      namespace: namespaceName,\n      payload: newRuleGroupDefinition,\n      notificationOptions: { successMessage },\n    }).unwrap();\n\n    return result;\n  });\n}\n\n/**\n * This hook will update an existing rule within a rule group, does not support moving the rule to another namespace / group\n */\nexport function useUpdateRuleInRuleGroup() {\n  const [produceNewRuleGroup] = useProduceNewRuleGroup();\n  const [moveRuleToGroup] = useMoveRuleToRuleGroup();\n  const [upsertRuleGroup] = alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation();\n\n  const successMessage = t('alerting.rules.update-rule.success', 'Rule updated successfully');\n\n  return useAsync(\n    async (\n      ruleGroup: RuleGroupIdentifier,\n      ruleIdentifier: EditableRuleIdentifier,\n      ruleDefinition: PostableRuleDTO,\n      targetRuleGroup?: RuleGroupIdentifier,\n      interval?: string\n    ) => {\n      const { namespaceName } = ruleGroup;\n      const finalRuleDefinition = copyGrafanaUID(ruleIdentifier, ruleDefinition);\n\n      // check if the existing rule and the form values have the same rule group identifier\n      const sameTargetRuleGroup = isEqual(ruleGroup, targetRuleGroup);\n      if (targetRuleGroup && !sameTargetRuleGroup) {\n        const result = moveRuleToGroup.execute(ruleGroup, targetRuleGroup, ruleIdentifier, ruleDefinition, interval);\n        return result;\n      }\n\n      const action = updateRuleAction({ identifier: ruleIdentifier, rule: finalRuleDefinition });\n      const { newRuleGroupDefinition, rulerConfig } = await produceNewRuleGroup(ruleGroup, action);\n\n      return upsertRuleGroup({\n        rulerConfig,\n        namespace: namespaceName,\n        payload: newRuleGroupDefinition,\n        notificationOptions: { successMessage },\n      }).unwrap();\n    }\n  );\n}\n\n/**\n * This hook will move an existing rule to another namespace or group. The rule definition can also be modified.\n * For Grafana-managed rules we can perform a single atomic move operation by copying the rule UID from the previous rule definition.\n */\nexport function useMoveRuleToRuleGroup() {\n  const [produceNewRuleGroup] = useProduceNewRuleGroup();\n  const [deleteRuleFromGroup] = useDeleteRuleFromGroup();\n  const [upsertRuleGroup] = alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation();\n\n  const successMessage = t('alerting.rules.update-rule.success', 'Rule updated successfully');\n\n  return useAsync(\n    async (\n      currentRuleGroup: RuleGroupIdentifier,\n      targetRuleGroup: RuleGroupIdentifier,\n      ruleIdentifier: EditableRuleIdentifier,\n      ruleDefinition: PostableRuleDTO,\n      interval?: string\n    ) => {\n      const finalRuleDefinition = copyGrafanaUID(ruleIdentifier, ruleDefinition);\n\n      // 1. add the rule to the new namespace / group / ruler target\n      const addRuleToGroup = addRuleAction({ rule: finalRuleDefinition, interval });\n      const { newRuleGroupDefinition: newTargetGroup, rulerConfig: targetGroupRulerConfig } = await produceNewRuleGroup(\n        targetRuleGroup,\n        addRuleToGroup\n      );\n\n      const result = await upsertRuleGroup({\n        rulerConfig: targetGroupRulerConfig,\n        namespace: targetRuleGroup.namespaceName,\n        payload: newTargetGroup,\n        notificationOptions: { successMessage },\n      }).unwrap();\n\n      // 2. if not Grafana-managed: remove the rule from the existing namespace / group / ruler\n      if (!isGrafanaRuleIdentifier(ruleIdentifier)) {\n        await deleteRuleFromGroup.execute(currentRuleGroup, ruleIdentifier);\n      }\n\n      return result;\n    }\n  );\n}\n\nfunction copyGrafanaUID(ruleIdentifier: EditableRuleIdentifier, ruleDefinition: PostableRuleDTO) {\n  const isGrafanaManagedRuleIdentifier = isGrafanaRuleIdentifier(ruleIdentifier);\n\n  // by copying over the rule UID the backend will perform an atomic move operation\n  // so there is no need for us to manually remove it from the previous group\n  return produce(ruleDefinition, (draft) => {\n    const isGrafanaManagedRuleDefinition = isGrafanaRulerRule(draft);\n\n    if (isGrafanaManagedRuleIdentifier && isGrafanaManagedRuleDefinition) {\n      draft.grafana_alert.uid = ruleIdentifier.uid;\n    }\n  });\n}\n","import { useState } from 'react';\n\nimport { LoadingPlaceholder } from '@grafana/ui';\n\nimport { alertRuleApi } from '../../api/alertRuleApi';\n\nimport { FileExportPreview } from './FileExportPreview';\nimport { GrafanaExportDrawer } from './GrafanaExportDrawer';\nimport { allGrafanaExportProviders, ExportFormats } from './providers';\n\ninterface GrafanaRuleExportPreviewProps {\n  alertUid: string;\n  exportFormat: ExportFormats;\n  onClose: () => void;\n}\n\nconst GrafanaRuleExportPreview = ({ alertUid, exportFormat, onClose }: GrafanaRuleExportPreviewProps) => {\n  const { currentData: ruleTextDefinition = '', isFetching } = alertRuleApi.endpoints.exportRules.useQuery({\n    ruleUid: alertUid,\n    format: exportFormat,\n  });\n\n  const downloadFileName = `${alertUid}-${new Date().getTime()}`;\n\n  if (isFetching) {\n    return <LoadingPlaceholder text=\"Loading....\" />;\n  }\n\n  return (\n    <FileExportPreview\n      format={exportFormat}\n      textDefinition={ruleTextDefinition}\n      downloadFileName={downloadFileName}\n      onClose={onClose}\n    />\n  );\n};\n\ninterface GrafanaRulerExporterProps {\n  onClose: () => void;\n  alertUid: string;\n}\n\nexport const GrafanaRuleExporter = ({ onClose, alertUid }: GrafanaRulerExporterProps) => {\n  const [activeTab, setActiveTab] = useState<ExportFormats>('yaml');\n\n  return (\n    <GrafanaExportDrawer\n      activeTab={activeTab}\n      onTabChange={setActiveTab}\n      onClose={onClose}\n      formatProviders={Object.values(allGrafanaExportProviders)}\n    >\n      <GrafanaRuleExportPreview alertUid={alertUid} exportFormat={activeTab} onClose={onClose} />\n    </GrafanaExportDrawer>\n  );\n};\n","import { css } from '@emotion/css';\nimport { useMemo } from 'react';\nimport { useFormContext, Controller } from 'react-hook-form';\n\nimport { GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { Field, useStyles2, VirtualizedSelect } from '@grafana/ui';\n\nimport { RuleFormValues } from '../../types/rule-form';\n\nimport { useAlertRuleSuggestions } from './useAlertRuleSuggestions';\n\ninterface Props {\n  rulesSourceName: string;\n}\n\nexport const GroupAndNamespaceFields = ({ rulesSourceName }: Props) => {\n  const {\n    control,\n    watch,\n    formState: { errors },\n    setValue,\n  } = useFormContext<RuleFormValues>();\n\n  const style = useStyles2(getStyle);\n  const { namespaceGroups, isLoading } = useAlertRuleSuggestions(rulesSourceName);\n\n  const namespace = watch('namespace');\n\n  const namespaceOptions: Array<SelectableValue<string>> = useMemo(\n    () =>\n      Array.from(namespaceGroups.keys()).map((namespace) => ({\n        label: namespace,\n        value: namespace,\n      })),\n    [namespaceGroups]\n  );\n\n  const groupOptions: Array<SelectableValue<string>> = useMemo(\n    () => (namespace && namespaceGroups.get(namespace)?.map((group) => ({ label: group, value: group }))) || [],\n    [namespace, namespaceGroups]\n  );\n\n  return (\n    <div className={style.flexRow}>\n      <Field\n        data-testid=\"namespace-picker\"\n        label=\"Namespace\"\n        error={errors.namespace?.message}\n        invalid={!!errors.namespace?.message}\n      >\n        <Controller\n          render={({ field: { onChange, ref, ...field } }) => (\n            <VirtualizedSelect\n              {...field}\n              allowCustomValue\n              className={style.input}\n              onChange={(value) => {\n                setValue('group', ''); //reset if namespace changes\n                onChange(value.value);\n              }}\n              options={namespaceOptions}\n              width={42}\n              isLoading={isLoading}\n              disabled={isLoading}\n            />\n          )}\n          name=\"namespace\"\n          control={control}\n          rules={{\n            required: { value: true, message: 'Required.' },\n          }}\n        />\n      </Field>\n      <Field data-testid=\"group-picker\" label=\"Group\" error={errors.group?.message} invalid={!!errors.group?.message}>\n        <Controller\n          render={({ field: { ref, ...field } }) => (\n            <VirtualizedSelect\n              {...field}\n              allowCustomValue\n              options={groupOptions}\n              width={42}\n              onChange={(value) => {\n                setValue('group', value.value ?? '');\n              }}\n              className={style.input}\n              isLoading={isLoading}\n              disabled={isLoading}\n            />\n          )}\n          name=\"group\"\n          control={control}\n          rules={{\n            required: { value: true, message: 'Required.' },\n          }}\n        />\n      </Field>\n    </div>\n  );\n};\n\nconst getStyle = (theme: GrafanaTheme2) => ({\n  flexRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'flex-start',\n\n    '& > * + *': {\n      marginLeft: theme.spacing(3),\n    },\n  }),\n  input: css({\n    width: '330px !important',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { useFormContext, Controller } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Field, Input, Select, useStyles2 } from '@grafana/ui';\n\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { timeOptions } from '../../utils/time';\n\nimport { GroupAndNamespaceFields } from './GroupAndNamespaceFields';\nimport { PreviewRule } from './PreviewRule';\nimport { RuleEditorSection } from './RuleEditorSection';\n\nexport const CloudEvaluationBehavior = () => {\n  const styles = useStyles2(getStyles);\n  const {\n    register,\n    control,\n    watch,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  const type = watch('type');\n  const dataSourceName = watch('dataSourceName');\n\n  return (\n    <RuleEditorSection stepNo={3} title=\"Set evaluation behavior\">\n      <Field\n        label=\"Pending period\"\n        description='Period the threshold condition must be met to trigger the alert. Selecting \"None\" triggers the alert immediately once the condition is met.'\n      >\n        <div className={styles.flexRow}>\n          <Field invalid={!!errors.forTime?.message} error={errors.forTime?.message} className={styles.inlineField}>\n            <Input\n              {...register('forTime', { pattern: { value: /^\\d+$/, message: 'Must be a positive integer.' } })}\n              width={8}\n            />\n          </Field>\n          <Controller\n            name=\"forTimeUnit\"\n            render={({ field: { onChange, ref, ...field } }) => (\n              <Select\n                {...field}\n                options={timeOptions}\n                onChange={(value) => onChange(value?.value)}\n                width={15}\n                className={styles.timeUnit}\n              />\n            )}\n            control={control}\n          />\n        </div>\n      </Field>\n      {type === RuleFormType.cloudAlerting && dataSourceName && (\n        <GroupAndNamespaceFields rulesSourceName={dataSourceName} />\n      )}\n\n      <PreviewRule />\n    </RuleEditorSection>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  inlineField: css({\n    marginBottom: 0,\n  }),\n  flexRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'flex-start',\n    alignItems: 'flex-start',\n  }),\n  timeUnit: css({\n    marginLeft: theme.spacing(0.5),\n  }),\n});\n","import { useFormContext } from 'react-hook-form';\n\nimport { RuleFormValues } from '../../types/rule-form';\n\nimport { GroupAndNamespaceFields } from './GroupAndNamespaceFields';\nimport { RuleEditorSection } from './RuleEditorSection';\n\nexport function RecordingRulesNameSpaceAndGroupStep() {\n  const { watch } = useFormContext<RuleFormValues>();\n\n  const dataSourceName = watch('dataSourceName');\n\n  if (!dataSourceName) {\n    return null;\n  }\n\n  return (\n    <RuleEditorSection\n      stepNo={3}\n      title={'Add namespace and group'}\n      description=\"Select the Namespace and Group for your recording rule.\"\n    >\n      <GroupAndNamespaceFields rulesSourceName={dataSourceName} />\n    </RuleEditorSection>\n  );\n}\n","import { css } from '@emotion/css';\nimport { useCallback, useEffect, useMemo, useState } from 'react';\nimport { FormProvider, SubmitErrorHandler, UseFormWatch, useForm } from 'react-hook-form';\nimport { useParams } from 'react-router-dom';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { config, locationService } from '@grafana/runtime';\nimport { Button, ConfirmModal, CustomScrollbar, Spinner, Stack, useStyles2 } from '@grafana/ui';\nimport { AppChromeUpdate } from 'app/core/components/AppChrome/AppChromeUpdate';\nimport { usePageToolbar } from 'app/core/components/Page/Page';\nimport { useAppNotification } from 'app/core/copy/appNotification';\nimport { contextSrv } from 'app/core/core';\nimport InfoPausedRule from 'app/features/alerting/unified/components/InfoPausedRule';\nimport {\n  getRuleGroupLocationFromFormValues,\n  getRuleGroupLocationFromRuleWithLocation,\n  isCloudRulerRule,\n  isGrafanaManagedRuleByType,\n  isGrafanaRulerRule,\n  isGrafanaRulerRulePaused,\n  isRecordingRuleByType,\n} from 'app/features/alerting/unified/utils/rules';\nimport { RuleGroupIdentifier, RuleIdentifier, RuleWithLocation } from 'app/types/unified-alerting';\nimport { PostableRuleGrafanaRuleDTO, RulerRuleDTO } from 'app/types/unified-alerting-dto';\n\nimport {\n  LogMessages,\n  logInfo,\n  trackAlertRuleFormCancelled,\n  trackAlertRuleFormError,\n  trackAlertRuleFormSaved,\n} from '../../../Analytics';\nimport { shouldUsePrometheusRulesPrimary } from '../../../featureToggles';\nimport { useDeleteRuleFromGroup } from '../../../hooks/ruleGroup/useDeleteRuleFromGroup';\nimport { useAddRuleToRuleGroup, useUpdateRuleInRuleGroup } from '../../../hooks/ruleGroup/useUpsertRuleFromRuleGroup';\nimport { useURLSearchParams } from '../../../hooks/useURLSearchParams';\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport {\n  DEFAULT_GROUP_EVALUATION_INTERVAL,\n  MANUAL_ROUTING_KEY,\n  SIMPLIFIED_QUERY_EDITOR_KEY,\n  formValuesFromExistingRule,\n  formValuesToRulerGrafanaRuleDTO,\n  formValuesToRulerRuleDTO,\n  getDefaultFormValues,\n  getDefaultQueries,\n  ignoreHiddenQueries,\n  normalizeDefaultAnnotations,\n} from '../../../utils/rule-form';\nimport { fromRulerRule, fromRulerRuleAndRuleGroupIdentifier, stringifyIdentifier } from '../../../utils/rule-id';\nimport * as ruleId from '../../../utils/rule-id';\nimport { createRelativeUrl } from '../../../utils/url';\nimport { GrafanaRuleExporter } from '../../export/GrafanaRuleExporter';\nimport { AlertRuleNameAndMetric } from '../AlertRuleNameInput';\nimport AnnotationsStep from '../AnnotationsStep';\nimport { CloudEvaluationBehavior } from '../CloudEvaluationBehavior';\nimport { GrafanaEvaluationBehavior } from '../GrafanaEvaluationBehavior';\nimport { NotificationsStep } from '../NotificationsStep';\nimport { RecordingRulesNameSpaceAndGroupStep } from '../RecordingRulesNameSpaceAndGroupStep';\nimport { RuleInspector } from '../RuleInspector';\nimport { QueryAndExpressionsStep } from '../query-and-alert-condition/QueryAndExpressionsStep';\nimport { translateRouteParamToRuleType } from '../util';\n\ntype Props = {\n  existing?: RuleWithLocation;\n  prefill?: Partial<RuleFormValues>; // Existing implies we modify existing rule. Prefill only provides default form values\n};\n\nconst prometheusRulesPrimary = shouldUsePrometheusRulesPrimary();\n\nexport const AlertRuleForm = ({ existing, prefill }: Props) => {\n  const styles = useStyles2(getStyles);\n  const notifyApp = useAppNotification();\n  const [queryParams] = useURLSearchParams();\n  const [showEditYaml, setShowEditYaml] = useState(false);\n  const [evaluateEvery, setEvaluateEvery] = useState(existing?.group.interval ?? DEFAULT_GROUP_EVALUATION_INTERVAL);\n\n  const [deleteRuleFromGroup] = useDeleteRuleFromGroup();\n  const [addRuleToRuleGroup] = useAddRuleToRuleGroup();\n  const [updateRuleInRuleGroup] = useUpdateRuleInRuleGroup();\n\n  const routeParams = useParams<{ type: string; id: string }>();\n  const ruleType = translateRouteParamToRuleType(routeParams.type);\n\n  const uidFromParams = routeParams.id;\n\n  const [showDeleteModal, setShowDeleteModal] = useState<boolean>(false);\n\n  const defaultValues: RuleFormValues = useMemo(() => {\n    if (existing) {\n      return formValuesFromExistingRule(existing);\n    }\n\n    if (prefill) {\n      return formValuesFromPrefill(prefill);\n    }\n\n    if (queryParams.has('defaults')) {\n      return formValuesFromQueryParams(queryParams.get('defaults') ?? '', ruleType);\n    }\n\n    return {\n      ...getDefaultFormValues(),\n      condition: 'C',\n      queries: getDefaultQueries(),\n      type: ruleType || RuleFormType.grafana,\n      evaluateEvery: evaluateEvery,\n    };\n  }, [existing, prefill, queryParams, evaluateEvery, ruleType]);\n\n  const formAPI = useForm<RuleFormValues>({\n    mode: 'onSubmit',\n    defaultValues,\n    shouldFocusError: true,\n  });\n\n  const {\n    handleSubmit,\n    watch,\n    formState: { isSubmitting },\n  } = formAPI;\n\n  const type = watch('type');\n  const grafanaTypeRule = isGrafanaManagedRuleByType(type ?? RuleFormType.grafana);\n\n  const dataSourceName = watch('dataSourceName');\n\n  const showDataSourceDependantStep = Boolean(type && (isGrafanaManagedRuleByType(type) || !!dataSourceName));\n\n  const [conditionErrorMsg, setConditionErrorMsg] = useState('');\n\n  const checkAlertCondition = (msg = '') => {\n    setConditionErrorMsg(msg);\n  };\n\n  // @todo why is error not propagated to form?\n  const submit = useCallback(\n    async (values: RuleFormValues, exitOnSave: boolean) => {\n      if (conditionErrorMsg !== '') {\n        notifyApp.error(conditionErrorMsg);\n        return;\n      }\n\n      trackAlertRuleFormSaved({ formAction: existing ? 'update' : 'create', ruleType: values.type });\n\n      const ruleDefinition = grafanaTypeRule\n        ? formValuesToRulerGrafanaRuleDTO(values)\n        : formValuesToRulerRuleDTO(values);\n\n      const ruleGroupIdentifier = existing\n        ? getRuleGroupLocationFromRuleWithLocation(existing)\n        : getRuleGroupLocationFromFormValues(values);\n\n      // @TODO move this to a hook too to make sure the logic here is tested for regressions?\n      if (!existing) {\n        // when creating a new rule, we save the manual routing setting , and editorSettings.simplifiedQueryEditor to the local storage\n        storeInLocalStorageValues(values);\n        await addRuleToRuleGroup.execute(ruleGroupIdentifier, ruleDefinition, evaluateEvery);\n      } else {\n        const ruleIdentifier = fromRulerRuleAndRuleGroupIdentifier(ruleGroupIdentifier, existing.rule);\n        const targetRuleGroupIdentifier = getRuleGroupLocationFromFormValues(values);\n        await updateRuleInRuleGroup.execute(\n          ruleGroupIdentifier,\n          ruleIdentifier,\n          ruleDefinition,\n          targetRuleGroupIdentifier,\n          evaluateEvery\n        );\n      }\n\n      const { dataSourceName, namespaceName, groupName } = ruleGroupIdentifier;\n      if (exitOnSave) {\n        const returnTo = queryParams.get('returnTo') || getReturnToUrl(ruleGroupIdentifier, ruleDefinition);\n\n        locationService.push(returnTo);\n        return;\n      }\n\n      // Cloud Ruler rules identifier changes on update due to containing rule name and hash components\n      // After successful update we need to update the URL to avoid displaying 404 errors\n      if (isCloudRulerRule(ruleDefinition)) {\n        const updatedRuleIdentifier = fromRulerRule(dataSourceName, namespaceName, groupName, ruleDefinition);\n        locationService.replace(`/alerting/${encodeURIComponent(stringifyIdentifier(updatedRuleIdentifier))}/edit`);\n      }\n    },\n    [\n      addRuleToRuleGroup,\n      conditionErrorMsg,\n      evaluateEvery,\n      existing,\n      grafanaTypeRule,\n      notifyApp,\n      queryParams,\n      updateRuleInRuleGroup,\n    ]\n  );\n\n  const deleteRule = async () => {\n    if (existing) {\n      const returnTo = queryParams.get('returnTo') || '/alerting/list';\n      const ruleGroupIdentifier = getRuleGroupLocationFromRuleWithLocation(existing);\n      const ruleIdentifier = fromRulerRuleAndRuleGroupIdentifier(ruleGroupIdentifier, existing.rule);\n\n      await deleteRuleFromGroup.execute(ruleGroupIdentifier, ruleIdentifier);\n      locationService.replace(returnTo);\n    }\n  };\n\n  const onInvalid: SubmitErrorHandler<RuleFormValues> = useCallback(\n    (errors): void => {\n      trackAlertRuleFormError({\n        grafana_version: config.buildInfo.version,\n        org_id: contextSrv.user.orgId,\n        user_id: contextSrv.user.id,\n        error: Object.keys(errors).toString(),\n        formAction: existing ? 'update' : 'create',\n      });\n      notifyApp.error('There are errors in the form. Please correct them and try again!');\n    },\n    [existing, notifyApp]\n  );\n\n  const cancelRuleCreation = useCallback(() => {\n    logInfo(LogMessages.cancelSavingAlertRule);\n    trackAlertRuleFormCancelled({ formAction: existing ? 'update' : 'create' });\n    locationService.getHistory().goBack();\n  }, [existing]);\n\n  const evaluateEveryInForm = watch('evaluateEvery');\n  useEffect(() => setEvaluateEvery(evaluateEveryInForm), [evaluateEveryInForm]);\n\n  const actionButtons = useMemo(\n    () => (\n      <Stack justifyContent=\"flex-end\" alignItems=\"center\">\n        {existing && (\n          <Button\n            variant=\"primary\"\n            type=\"button\"\n            size=\"sm\"\n            onClick={handleSubmit((values) => submit(values, false), onInvalid)}\n            disabled={isSubmitting}\n          >\n            {isSubmitting && <Spinner className={styles.buttonSpinner} inline={true} />}\n            Save rule\n          </Button>\n        )}\n        <Button\n          variant=\"primary\"\n          type=\"button\"\n          size=\"sm\"\n          onClick={handleSubmit((values) => submit(values, true), onInvalid)}\n          disabled={isSubmitting}\n        >\n          {isSubmitting && <Spinner className={styles.buttonSpinner} inline={true} />}\n          Save rule and exit\n        </Button>\n        <Button variant=\"secondary\" disabled={isSubmitting} type=\"button\" onClick={cancelRuleCreation} size=\"sm\">\n          Cancel\n        </Button>\n        {existing ? (\n          <Button fill=\"outline\" variant=\"destructive\" type=\"button\" onClick={() => setShowDeleteModal(true)} size=\"sm\">\n            Delete\n          </Button>\n        ) : null}\n        {existing && isCortexLokiOrRecordingRule(watch) && (\n          <Button\n            variant=\"secondary\"\n            type=\"button\"\n            onClick={() => setShowEditYaml(true)}\n            disabled={isSubmitting}\n            size=\"sm\"\n          >\n            Edit YAML\n          </Button>\n        )}\n      </Stack>\n    ),\n    [cancelRuleCreation, existing, handleSubmit, isSubmitting, onInvalid, styles.buttonSpinner, submit, watch]\n  );\n  usePageToolbar(actionButtons);\n\n  const isPaused = existing && isGrafanaRulerRule(existing.rule) && isGrafanaRulerRulePaused(existing.rule);\n  if (!type) {\n    return null;\n  }\n  return (\n    <FormProvider {...formAPI}>\n      {!config.featureToggles.singleTopNav && <AppChromeUpdate actions={actionButtons} />}\n      <form onSubmit={(e) => e.preventDefault()} className={styles.form}>\n        <div className={styles.contentOuter}>\n          {isPaused && <InfoPausedRule />}\n          <CustomScrollbar autoHeightMin=\"100%\" hideHorizontalTrack={true}>\n            <Stack direction=\"column\" gap={3}>\n              {/* Step 1 */}\n              <AlertRuleNameAndMetric />\n              {/* Step 2 */}\n              <QueryAndExpressionsStep editingExistingRule={!!existing} onDataChange={checkAlertCondition} />\n              {/* Step 3-4-5 */}\n              {showDataSourceDependantStep && (\n                <>\n                  {/* Step 3 */}\n                  {isGrafanaManagedRuleByType(type) && (\n                    <GrafanaEvaluationBehavior\n                      evaluateEvery={evaluateEvery}\n                      setEvaluateEvery={setEvaluateEvery}\n                      existing={Boolean(existing)}\n                      enableProvisionedGroups={false}\n                    />\n                  )}\n\n                  {type === RuleFormType.cloudAlerting && <CloudEvaluationBehavior />}\n\n                  {type === RuleFormType.cloudRecording && <RecordingRulesNameSpaceAndGroupStep />}\n\n                  {/* Step 4 & 5 */}\n                  {/* Notifications step*/}\n                  <NotificationsStep alertUid={uidFromParams} />\n                  {/* Annotations only for cloud and Grafana */}\n                  {!isRecordingRuleByType(type) && <AnnotationsStep />}\n                </>\n              )}\n            </Stack>\n          </CustomScrollbar>\n        </div>\n      </form>\n      {showDeleteModal ? (\n        <ConfirmModal\n          isOpen={true}\n          title=\"Delete rule\"\n          body=\"Deleting this rule will permanently remove it. Are you sure you want to delete this rule?\"\n          confirmText=\"Yes, delete\"\n          icon=\"exclamation-triangle\"\n          onConfirm={deleteRule}\n          onDismiss={() => setShowDeleteModal(false)}\n        />\n      ) : null}\n      {showEditYaml ? (\n        isGrafanaManagedRuleByType(type) ? (\n          <GrafanaRuleExporter alertUid={uidFromParams} onClose={() => setShowEditYaml(false)} />\n        ) : (\n          <RuleInspector onClose={() => setShowEditYaml(false)} />\n        )\n      ) : null}\n    </FormProvider>\n  );\n};\n\nfunction getReturnToUrl(groupId: RuleGroupIdentifier, rule: RulerRuleDTO | PostableRuleGrafanaRuleDTO) {\n  const { dataSourceName, namespaceName, groupName } = groupId;\n\n  if (prometheusRulesPrimary && isCloudRulerRule(rule)) {\n    const ruleIdentifier = fromRulerRule(dataSourceName, namespaceName, groupName, rule);\n    return createViewLinkFromIdentifier(ruleIdentifier);\n  }\n\n  // TODO We could add namespace and group filters but for GMA the namespace = uid which doesn't work with the filters\n  return '/alerting/list';\n}\n\n// The result of this function is passed to locationService.push()\n// Hence it cannot contain the subpath prefix, so we cannot use createRelativeUrl for it\nfunction createViewLinkFromIdentifier(identifier: RuleIdentifier, returnTo?: string) {\n  const paramId = encodeURIComponent(ruleId.stringifyIdentifier(identifier));\n  const paramSource = encodeURIComponent(identifier.ruleSourceName);\n\n  return createRelativeUrl(`/alerting/${paramSource}/${paramId}/view`, returnTo ? { returnTo } : {});\n}\n\nconst isCortexLokiOrRecordingRule = (watch: UseFormWatch<RuleFormValues>) => {\n  const [ruleType, dataSourceName] = watch(['type', 'dataSourceName']);\n\n  return (ruleType === RuleFormType.cloudAlerting || ruleType === RuleFormType.cloudRecording) && dataSourceName !== '';\n};\n\nfunction formValuesFromQueryParams(ruleDefinition: string, type: RuleFormType): RuleFormValues {\n  let ruleFromQueryParams: Partial<RuleFormValues>;\n\n  try {\n    ruleFromQueryParams = JSON.parse(ruleDefinition);\n  } catch (err) {\n    return {\n      ...getDefaultFormValues(),\n      queries: getDefaultQueries(),\n    };\n  }\n\n  return ignoreHiddenQueries({\n    ...getDefaultFormValues(),\n    ...ruleFromQueryParams,\n    annotations: normalizeDefaultAnnotations(ruleFromQueryParams.annotations ?? []),\n    queries: ruleFromQueryParams.queries ?? getDefaultQueries(),\n    type: type || RuleFormType.grafana,\n    evaluateEvery: DEFAULT_GROUP_EVALUATION_INTERVAL,\n  });\n}\n\nfunction formValuesFromPrefill(rule: Partial<RuleFormValues>): RuleFormValues {\n  return ignoreHiddenQueries({\n    ...getDefaultFormValues(),\n    ...rule,\n  });\n}\n\nfunction storeInLocalStorageValues(values: RuleFormValues) {\n  if (values.manualRouting) {\n    localStorage.setItem(MANUAL_ROUTING_KEY, 'true');\n  } else {\n    localStorage.setItem(MANUAL_ROUTING_KEY, 'false');\n  }\n  if (values.editorSettings) {\n    if (values.editorSettings.simplifiedQueryEditor) {\n      localStorage.setItem(SIMPLIFIED_QUERY_EDITOR_KEY, 'true');\n    } else {\n      localStorage.setItem(SIMPLIFIED_QUERY_EDITOR_KEY, 'false');\n    }\n  }\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  buttonSpinner: css({\n    marginRight: theme.spacing(1),\n  }),\n  form: css({\n    width: '100%',\n    height: '100%',\n    display: 'flex',\n    flexDirection: 'column',\n  }),\n  contentOuter: css({\n    background: theme.colors.background.primary,\n    overflow: 'hidden',\n    maxWidth: theme.breakpoints.values.xl,\n    flex: 1,\n  }),\n  flexRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'flex-start',\n  }),\n});\n","import { cloneDeep } from 'lodash';\n\nimport { locationService } from '@grafana/runtime/src';\nimport { Alert, LoadingPlaceholder } from '@grafana/ui/src';\n\nimport { RuleIdentifier, RuleWithLocation } from '../../../types/unified-alerting';\nimport { RulerRuleDTO } from '../../../types/unified-alerting-dto';\n\nimport { AlertRuleForm } from './components/rule-editor/alert-rule-form/AlertRuleForm';\nimport { useRuleWithLocation } from './hooks/useCombinedRule';\nimport { generateCopiedName } from './utils/duplicate';\nimport { stringifyErrorLike } from './utils/misc';\nimport { rulerRuleToFormValues } from './utils/rule-form';\nimport { getRuleName, isAlertingRulerRule, isGrafanaRulerRule, isRecordingRulerRule } from './utils/rules';\nimport { createRelativeUrl } from './utils/url';\n\nexport function CloneRuleEditor({ sourceRuleId }: { sourceRuleId: RuleIdentifier }) {\n  const { loading, result: rule, error } = useRuleWithLocation({ ruleIdentifier: sourceRuleId });\n\n  if (loading) {\n    return <LoadingPlaceholder text=\"Loading the rule...\" />;\n  }\n\n  if (rule) {\n    const ruleClone = cloneRuleDefinition(rule);\n    const formPrefill = rulerRuleToFormValues(ruleClone);\n\n    return <AlertRuleForm prefill={formPrefill} />;\n  }\n\n  if (error) {\n    return (\n      <Alert title=\"Error\" severity=\"error\">\n        {stringifyErrorLike(error)}\n      </Alert>\n    );\n  }\n\n  return (\n    <Alert\n      title=\"Cannot copy the rule. The rule does not exist\"\n      buttonContent=\"Go back to alert list\"\n      onRemove={() => locationService.replace(createRelativeUrl('/alerting/list'))}\n    />\n  );\n}\n\nfunction changeRuleName(rule: RulerRuleDTO, newName: string) {\n  if (isGrafanaRulerRule(rule)) {\n    rule.grafana_alert.title = newName;\n  }\n  if (isAlertingRulerRule(rule)) {\n    rule.alert = newName;\n  }\n\n  if (isRecordingRulerRule(rule)) {\n    rule.record = newName;\n  }\n}\n\nexport function cloneRuleDefinition(rule: RuleWithLocation<RulerRuleDTO>) {\n  const ruleClone = cloneDeep(rule);\n  changeRuleName(\n    ruleClone.rule,\n    generateCopiedName(getRuleName(ruleClone.rule), ruleClone.group.rules.map(getRuleName))\n  );\n\n  if (isGrafanaRulerRule(ruleClone.rule)) {\n    ruleClone.rule.grafana_alert.uid = '';\n\n    // Provisioned alert rules have provisioned alert group which cannot be used in UI\n    if (Boolean(ruleClone.rule.grafana_alert.provenance)) {\n      ruleClone.group = { name: '', rules: ruleClone.group.rules };\n    }\n  }\n\n  return ruleClone;\n}\n","import { Alert, LoadingPlaceholder } from '@grafana/ui';\nimport { RuleIdentifier } from 'app/types/unified-alerting';\n\nimport { AlertWarning } from './AlertWarning';\nimport { AlertRuleForm } from './components/rule-editor/alert-rule-form/AlertRuleForm';\nimport { useRuleWithLocation } from './hooks/useCombinedRule';\nimport { useIsRuleEditable } from './hooks/useIsRuleEditable';\nimport { stringifyErrorLike } from './utils/misc';\nimport * as ruleId from './utils/rule-id';\n\ninterface ExistingRuleEditorProps {\n  identifier: RuleIdentifier;\n  id?: string;\n}\n\nexport function ExistingRuleEditor({ identifier, id }: ExistingRuleEditorProps) {\n  const {\n    loading: loadingAlertRule,\n    result: ruleWithLocation,\n    error,\n  } = useRuleWithLocation({ ruleIdentifier: identifier });\n\n  const ruleSourceName = ruleId.ruleIdentifierToRuleSourceName(identifier);\n\n  const { isEditable, loading: loadingEditable } = useIsRuleEditable(ruleSourceName, ruleWithLocation?.rule);\n\n  const loading = loadingAlertRule || loadingEditable;\n\n  if (loading) {\n    return <LoadingPlaceholder text=\"Loading rule...\" />;\n  }\n\n  if (error) {\n    return (\n      <Alert severity=\"error\" title=\"Failed to load rule\">\n        {stringifyErrorLike(error)}\n      </Alert>\n    );\n  }\n\n  if (!ruleWithLocation) {\n    return <AlertWarning title=\"Rule not found\">Sorry! This rule does not exist.</AlertWarning>;\n  }\n\n  if (isEditable === false) {\n    return <AlertWarning title=\"Cannot edit rule\">Sorry! You do not have permission to edit this rule.</AlertWarning>;\n  }\n\n  return <AlertRuleForm existing={ruleWithLocation} />;\n}\n","import { useCallback } from 'react';\nimport { useParams } from 'react-router-dom-v5-compat';\nimport { useAsync } from 'react-use';\n\nimport { NavModelItem } from '@grafana/data';\nimport { withErrorBoundary } from '@grafana/ui';\nimport { useDispatch } from 'app/types';\nimport { RuleIdentifier } from 'app/types/unified-alerting';\n\nimport { AlertWarning } from './AlertWarning';\nimport { CloneRuleEditor } from './CloneRuleEditor';\nimport { ExistingRuleEditor } from './ExistingRuleEditor';\nimport { AlertingPageWrapper } from './components/AlertingPageWrapper';\nimport { AlertRuleForm } from './components/rule-editor/alert-rule-form/AlertRuleForm';\nimport { useURLSearchParams } from './hooks/useURLSearchParams';\nimport { fetchRulesSourceBuildInfoAction } from './state/actions';\nimport { useRulesAccess } from './utils/accessControlHooks';\nimport * as ruleId from './utils/rule-id';\n\ntype RuleEditorPathParams = {\n  id?: string;\n  type?: 'recording' | 'alerting' | 'grafana-recording';\n};\n\nconst defaultPageNav: Partial<NavModelItem> = {\n  icon: 'bell',\n  id: 'alert-rule-view',\n};\n\n// sadly we only get the \"type\" when a new rule is being created, when editing an existing recording rule we can't actually know it from the URL\nconst getPageNav = (identifier?: RuleIdentifier, type?: RuleEditorPathParams['type']) => {\n  if (type === 'recording' || type === 'grafana-recording') {\n    if (identifier) {\n      // this branch should never trigger actually, the type param isn't used when editing rules\n      return { ...defaultPageNav, id: 'alert-rule-edit', text: 'Edit recording rule' };\n    } else {\n      return { ...defaultPageNav, id: 'alert-rule-add', text: 'New recording rule' };\n    }\n  }\n\n  if (identifier) {\n    // keep this one ambiguous, don't mentiond a specific alert type here\n    return { ...defaultPageNav, id: 'alert-rule-edit', text: 'Edit rule' };\n  } else {\n    return { ...defaultPageNav, id: 'alert-rule-add', text: 'New alert rule' };\n  }\n};\n\nconst RuleEditor = () => {\n  const dispatch = useDispatch();\n  const [searchParams] = useURLSearchParams();\n  const params = useParams<RuleEditorPathParams>();\n  const { type } = params;\n  const id = ruleId.getRuleIdFromPathname(params);\n  const identifier = ruleId.tryParse(id, true);\n\n  const copyFromId = searchParams.get('copyFrom') ?? undefined;\n  const copyFromIdentifier = ruleId.tryParse(copyFromId);\n\n  const { loading = true } = useAsync(async () => {\n    if (identifier) {\n      await dispatch(fetchRulesSourceBuildInfoAction({ rulesSourceName: identifier.ruleSourceName }));\n    }\n    if (copyFromIdentifier) {\n      await dispatch(fetchRulesSourceBuildInfoAction({ rulesSourceName: copyFromIdentifier.ruleSourceName }));\n    }\n  }, [dispatch]);\n\n  const { canCreateGrafanaRules, canCreateCloudRules, canEditRules } = useRulesAccess();\n\n  const getContent = useCallback(() => {\n    if (loading) {\n      return;\n    }\n\n    if (!identifier && !canCreateGrafanaRules && !canCreateCloudRules) {\n      return <AlertWarning title=\"Cannot create rules\">Sorry! You are not allowed to create rules.</AlertWarning>;\n    }\n\n    if (identifier && !canEditRules(identifier.ruleSourceName)) {\n      return <AlertWarning title=\"Cannot edit rules\">Sorry! You are not allowed to edit rules.</AlertWarning>;\n    }\n\n    if (identifier) {\n      return <ExistingRuleEditor key={id} identifier={identifier} id={id} />;\n    }\n\n    if (copyFromIdentifier) {\n      return <CloneRuleEditor sourceRuleId={copyFromIdentifier} />;\n    }\n    // new alert rule\n    return <AlertRuleForm />;\n  }, [canCreateCloudRules, canCreateGrafanaRules, canEditRules, copyFromIdentifier, id, identifier, loading]);\n\n  return (\n    <AlertingPageWrapper isLoading={loading} navId=\"alert-list\" pageNav={getPageNav(identifier, type)}>\n      {getContent()}\n    </AlertingPageWrapper>\n  );\n};\n\nexport default withErrorBoundary(RuleEditor, { style: 'page' });\n","import { memo, useCallback, useEffect, useMemo, useState } from 'react';\nimport { FormProvider, useForm } from 'react-hook-form';\nimport { useAsync } from 'react-use';\n\nimport { config } from '@grafana/runtime';\nimport { Button, CustomScrollbar, LinkButton, LoadingPlaceholder, Stack } from '@grafana/ui';\nimport { usePageToolbar } from 'app/core/components/Page/Page';\nimport { useAppNotification } from 'app/core/copy/appNotification';\nimport { useQueryParams } from 'app/core/hooks/useQueryParams';\n\nimport { AppChromeUpdate } from '../../../../../../core/components/AppChrome/AppChromeUpdate';\nimport {\n  PostableRulerRuleGroupDTO,\n  RulerRuleDTO,\n  RulerRuleGroupDTO,\n} from '../../../../../../types/unified-alerting-dto';\nimport { alertRuleApi } from '../../../api/alertRuleApi';\nimport { fetchRulerRulesGroup } from '../../../api/ruler';\nimport { useDataSourceFeatures } from '../../../hooks/useCombinedRule';\nimport { RuleFormValues } from '../../../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../../../utils/datasource';\nimport { DEFAULT_GROUP_EVALUATION_INTERVAL, formValuesToRulerGrafanaRuleDTO } from '../../../utils/rule-form';\nimport { isGrafanaRulerRule } from '../../../utils/rules';\nimport { FileExportPreview } from '../../export/FileExportPreview';\nimport { GrafanaExportDrawer } from '../../export/GrafanaExportDrawer';\nimport { ExportFormats, allGrafanaExportProviders } from '../../export/providers';\nimport { AlertRuleNameAndMetric } from '../AlertRuleNameInput';\nimport AnnotationsStep from '../AnnotationsStep';\nimport { GrafanaEvaluationBehavior } from '../GrafanaEvaluationBehavior';\nimport { NotificationsStep } from '../NotificationsStep';\nimport { QueryAndExpressionsStep } from '../query-and-alert-condition/QueryAndExpressionsStep';\n\ninterface ModifyExportRuleFormProps {\n  alertUid: string;\n  ruleForm?: RuleFormValues;\n}\n\nexport function ModifyExportRuleForm({ ruleForm, alertUid }: ModifyExportRuleFormProps) {\n  const formAPI = useForm<RuleFormValues>({\n    mode: 'onSubmit',\n    defaultValues: ruleForm,\n    shouldFocusError: true,\n  });\n  const [queryParams] = useQueryParams();\n\n  const existing = Boolean(ruleForm); // always should be true\n  const notifyApp = useAppNotification();\n  const returnTo = !queryParams.returnTo ? '/alerting/list' : String(queryParams.returnTo);\n\n  const [exportData, setExportData] = useState<RuleFormValues | undefined>(undefined);\n\n  const [conditionErrorMsg, setConditionErrorMsg] = useState('');\n  const [evaluateEvery, setEvaluateEvery] = useState(ruleForm?.evaluateEvery ?? DEFAULT_GROUP_EVALUATION_INTERVAL);\n\n  const onInvalid = useCallback((): void => {\n    notifyApp.error('There are errors in the form. Please correct them and try again!');\n  }, [notifyApp]);\n\n  const checkAlertCondition = (msg = '') => {\n    setConditionErrorMsg(msg);\n  };\n\n  const submit = useCallback(\n    (exportData: RuleFormValues | undefined) => {\n      if (conditionErrorMsg !== '') {\n        notifyApp.error(conditionErrorMsg);\n        return;\n      }\n      setExportData(exportData);\n    },\n    [conditionErrorMsg, notifyApp]\n  );\n\n  const onClose = useCallback(() => {\n    setExportData(undefined);\n  }, [setExportData]);\n\n  const actionButtons = useMemo(\n    () => [\n      <LinkButton href={returnTo} key=\"cancel\" size=\"sm\" variant=\"secondary\" onClick={() => submit(undefined)}>\n        Cancel\n      </LinkButton>,\n      <Button key=\"export-rule\" size=\"sm\" onClick={formAPI.handleSubmit((formValues) => submit(formValues), onInvalid)}>\n        Export\n      </Button>,\n    ],\n    [formAPI, onInvalid, returnTo, submit]\n  );\n\n  usePageToolbar(actionButtons);\n\n  return (\n    <>\n      <FormProvider {...formAPI}>\n        {!config.featureToggles.singleTopNav && <AppChromeUpdate actions={actionButtons} />}\n        <form onSubmit={(e) => e.preventDefault()}>\n          <div>\n            <CustomScrollbar autoHeightMin=\"100%\" hideHorizontalTrack={true}>\n              <Stack direction=\"column\" gap={3}>\n                {/* Step 1 */}\n                <AlertRuleNameAndMetric />\n                {/* Step 2 */}\n                <QueryAndExpressionsStep editingExistingRule={existing} onDataChange={checkAlertCondition} />\n                {/* Step 3-4-5 */}\n\n                <GrafanaEvaluationBehavior\n                  evaluateEvery={evaluateEvery}\n                  setEvaluateEvery={setEvaluateEvery}\n                  existing={Boolean(existing)}\n                  enableProvisionedGroups={true}\n                />\n\n                {/* Step 4 & 5 */}\n                {/* Notifications step*/}\n                <NotificationsStep alertUid={alertUid} />\n                {/* Annotations only for cloud and Grafana */}\n                <AnnotationsStep />\n              </Stack>\n            </CustomScrollbar>\n          </div>\n        </form>\n        {exportData && <GrafanaRuleDesignExporter exportValues={exportData} onClose={onClose} uid={alertUid} />}\n      </FormProvider>\n    </>\n  );\n}\n\nconst useGetGroup = (nameSpaceUID: string, group: string) => {\n  const { dsFeatures } = useDataSourceFeatures(GRAFANA_RULES_SOURCE_NAME);\n\n  const rulerConfig = dsFeatures?.rulerConfig;\n\n  const targetGroup = useAsync(async () => {\n    return rulerConfig ? await fetchRulerRulesGroup(rulerConfig, nameSpaceUID, group) : undefined;\n  }, [rulerConfig, nameSpaceUID, group]);\n\n  return targetGroup;\n};\n\ninterface GrafanaRuleDesignExportPreviewProps {\n  exportFormat: ExportFormats;\n  onClose: () => void;\n  exportValues: RuleFormValues;\n  uid: string;\n}\nexport const getPayloadToExport = (\n  uid: string,\n  formValues: RuleFormValues,\n  existingGroup: RulerRuleGroupDTO<RulerRuleDTO> | null | undefined\n): PostableRulerRuleGroupDTO => {\n  const grafanaRuleDto = formValuesToRulerGrafanaRuleDTO(formValues);\n\n  const updatedRule = { ...grafanaRuleDto, grafana_alert: { ...grafanaRuleDto.grafana_alert, uid: uid } };\n  if (existingGroup?.rules) {\n    // we have to update the rule in the group in the same position if it exists, otherwise we have to add it at the end\n    let alreadyExistsInGroup = false;\n    const updatedRules = existingGroup.rules.map((rule: RulerRuleDTO) => {\n      if (isGrafanaRulerRule(rule) && rule.grafana_alert.uid === uid) {\n        alreadyExistsInGroup = true;\n        return updatedRule;\n      } else {\n        return rule;\n      }\n    });\n    if (!alreadyExistsInGroup) {\n      // we have to add the updated rule at the end of the group\n      updatedRules.push(updatedRule);\n    }\n    return {\n      ...existingGroup,\n      rules: updatedRules,\n    };\n  } else {\n    // we have to create a new group with the updated rule\n    return {\n      name: existingGroup?.name ?? '',\n      rules: [updatedRule],\n    };\n  }\n};\n\nconst useGetPayloadToExport = (values: RuleFormValues, uid: string) => {\n  const rulerGroupDto = useGetGroup(values.folder?.uid ?? '', values.group);\n  const payload: PostableRulerRuleGroupDTO = useMemo(() => {\n    return getPayloadToExport(uid, values, rulerGroupDto?.value);\n  }, [uid, rulerGroupDto, values]);\n  return { payload, loadingGroup: rulerGroupDto.loading };\n};\n\nconst GrafanaRuleDesignExportPreview = ({\n  exportFormat,\n  exportValues,\n  onClose,\n  uid,\n}: GrafanaRuleDesignExportPreviewProps) => {\n  const [getExport, exportData] = alertRuleApi.endpoints.exportModifiedRuleGroup.useMutation();\n  const { loadingGroup, payload } = useGetPayloadToExport(exportValues, uid);\n\n  const nameSpaceUID = exportValues.folder?.uid ?? '';\n\n  useEffect(() => {\n    !loadingGroup && getExport({ payload, format: exportFormat, nameSpaceUID });\n  }, [nameSpaceUID, exportFormat, payload, getExport, loadingGroup]);\n\n  if (exportData.isLoading) {\n    return <LoadingPlaceholder text=\"Loading....\" />;\n  }\n\n  const downloadFileName = `modify-export-${payload.name}-${uid}-${new Date().getTime()}`;\n\n  return (\n    <FileExportPreview\n      format={exportFormat}\n      textDefinition={exportData.data ?? ''}\n      downloadFileName={downloadFileName}\n      onClose={onClose}\n    />\n  );\n};\n\ninterface GrafanaRuleDesignExporterProps {\n  onClose: () => void;\n  exportValues: RuleFormValues;\n  uid: string;\n}\n\nexport const GrafanaRuleDesignExporter = memo(({ onClose, exportValues, uid }: GrafanaRuleDesignExporterProps) => {\n  const [activeTab, setActiveTab] = useState<ExportFormats>('yaml');\n\n  return (\n    <GrafanaExportDrawer\n      title={'Export Group'}\n      activeTab={activeTab}\n      onTabChange={setActiveTab}\n      onClose={onClose}\n      formatProviders={Object.values(allGrafanaExportProviders)}\n    >\n      <GrafanaRuleDesignExportPreview\n        exportFormat={activeTab}\n        onClose={onClose}\n        exportValues={exportValues}\n        uid={uid}\n      />\n    </GrafanaExportDrawer>\n  );\n});\n\nGrafanaRuleDesignExporter.displayName = 'GrafanaRuleDesignExporter';\n","import * as React from 'react';\nimport { useMemo } from 'react';\nimport { useParams } from 'react-router-dom-v5-compat';\n\nimport { locationService } from '@grafana/runtime';\nimport { Alert, LoadingPlaceholder } from '@grafana/ui';\n\nimport { RuleIdentifier } from '../../../../../types/unified-alerting';\nimport { useRuleWithLocation } from '../../hooks/useCombinedRule';\nimport { stringifyErrorLike } from '../../utils/misc';\nimport { formValuesFromExistingRule } from '../../utils/rule-form';\nimport * as ruleId from '../../utils/rule-id';\nimport { isGrafanaRulerRule } from '../../utils/rules';\nimport { createRelativeUrl } from '../../utils/url';\nimport { AlertingPageWrapper } from '../AlertingPageWrapper';\nimport { ModifyExportRuleForm } from '../rule-editor/alert-rule-form/ModifyExportRuleForm';\n\nexport default function GrafanaModifyExport() {\n  const { id } = useParams();\n  const ruleIdentifier = useMemo<RuleIdentifier | undefined>(() => {\n    return ruleId.tryParse(id, true);\n  }, [id]);\n\n  if (!ruleIdentifier) {\n    return (\n      <ModifyExportWrapper>\n        <Alert title=\"Invalid rule ID\" severity=\"error\">\n          The rule UID in the page URL is invalid. Please check the URL and try again.\n        </Alert>\n      </ModifyExportWrapper>\n    );\n  }\n\n  return (\n    <ModifyExportWrapper>\n      <RuleModifyExport ruleIdentifier={ruleIdentifier} />\n    </ModifyExportWrapper>\n  );\n}\n\ninterface ModifyExportWrapperProps {\n  children: React.ReactNode;\n}\n\nfunction ModifyExportWrapper({ children }: ModifyExportWrapperProps) {\n  return (\n    <AlertingPageWrapper\n      navId=\"alert-list\"\n      pageNav={{\n        text: 'Modify export',\n        subTitle:\n          'Modify the current alert rule and export the rule definition in the format of your choice. Any changes you make will not be saved.',\n      }}\n    >\n      {children}\n    </AlertingPageWrapper>\n  );\n}\n\nfunction RuleModifyExport({ ruleIdentifier }: { ruleIdentifier: RuleIdentifier }) {\n  const { loading, error, result: rulerRule } = useRuleWithLocation({ ruleIdentifier: ruleIdentifier });\n\n  if (loading) {\n    return <LoadingPlaceholder text=\"Loading the rule...\" />;\n  }\n\n  if (error) {\n    return (\n      <Alert title=\"Cannot load modify export\" severity=\"error\">\n        {stringifyErrorLike(error)}\n      </Alert>\n    );\n  }\n\n  if (!rulerRule && !loading) {\n    // alert rule does not exist\n    return (\n      <Alert\n        title=\"Cannot load the rule. The rule does not exist\"\n        buttonContent=\"Go back to alert list\"\n        onRemove={() => locationService.replace(createRelativeUrl('/alerting/list'))}\n      />\n    );\n  }\n\n  if (rulerRule && !isGrafanaRulerRule(rulerRule.rule)) {\n    // alert rule exists but is not a grafana-managed rule\n    return (\n      <Alert\n        title=\"This rule is not a Grafana-managed alert rule\"\n        buttonContent=\"Go back to alert list\"\n        onRemove={() => locationService.replace(createRelativeUrl('/alerting/list'))}\n      />\n    );\n  }\n\n  if (rulerRule && isGrafanaRulerRule(rulerRule.rule)) {\n    return (\n      <ModifyExportRuleForm\n        ruleForm={formValuesFromExistingRule(rulerRule)}\n        alertUid={rulerRule.rule.grafana_alert.uid}\n      />\n    );\n  }\n\n  return <Alert title=\"Unknown error\" />;\n}\n","import { useFormContext } from 'react-hook-form';\n\nimport { selectors } from '@grafana/e2e-selectors';\nimport { Field, Input, Stack, Text } from '@grafana/ui';\n\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { isCloudRecordingRuleByType, isGrafanaRecordingRuleByType, isRecordingRuleByType } from '../../utils/rules';\n\nimport { RuleEditorSection } from './RuleEditorSection';\n\nconst recordingRuleNameValidationPattern = (type: RuleFormType) => ({\n  message: isGrafanaRecordingRuleByType(type)\n    ? 'Recording rule metric must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.'\n    : 'Recording rule name must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.',\n  value: /^[a-zA-Z_:][a-zA-Z0-9_:]*$/,\n});\n\n/**\n *  This component renders the input for the alert rule name.\n *  In case of recording rule, it also renders the input for the recording rule metric, and it validates this value.\n */\nexport const AlertRuleNameAndMetric = () => {\n  const {\n    register,\n    watch,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  const ruleFormType = watch('type');\n  if (!ruleFormType) {\n    return null;\n  }\n  const isRecording = isRecordingRuleByType(ruleFormType);\n  const isGrafanaRecordingRule = isGrafanaRecordingRuleByType(ruleFormType);\n  const isCloudRecordingRule = isCloudRecordingRuleByType(ruleFormType);\n  const recordingLabel = isGrafanaRecordingRule ? 'recording rule and metric' : 'recording rule';\n  const namePlaceholder = isRecording ? 'recording rule' : 'alert rule';\n  const entityName = isRecording ? recordingLabel : 'alert rule';\n  return (\n    <RuleEditorSection\n      stepNo={1}\n      title={`Enter ${entityName} name`}\n      description={\n        <Text variant=\"bodySmall\" color=\"secondary\">\n          Enter a name to identify your {entityName}.\n        </Text>\n      }\n    >\n      <Stack direction=\"column\">\n        <Field label=\"Name\" error={errors?.name?.message} invalid={!!errors.name?.message}>\n          <Input\n            data-testid={selectors.components.AlertRules.ruleNameField}\n            id=\"name\"\n            width={38}\n            {...register('name', {\n              required: { value: true, message: 'Must enter a name' },\n              pattern: isCloudRecordingRule\n                ? recordingRuleNameValidationPattern(RuleFormType.cloudRecording)\n                : undefined,\n            })}\n            aria-label=\"name\"\n            placeholder={`Give your ${namePlaceholder} a name`}\n          />\n        </Field>\n        {isGrafanaRecordingRule && (\n          <Field label=\"Metric\" error={errors?.metric?.message} invalid={!!errors.metric?.message}>\n            <Input\n              id=\"metric\"\n              width={38}\n              {...register('metric', {\n                required: { value: true, message: 'Must enter a metric name' },\n                pattern: recordingRuleNameValidationPattern(RuleFormType.grafanaRecording),\n              })}\n              aria-label=\"metric\"\n              placeholder={`Give your metric a name`}\n            />\n          </Field>\n        )}\n      </Stack>\n    </RuleEditorSection>\n  );\n};\n","import { Stack } from '@grafana/ui';\n\nimport { ContactPointReceiverTitleRow } from '../../../../contact-points/ContactPoint';\nimport { RECEIVER_META_KEY, RECEIVER_PLUGIN_META_KEY } from '../../../../contact-points/constants';\nimport { ReceiverConfigWithMetadata, getReceiverDescription } from '../../../../contact-points/utils';\n\ninterface ContactPointDetailsProps {\n  receivers: ReceiverConfigWithMetadata[];\n}\n\nexport const ContactPointDetails = ({ receivers }: ContactPointDetailsProps) => {\n  return (\n    <Stack direction=\"column\" gap={0}>\n      <div>\n        {receivers.map((receiver, index) => {\n          const metadata = receiver[RECEIVER_META_KEY];\n          const pluginMetadata = receiver[RECEIVER_PLUGIN_META_KEY];\n          const key = metadata.name + index;\n          return (\n            <ContactPointReceiverTitleRow\n              key={key}\n              name={metadata.name}\n              type={receiver.type}\n              description={getReceiverDescription(receiver)}\n              pluginMetadata={pluginMetadata}\n            />\n          );\n        })}\n      </div>\n    </Stack>\n  );\n};\n","import { useCallback, useEffect } from 'react';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { SelectableValue } from '@grafana/data';\nimport { ActionMeta, Field, FieldValidationMessage, Stack, TextLink } from '@grafana/ui';\nimport { ContactPointSelector as ContactPointSelectorDropdown } from 'app/features/alerting/unified/components/notification-policies/ContactPointSelector';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { createRelativeUrl } from 'app/features/alerting/unified/utils/url';\n\nimport { ContactPointWithMetadata } from '../../../../contact-points/utils';\n\nexport interface ContactPointSelectorProps {\n  alertManager: string;\n  onSelectContactPoint: (contactPoint?: ContactPointWithMetadata) => void;\n}\n\nexport function ContactPointSelector({ alertManager, onSelectContactPoint }: ContactPointSelectorProps) {\n  const { control, watch, trigger } = useFormContext<RuleFormValues>();\n\n  const contactPointInForm = watch(`contactPoints.${alertManager}.selectedContactPoint`);\n\n  // if we have a contact point selected, check if it still exists in the event that someone has deleted it\n  const validateContactPoint = useCallback(() => {\n    if (contactPointInForm) {\n      trigger(`contactPoints.${alertManager}.selectedContactPoint`, { shouldFocus: true });\n    }\n  }, [alertManager, contactPointInForm, trigger]);\n\n  // validate the contact point and check if it still exists when mounting the component\n  useEffect(() => {\n    validateContactPoint();\n  }, [validateContactPoint]);\n\n  return (\n    <Stack direction=\"column\">\n      <Stack direction=\"row\" alignItems=\"center\">\n        <Field label=\"Contact point\" data-testid=\"contact-point-picker\">\n          <Controller\n            render={({ field: { onChange }, fieldState: { error } }) => (\n              <>\n                <Stack>\n                  <ContactPointSelectorDropdown\n                    selectProps={{\n                      onChange: (value: SelectableValue<ContactPointWithMetadata>, _: ActionMeta) => {\n                        onChange(value?.value?.name);\n                        onSelectContactPoint(value?.value);\n                      },\n                      width: 50,\n                    }}\n                    showRefreshButton\n                    selectedContactPointName={contactPointInForm}\n                  />\n                  <LinkToContactPoints />\n                </Stack>\n\n                {/* Error can come from the required validation we have in here, or from the manual setError we do in the parent component.\n                The only way I found to check the custom error is to check if the field has a value and if it's not in the options. */}\n\n                {error && <FieldValidationMessage>{error?.message}</FieldValidationMessage>}\n              </>\n            )}\n            rules={{\n              required: {\n                value: true,\n                message: 'Contact point is required.',\n              },\n            }}\n            control={control}\n            name={`contactPoints.${alertManager}.selectedContactPoint`}\n          />\n        </Field>\n      </Stack>\n    </Stack>\n  );\n}\nfunction LinkToContactPoints() {\n  const hrefToContactPoints = '/alerting/notifications';\n  return (\n    <TextLink external href={createRelativeUrl(hrefToContactPoints)} aria-label=\"View or create contact points\">\n      View or create contact points\n    </TextLink>\n  );\n}\n","import { useFormContext, Controller } from 'react-hook-form';\n\nimport { Field } from '@grafana/ui';\nimport MuteTimingsSelector from 'app/features/alerting/unified/components/alertmanager-entities/MuteTimingsSelector';\nimport { BaseAlertmanagerArgs } from 'app/features/alerting/unified/types/hooks';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { mapMultiSelectValueToStrings } from 'app/features/alerting/unified/utils/amroutes';\n\n/** Provides a form field for use in simplified routing, for selecting appropriate mute timings */\nexport function MuteTimingFields({ alertmanager }: BaseAlertmanagerArgs) {\n  const {\n    control,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  return (\n    <Field\n      label=\"Mute timings\"\n      data-testid=\"am-mute-timing-select\"\n      description=\"Select a mute timing to define when not to send notifications for this alert rule\"\n      invalid={!!errors.contactPoints?.[alertmanager]?.muteTimeIntervals}\n    >\n      <Controller\n        render={({ field: { onChange, ref, ...field } }) => (\n          <MuteTimingsSelector\n            alertmanager={alertmanager}\n            selectProps={{\n              ...field,\n              onChange: (value) => onChange(mapMultiSelectValueToStrings(value)),\n            }}\n          />\n        )}\n        control={control}\n        name={`contactPoints.${alertmanager}.muteTimeIntervals`}\n      />\n    </Field>\n  );\n}\n","import { useFormContext } from 'react-hook-form';\n\nimport { Field, useStyles2 } from '@grafana/ui';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { promDurationValidator, repeatIntervalValidator } from 'app/features/alerting/unified/utils/amroutes';\n\nimport { PromDurationInput } from '../../../../notification-policies/PromDurationInput';\nimport { getFormStyles } from '../../../../notification-policies/formStyles';\nimport { routeTimingsFields } from '../../../../notification-policies/routeTimingsFields';\nimport { TIMING_OPTIONS_DEFAULTS } from '../../../../notification-policies/timingOptions';\n\ninterface RouteTimingsProps {\n  alertManager: string;\n}\n\nexport function RouteTimings({ alertManager }: RouteTimingsProps) {\n  const formStyles = useStyles2(getFormStyles);\n  const {\n    register,\n    formState: { errors },\n    getValues,\n  } = useFormContext<RuleFormValues>();\n  return (\n    <>\n      <Field\n        label={routeTimingsFields.groupWait.label}\n        description={routeTimingsFields.groupWait.description}\n        invalid={!!errors.contactPoints?.[alertManager]?.groupWaitValue}\n        error={errors.contactPoints?.[alertManager]?.groupWaitValue?.message}\n      >\n        <PromDurationInput\n          {...register(`contactPoints.${alertManager}.groupWaitValue`, { validate: promDurationValidator })}\n          aria-label={routeTimingsFields.groupWait.ariaLabel}\n          className={formStyles.promDurationInput}\n          placeholder={TIMING_OPTIONS_DEFAULTS.group_wait}\n        />\n      </Field>\n      <Field\n        label={routeTimingsFields.groupInterval.label}\n        description={routeTimingsFields.groupInterval.description}\n        invalid={!!errors.contactPoints?.[alertManager]?.groupIntervalValue}\n        error={errors.contactPoints?.[alertManager]?.groupIntervalValue?.message}\n      >\n        <PromDurationInput\n          {...register(`contactPoints.${alertManager}.groupIntervalValue`, {\n            validate: promDurationValidator,\n          })}\n          aria-label={routeTimingsFields.groupInterval.ariaLabel}\n          className={formStyles.promDurationInput}\n          placeholder={TIMING_OPTIONS_DEFAULTS.group_interval}\n        />\n      </Field>\n      <Field\n        label={routeTimingsFields.repeatInterval.label}\n        description={routeTimingsFields.repeatInterval.description}\n        invalid={!!errors.contactPoints?.[alertManager]?.repeatIntervalValue}\n        error={errors.contactPoints?.[alertManager]?.repeatIntervalValue?.message}\n      >\n        <PromDurationInput\n          {...register(`contactPoints.${alertManager}.repeatIntervalValue`, {\n            validate: (value: string) => {\n              const groupInterval = getValues(`contactPoints.${alertManager}.repeatIntervalValue`);\n              return repeatIntervalValidator(value, groupInterval);\n            },\n          })}\n          aria-label={routeTimingsFields.repeatInterval.ariaLabel}\n          className={formStyles.promDurationInput}\n          placeholder={TIMING_OPTIONS_DEFAULTS.repeat_interval}\n        />\n      </Field>\n    </>\n  );\n}\n","import { css } from '@emotion/css';\nimport { useEffect, useState } from 'react';\nimport * as React from 'react';\nimport { useFormContext, Controller } from 'react-hook-form';\n\nimport { GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { Field, FieldValidationMessage, InlineField, MultiSelect, Stack, Switch, Text, useStyles2 } from '@grafana/ui';\nimport { MultiValueRemove, MultiValueRemoveProps } from '@grafana/ui/src/components/Select/MultiValue';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport {\n  commonGroupByOptions,\n  mapMultiSelectValueToStrings,\n  stringToSelectableValue,\n  stringsToSelectableValues,\n} from 'app/features/alerting/unified/utils/amroutes';\n\nimport { getFormStyles } from '../../../../notification-policies/formStyles';\nimport { TIMING_OPTIONS_DEFAULTS } from '../../../../notification-policies/timingOptions';\n\nimport { RouteTimings } from './RouteTimings';\n\nconst REQUIRED_FIELDS_IN_GROUPBY = ['grafana_folder', 'alertname'];\n\nconst DEFAULTS_TIMINGS = {\n  groupWaitValue: TIMING_OPTIONS_DEFAULTS.group_wait,\n  groupIntervalValue: TIMING_OPTIONS_DEFAULTS.group_interval,\n  repeatIntervalValue: TIMING_OPTIONS_DEFAULTS.repeat_interval,\n};\nconst DISABLE_GROUPING = '...';\n\nexport interface RoutingSettingsProps {\n  alertManager: string;\n}\nexport const RoutingSettings = ({ alertManager }: RoutingSettingsProps) => {\n  const formStyles = useStyles2(getFormStyles);\n  const {\n    control,\n    watch,\n    register,\n    setValue,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n  const [groupByOptions, setGroupByOptions] = useState(stringsToSelectableValues([]));\n  const { groupIntervalValue, groupWaitValue, repeatIntervalValue } = DEFAULTS_TIMINGS;\n  const overrideGrouping = watch(`contactPoints.${alertManager}.overrideGrouping`);\n  const overrideTimings = watch(`contactPoints.${alertManager}.overrideTimings`);\n  const groupByCount = watch(`contactPoints.${alertManager}.groupBy`)?.length ?? 0;\n\n  const styles = useStyles2(getStyles);\n  useEffect(() => {\n    if (overrideGrouping && groupByCount === 0) {\n      setValue(`contactPoints.${alertManager}.groupBy`, REQUIRED_FIELDS_IN_GROUPBY);\n    }\n  }, [overrideGrouping, setValue, alertManager, groupByCount]);\n\n  return (\n    <Stack direction=\"column\">\n      <Stack direction=\"row\" gap={1} alignItems=\"center\" justifyContent=\"space-between\">\n        <InlineField label=\"Override grouping\" transparent={true} className={styles.switchElement}>\n          <Switch id=\"override-grouping-toggle\" {...register(`contactPoints.${alertManager}.overrideGrouping`)} />\n        </InlineField>\n        {!overrideGrouping && (\n          <Text variant=\"body\" color=\"secondary\">\n            Grouping: <strong>{REQUIRED_FIELDS_IN_GROUPBY.join(', ')}</strong>\n          </Text>\n        )}\n      </Stack>\n      {overrideGrouping && (\n        <Field\n          label=\"Group by\"\n          description=\"Combine multiple alerts into a single notification by grouping them by the same label values. If empty, it is inherited from the default notification policy.\"\n          {...register(`contactPoints.${alertManager}.groupBy`)}\n          invalid={!!errors.contactPoints?.[alertManager]?.groupBy}\n          className={styles.optionalContent}\n        >\n          <Controller\n            rules={{\n              validate: (value: string[]) => {\n                if (!value || value.length === 0) {\n                  return 'At least one group by option is required.';\n                }\n                if (value.length === 1 && value[0] === DISABLE_GROUPING) {\n                  return true;\n                }\n                // we need to make sure that the required fields are included\n                const requiredFieldsIncluded = REQUIRED_FIELDS_IN_GROUPBY.every((field) => value.includes(field));\n                if (!requiredFieldsIncluded) {\n                  return `Group by must include ${REQUIRED_FIELDS_IN_GROUPBY.join(', ')}`;\n                }\n                return true;\n              },\n            }}\n            render={({ field: { onChange, ref, ...field }, fieldState: { error } }) => (\n              <>\n                <MultiSelect\n                  aria-label=\"Group by\"\n                  {...field}\n                  allowCustomValue\n                  className={formStyles.input}\n                  onCreateOption={(opt: string) => {\n                    setGroupByOptions((opts) => [...opts, stringToSelectableValue(opt)]);\n\n                    // @ts-ignore-check: react-hook-form made me do this\n                    setValue(`contactPoints.${alertManager}.groupBy`, [...field.value, opt]);\n                  }}\n                  onChange={(value) => {\n                    return onChange(mapMultiSelectValueToStrings(value));\n                  }}\n                  options={[...commonGroupByOptions, ...groupByOptions]}\n                  components={{\n                    MultiValueRemove(\n                      props: React.PropsWithChildren<\n                        MultiValueRemoveProps &\n                          Array<SelectableValue<string>> & {\n                            data: {\n                              label: string;\n                              value: string;\n                              isFixed: boolean;\n                            };\n                          }\n                      >\n                    ) {\n                      const { data } = props;\n                      if (data.isFixed) {\n                        return null;\n                      }\n                      return MultiValueRemove(props);\n                    },\n                  }}\n                />\n                {error && <FieldValidationMessage>{error.message}</FieldValidationMessage>}\n              </>\n            )}\n            name={`contactPoints.${alertManager}.groupBy`}\n            control={control}\n          />\n        </Field>\n      )}\n      <Stack direction=\"row\" gap={1} alignItems=\"center\" justifyContent=\"space-between\">\n        <InlineField label=\"Override timings\" transparent={true} className={styles.switchElement}>\n          <Switch id=\"override-timings-toggle\" {...register(`contactPoints.${alertManager}.overrideTimings`)} />\n        </InlineField>\n        {!overrideTimings && (\n          <Text variant=\"body\" color=\"secondary\">\n            Group wait: <strong>{groupWaitValue}, </strong>\n            Group interval: <strong>{groupIntervalValue}, </strong>\n            Repeat interval: <strong>{repeatIntervalValue}</strong>\n          </Text>\n        )}\n      </Stack>\n      {overrideTimings && (\n        <div className={styles.optionalContent}>\n          <RouteTimings alertManager={alertManager} />\n        </div>\n      )}\n    </Stack>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  switchElement: css({\n    flexFlow: 'row-reverse',\n    gap: theme.spacing(1),\n    alignItems: 'center',\n  }),\n  optionalContent: css({\n    marginLeft: '49px',\n    marginBottom: theme.spacing(1),\n  }),\n});\n","import { css } from '@emotion/css';\nimport { useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { CollapsableSection, Stack, useStyles2 } from '@grafana/ui';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { AlertManagerDataSource } from 'app/features/alerting/unified/utils/datasource';\n\nimport { ContactPointWithMetadata } from '../../../contact-points/utils';\n\nimport { ContactPointDetails } from './contactPoint/ContactPointDetails';\nimport { ContactPointSelector } from './contactPoint/ContactPointSelector';\nimport { MuteTimingFields } from './route-settings/MuteTimingFields';\nimport { RoutingSettings } from './route-settings/RouteSettings';\n\ninterface AlertManagerManualRoutingProps {\n  alertManager: AlertManagerDataSource;\n}\n\nexport function AlertManagerManualRouting({ alertManager }: AlertManagerManualRoutingProps) {\n  const styles = useStyles2(getStyles);\n\n  const alertManagerName = alertManager.name;\n\n  const [selectedContactPointWithMetadata, setSelectedContactPointWithMetadata] = useState<\n    ContactPointWithMetadata | undefined\n  >();\n\n  const onSelectContactPoint = (contactPoint?: ContactPointWithMetadata) => {\n    setSelectedContactPointWithMetadata(contactPoint);\n  };\n\n  const { watch } = useFormContext<RuleFormValues>();\n  const hasRouteSettings =\n    watch(`contactPoints.${alertManagerName}.overrideGrouping`) ||\n    watch(`contactPoints.${alertManagerName}.overrideTimings`) ||\n    watch(`contactPoints.${alertManagerName}.muteTimeIntervals`)?.length > 0;\n\n  return (\n    <Stack direction=\"column\">\n      <Stack direction=\"row\" alignItems=\"center\">\n        <div className={styles.firstAlertManagerLine}></div>\n        <div className={styles.alertManagerName}>\n          Alertmanager:\n          <img src={alertManager.imgUrl} alt=\"Alert manager logo\" className={styles.img} />\n          {alertManagerName}\n        </div>\n        <div className={styles.secondAlertManagerLine}></div>\n      </Stack>\n      <Stack direction=\"row\" gap={1} alignItems=\"center\">\n        <ContactPointSelector alertManager={alertManagerName} onSelectContactPoint={onSelectContactPoint} />\n      </Stack>\n      {selectedContactPointWithMetadata?.grafana_managed_receiver_configs && (\n        <ContactPointDetails receivers={selectedContactPointWithMetadata.grafana_managed_receiver_configs} />\n      )}\n      <div className={styles.routingSection}>\n        <CollapsableSection\n          label=\"Muting, grouping and timings (optional)\"\n          isOpen={hasRouteSettings}\n          className={styles.collapsableSection}\n        >\n          <Stack direction=\"column\" gap={1}>\n            <MuteTimingFields alertmanager={alertManagerName} />\n            <RoutingSettings alertManager={alertManagerName} />\n          </Stack>\n        </CollapsableSection>\n      </div>\n    </Stack>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  firstAlertManagerLine: css({\n    height: 1,\n    width: theme.spacing(4),\n    backgroundColor: theme.colors.secondary.main,\n  }),\n  alertManagerName: css({\n    with: 'fit-content',\n  }),\n  secondAlertManagerLine: css({\n    height: '1px',\n    width: '100%',\n    flex: 1,\n    backgroundColor: theme.colors.secondary.main,\n  }),\n  img: css({\n    marginLeft: theme.spacing(2),\n    width: theme.spacing(3),\n    height: theme.spacing(3),\n    marginRight: theme.spacing(1),\n  }),\n  collapsableSection: css({\n    width: 'fit-content',\n    fontSize: theme.typography.body.fontSize,\n  }),\n  routingSection: css({\n    display: 'flex',\n    flexDirection: 'column',\n    maxWidth: theme.breakpoints.values.xl,\n    border: `solid 1px ${theme.colors.border.weak}`,\n    borderRadius: theme.shape.radius.default,\n    padding: `${theme.spacing(1)} ${theme.spacing(2)}`,\n    marginTop: theme.spacing(2),\n  }),\n});\n","import { useMemo } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { AlertmanagerProvider } from 'app/features/alerting/unified/state/AlertmanagerContext';\nimport { RuleFormValues } from 'app/features/alerting/unified/types/rule-form';\nimport { getAlertManagerDataSourcesByPermission } from 'app/features/alerting/unified/utils/datasource';\n\nimport { AlertManagerManualRouting } from './AlertManagerRouting';\n\nexport function SimplifiedRouting() {\n  const { getValues } = useFormContext<RuleFormValues>();\n  const contactPointsInAlert = getValues('contactPoints');\n\n  const allAlertManagersByPermission = getAlertManagerDataSourcesByPermission('notification');\n\n  // We decided to only show internal alert manager for now. Once we want to show external alert managers we can use this code\n  // const alertManagersDataSources = allAlertManagersByPermission.availableInternalDataSources.concat(\n  //   allAlertManagersByPermission.availableExternalDataSources\n  // );\n\n  const alertManagersDataSources = allAlertManagersByPermission.availableInternalDataSources;\n\n  const alertManagersDataSourcesWithConfigAPI = alertManagersDataSources.filter((am) => am.hasConfigurationAPI);\n\n  // we merge the selected contact points data for each alert manager, with the alert manager meta data\n  const alertManagersWithSelectedContactPoints = useMemo(\n    () =>\n      alertManagersDataSourcesWithConfigAPI.map((am) => {\n        const selectedContactPoint = contactPointsInAlert ? contactPointsInAlert[am.name] : undefined;\n        return {\n          alertManager: am,\n          selectedContactPoint: selectedContactPoint?.selectedContactPoint ?? '',\n          routeSettings: {\n            muteTimeIntervals: selectedContactPoint?.muteTimeIntervals ?? [],\n            overrideGrouping: selectedContactPoint?.overrideGrouping ?? false,\n            groupBy: selectedContactPoint?.groupBy ?? [],\n            overrideTimings: selectedContactPoint?.overrideTimings ?? false,\n            groupWaitValue: selectedContactPoint?.groupWaitValue ?? '',\n            groupIntervalValue: selectedContactPoint?.groupIntervalValue ?? '',\n            repeatIntervalValue: selectedContactPoint?.repeatIntervalValue ?? '',\n          },\n        };\n      }),\n    [alertManagersDataSourcesWithConfigAPI, contactPointsInAlert]\n  );\n\n  return alertManagersWithSelectedContactPoints.map((alertManagerContactPoint, index) => {\n    return (\n      <AlertmanagerProvider\n        accessType={'notification'}\n        alertmanagerSourceName={alertManagerContactPoint.alertManager.name}\n        key={alertManagerContactPoint.alertManager.name + index}\n      >\n        <AlertManagerManualRouting alertManager={alertManagerContactPoint.alertManager} />\n      </AlertmanagerProvider>\n    );\n  });\n}\n","import { Modal } from '@grafana/ui';\n\nimport { LabelsSubForm } from './LabelsField';\n\nexport interface LabelsEditorModalProps {\n  isOpen: boolean;\n  initialLabels: Array<{\n    key: string;\n    value: string;\n  }>;\n  onClose: (\n    labelsToUodate?: Array<{\n      key: string;\n      value: string;\n    }>\n  ) => void;\n  dataSourceName: string;\n}\nexport function LabelsEditorModal({ isOpen, onClose, dataSourceName, initialLabels }: LabelsEditorModalProps) {\n  return (\n    <Modal title=\"Edit labels\" closeOnEscape isOpen={isOpen} onDismiss={() => onClose()}>\n      <LabelsSubForm dataSourceName={dataSourceName} onClose={onClose} initialLabels={initialLabels} />\n    </Modal>\n  );\n}\n","import { useFormContext } from 'react-hook-form';\n\nimport { Button, Stack, Text } from '@grafana/ui';\n\nimport { RuleFormValues } from '../../../types/rule-form';\nimport { NeedHelpInfo } from '../NeedHelpInfo';\n\nimport { LabelsInRule } from './LabelsField';\n\ninterface LabelsFieldInFormProps {\n  onEditClick: () => void;\n}\nexport function LabelsFieldInForm({ onEditClick }: LabelsFieldInFormProps) {\n  const { watch } = useFormContext<RuleFormValues>();\n  const labels = watch('labels');\n  const hasLabels = Object.keys(labels).length > 0 && labels.some((label) => label.key || label.value);\n\n  return (\n    <Stack direction=\"column\" gap={2}>\n      <Stack direction=\"column\" gap={1}>\n        <Text element=\"h5\">Labels</Text>\n        <Stack direction={'row'} gap={1}>\n          <Text variant=\"bodySmall\" color=\"secondary\">\n            Add labels to your rule for searching, silencing, or routing to a notification policy.\n          </Text>\n          <NeedHelpInfo\n            contentText=\"The dropdown only displays labels that you have previously used for alerts.\n              Select a label from the options below or type in a new one.\"\n            title=\"Labels\"\n          />\n        </Stack>\n      </Stack>\n      <Stack direction=\"row\" gap={1} alignItems=\"center\">\n        <LabelsInRule labels={labels} />\n        {hasLabels ? (\n          <Button variant=\"secondary\" type=\"button\" onClick={onEditClick} size=\"sm\">\n            Edit labels\n          </Button>\n        ) : (\n          <Stack direction=\"row\" gap={2} alignItems=\"center\">\n            <Text>No labels selected</Text>\n            <Button icon=\"plus\" type=\"button\" variant=\"secondary\" onClick={onEditClick} size=\"sm\">\n              Add labels\n            </Button>\n          </Stack>\n        )}\n      </Stack>\n    </Stack>\n  );\n}\n","import { css } from '@emotion/css';\nimport { compact } from 'lodash';\nimport { lazy, Suspense } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Button, LoadingPlaceholder, Text, useStyles2 } from '@grafana/ui';\nimport { alertRuleApi } from 'app/features/alerting/unified/api/alertRuleApi';\nimport { Stack } from 'app/plugins/datasource/parca/QueryEditor/Stack';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { useGetAlertManagerDataSourcesByPermissionAndConfig } from '../../../utils/datasource';\nimport { Folder } from '../RuleFolderPicker';\n\nconst NotificationPreviewByAlertManager = lazy(() => import('./NotificationPreviewByAlertManager'));\n\ninterface NotificationPreviewProps {\n  customLabels: Array<{\n    key: string;\n    value: string;\n  }>;\n  alertQueries: AlertQuery[];\n  condition: string | null;\n  folder: Folder | null;\n  alertName?: string;\n  alertUid?: string;\n}\n\n// TODO the scroll position keeps resetting when we preview\n// this is to be expected because the list of routes dissapears as we start the request but is very annoying\nexport const NotificationPreview = ({\n  alertQueries,\n  customLabels,\n  condition,\n  folder,\n  alertName,\n  alertUid,\n}: NotificationPreviewProps) => {\n  const styles = useStyles2(getStyles);\n  const disabled = !condition || !folder;\n\n  const previewEndpoint = alertRuleApi.endpoints.preview;\n\n  const [trigger, { data = [], isLoading, isUninitialized: previewUninitialized }] = previewEndpoint.useMutation();\n\n  // potential instances are the instances that are going to be routed to the notification policies\n  // convert data to list of labels: are the representation of the potential instances\n  const potentialInstances = compact(data.flatMap((label) => label?.labels));\n\n  const onPreview = () => {\n    if (!folder || !condition) {\n      return;\n    }\n\n    // Get the potential labels given the alert queries, the condition and the custom labels (autogenerated labels are calculated on the BE side)\n    trigger({\n      alertQueries: alertQueries,\n      condition: condition,\n      customLabels: customLabels,\n      folder: folder,\n      alertName: alertName,\n      alertUid: alertUid,\n    });\n  };\n\n  //  Get alert managers's data source information\n  const alertManagerDataSources = useGetAlertManagerDataSourcesByPermissionAndConfig('notification');\n\n  const onlyOneAM = alertManagerDataSources.length === 1;\n\n  return (\n    <Stack direction=\"column\">\n      <div className={styles.routePreviewHeaderRow}>\n        <div className={styles.previewHeader}>\n          <Text element=\"h5\">Alert instance routing preview</Text>\n          {isLoading && previewUninitialized && (\n            <Text color=\"secondary\" variant=\"bodySmall\">\n              Loading...\n            </Text>\n          )}\n          {previewUninitialized ? (\n            <Text color=\"secondary\" variant=\"bodySmall\">\n              When you have your folder selected and your query and labels are configured, click &quot;Preview\n              routing&quot; to see the results here.\n            </Text>\n          ) : (\n            <Text color=\"secondary\" variant=\"bodySmall\">\n              Based on the labels added, alert instances are routed to the following notification policies. Expand each\n              notification policy below to view more details.\n            </Text>\n          )}\n        </div>\n        <div className={styles.button}>\n          <Button icon=\"sync\" variant=\"secondary\" type=\"button\" onClick={onPreview} disabled={disabled}>\n            Preview routing\n          </Button>\n        </div>\n      </div>\n      {!isLoading && !previewUninitialized && potentialInstances.length > 0 && (\n        <Suspense fallback={<LoadingPlaceholder text=\"Loading preview...\" />}>\n          {alertManagerDataSources.map((alertManagerSource) => (\n            <NotificationPreviewByAlertManager\n              alertManagerSource={alertManagerSource}\n              potentialInstances={potentialInstances}\n              onlyOneAM={onlyOneAM}\n              key={alertManagerSource.name}\n            />\n          ))}\n        </Suspense>\n      )}\n    </Stack>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  collapsableSection: css({\n    width: 'auto',\n    border: 0,\n  }),\n  previewHeader: css({\n    margin: 0,\n  }),\n  routePreviewHeaderRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'flex-start',\n    marginTop: theme.spacing(1),\n  }),\n  collapseLabel: css({\n    flex: 1,\n  }),\n  button: css({\n    justifyContent: 'flex-end',\n  }),\n  tagsInDetails: css({\n    display: 'flex',\n    justifyContent: 'flex-start',\n    flexWrap: 'wrap',\n  }),\n  policyPathItemMatchers: css({\n    display: 'flex',\n    flexDirection: 'row',\n    gap: theme.spacing(1),\n  }),\n});\n","import { css } from '@emotion/css';\nimport { useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport { Icon, RadioButtonGroup, Stack, Text, useStyles2 } from '@grafana/ui';\nimport { AlertmanagerChoice } from 'app/plugins/datasource/alertmanager/types';\n\nimport { alertmanagerApi } from '../../api/alertmanagerApi';\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../../utils/datasource';\nimport { isRecordingRuleByType } from '../../utils/rules';\n\nimport { NeedHelpInfo } from './NeedHelpInfo';\nimport { RuleEditorSection } from './RuleEditorSection';\nimport { SimplifiedRouting } from './alert-rule-form/simplifiedRouting/SimplifiedRouting';\nimport { LabelsEditorModal } from './labels/LabelsEditorModal';\nimport { LabelsFieldInForm } from './labels/LabelsFieldInForm';\nimport { NotificationPreview } from './notificaton-preview/NotificationPreview';\n\ntype NotificationsStepProps = {\n  alertUid?: string;\n};\n\nenum RoutingOptions {\n  NotificationPolicy = 'notification policy',\n  ContactPoint = 'contact point',\n}\n\nfunction useHasInternalAlertmanagerEnabled() {\n  const { useGetGrafanaAlertingConfigurationStatusQuery } = alertmanagerApi;\n  const { currentData: amChoiceStatus } = useGetGrafanaAlertingConfigurationStatusQuery(undefined);\n  return (\n    amChoiceStatus?.alertmanagersChoice === AlertmanagerChoice.Internal ||\n    amChoiceStatus?.alertmanagersChoice === AlertmanagerChoice.All\n  );\n}\n\nexport const NotificationsStep = ({ alertUid }: NotificationsStepProps) => {\n  const { watch, getValues, setValue } = useFormContext<RuleFormValues>();\n  const styles = useStyles2(getStyles);\n\n  const [type] = watch(['type', 'labels', 'queries', 'condition', 'folder', 'name', 'manualRouting']);\n  const [showLabelsEditor, setShowLabelsEditor] = useState(false);\n\n  const dataSourceName = watch('dataSourceName') ?? GRAFANA_RULES_SOURCE_NAME;\n  const simplifiedRoutingToggleEnabled = config.featureToggles.alertingSimplifiedRouting ?? false;\n  const shouldRenderpreview = type === RuleFormType.grafana;\n  const hasInternalAlertmanagerEnabled = useHasInternalAlertmanagerEnabled();\n\n  const shouldAllowSimplifiedRouting =\n    type === RuleFormType.grafana && simplifiedRoutingToggleEnabled && hasInternalAlertmanagerEnabled;\n\n  function onCloseLabelsEditor(\n    labelsToUpdate?: Array<{\n      key: string;\n      value: string;\n    }>\n  ) {\n    if (labelsToUpdate) {\n      setValue('labels', labelsToUpdate);\n    }\n    setShowLabelsEditor(false);\n  }\n  if (!type) {\n    return null;\n  }\n\n  return (\n    <RuleEditorSection\n      stepNo={4}\n      title={isRecordingRuleByType(type) ? 'Add labels' : 'Configure labels and notifications'}\n      description={\n        <Stack direction=\"row\" gap={0.5} alignItems=\"center\">\n          {type === RuleFormType.cloudRecording ? (\n            <Text variant=\"bodySmall\" color=\"secondary\">\n              Add labels to help you better manage your recording rules\n            </Text>\n          ) : (\n            shouldAllowSimplifiedRouting && (\n              <Text variant=\"bodySmall\" color=\"secondary\">\n                Select who should receive a notification when an alert rule fires.\n              </Text>\n            )\n          )}\n        </Stack>\n      }\n      fullWidth\n    >\n      <LabelsFieldInForm onEditClick={() => setShowLabelsEditor(true)} />\n      <LabelsEditorModal\n        isOpen={showLabelsEditor}\n        onClose={onCloseLabelsEditor}\n        dataSourceName={dataSourceName}\n        initialLabels={getValues('labels')}\n      />\n      {shouldAllowSimplifiedRouting && (\n        <div className={styles.configureNotifications}>\n          <Text element=\"h5\">Notifications</Text>\n          <Text variant=\"bodySmall\" color=\"secondary\">\n            Select who should receive a notification when an alert rule fires.\n          </Text>\n        </div>\n      )}\n      {shouldAllowSimplifiedRouting ? ( // when simplified routing is enabled and is grafana rule\n        <ManualAndAutomaticRouting alertUid={alertUid} />\n      ) : // when simplified routing is not enabled, render the notification preview as we did before\n      shouldRenderpreview ? (\n        <AutomaticRooting alertUid={alertUid} />\n      ) : null}\n    </RuleEditorSection>\n  );\n};\n\n/**\n * Preconditions:\n * - simplified routing is enabled\n * - the alert rule is a grafana rule\n *\n * This component will render the switch between the select contact point routing and the notification policy routing.\n * It also renders the section body of the NotificationsStep, depending on the routing option selected.\n * If select contact point routing is selected, it will render the SimplifiedRouting component.\n * If notification policy routing is selected, it will render the AutomaticRouting component.\n *\n */\nfunction ManualAndAutomaticRouting({ alertUid }: { alertUid?: string }) {\n  const { watch, setValue } = useFormContext<RuleFormValues>();\n  const styles = useStyles2(getStyles);\n\n  const [manualRouting] = watch(['manualRouting']);\n\n  const routingOptions = [\n    { label: 'Select contact point', value: RoutingOptions.ContactPoint },\n    { label: 'Use notification policy', value: RoutingOptions.NotificationPolicy },\n  ];\n\n  const onRoutingOptionChange = (option: RoutingOptions) => {\n    setValue('manualRouting', option === RoutingOptions.ContactPoint);\n  };\n\n  return (\n    <Stack direction=\"column\" gap={2}>\n      <Stack direction=\"column\">\n        <RadioButtonGroup\n          options={routingOptions}\n          value={manualRouting ? RoutingOptions.ContactPoint : RoutingOptions.NotificationPolicy}\n          onChange={onRoutingOptionChange}\n          className={styles.routingOptions}\n        />\n      </Stack>\n\n      <RoutingOptionDescription manualRouting={manualRouting} />\n\n      {manualRouting ? <SimplifiedRouting /> : <AutomaticRooting alertUid={alertUid} />}\n    </Stack>\n  );\n}\n\ninterface AutomaticRootingProps {\n  alertUid?: string;\n}\n\nfunction AutomaticRooting({ alertUid }: AutomaticRootingProps) {\n  const { watch } = useFormContext<RuleFormValues>();\n  const [labels, queries, condition, folder, alertName] = watch([\n    'labels',\n    'queries',\n    'condition',\n    'folder',\n    'name',\n    'manualRouting',\n  ]);\n  return (\n    <NotificationPreview\n      alertQueries={queries}\n      customLabels={labels}\n      condition={condition}\n      folder={folder}\n      alertName={alertName}\n      alertUid={alertUid}\n    />\n  );\n}\n\n// Auxiliar components to build the texts and descriptions in the NotificationsStep\nfunction NeedHelpInfoForNotificationPolicy() {\n  return (\n    <NeedHelpInfo\n      contentText={\n        <Stack gap={1} direction=\"column\">\n          <Stack direction=\"column\" gap={0}>\n            <>\n              Firing alert instances are routed to notification policies based on matching labels. The default\n              notification policy matches all alert instances.\n            </>\n          </Stack>\n          <Stack direction=\"column\" gap={0}>\n            <>\n              Custom labels change the way your notifications are routed. First, add labels to your alert rule and then\n              connect them to your notification policy by adding label matchers.\n            </>\n            <a\n              href={`https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/notification-policies/`}\n              target=\"_blank\"\n              rel=\"noreferrer\"\n            >\n              <Text color=\"link\">\n                Read about notification policies. <Icon name=\"external-link-alt\" />\n              </Text>\n            </a>\n          </Stack>\n        </Stack>\n      }\n      title=\"Notification routing\"\n    />\n  );\n}\n\nfunction NeedHelpInfoForContactpoint() {\n  return (\n    <NeedHelpInfo\n      contentText={\n        <>\n          Select a contact point to notify all recipients in it.\n          <br />\n          <br />\n          Notifications for firing alert instances are grouped based on folder and alert rule name.\n          <br />\n          The wait time before sending the first notification for a new group of alerts is 30 seconds.\n          <br />\n          The waiting time before sending a notification about changes in the alert group after the first notification\n          has been sent is 5 minutes.\n          <br />\n          The wait time before resending a notification that has already been sent successfully is 4 hours.\n          <br />\n          Grouping and wait time values are defined in your default notification policy.\n        </>\n      }\n      externalLink=\"https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/\"\n      linkText=\"Read more about notifications\"\n      title=\"Notify contact points\"\n    />\n  );\n}\ninterface NotificationsStepDescriptionProps {\n  manualRouting: boolean;\n}\n\nexport const RoutingOptionDescription = ({ manualRouting }: NotificationsStepDescriptionProps) => {\n  return (\n    <Stack alignItems=\"center\">\n      <Text variant=\"bodySmall\" color=\"secondary\">\n        {manualRouting\n          ? 'Notifications for firing alerts are routed to a selected contact point.'\n          : 'Notifications for firing alerts are routed to contact points based on matching labels and the notification policy tree.'}\n      </Text>\n      {manualRouting ? <NeedHelpInfoForContactpoint /> : <NeedHelpInfoForNotificationPolicy />}\n    </Stack>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  routingOptions: css({\n    width: 'fit-content',\n  }),\n  configureNotifications: css({\n    display: 'flex',\n    flexDirection: 'column',\n    marginTop: theme.spacing(2),\n  }),\n});\n","import { PanelData } from '@grafana/data';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { RuleFormType } from './rule-form';\n\nexport type PreviewRuleRequest = GrafanaPreviewRuleRequest | CloudPreviewRuleRequest;\n\nexport type GrafanaPreviewRuleRequest = {\n  grafana_condition: {\n    condition: string;\n    data: AlertQuery[];\n    now: string;\n  };\n};\n\nexport type CloudPreviewRuleRequest = {\n  dataSourceUid: string;\n  dataSourceName: string;\n  expr: string;\n};\n\nexport type PreviewRuleResponse = {\n  ruleType: RuleFormType;\n  data: PanelData;\n};\n\nexport function isCloudPreviewRequest(request: PreviewRuleRequest): request is CloudPreviewRuleRequest {\n  return 'expr' in request;\n}\n\nexport function isGrafanaPreviewRequest(request: PreviewRuleRequest): request is GrafanaPreviewRuleRequest {\n  return 'grafana_condition' in request;\n}\n","import { Observable, of } from 'rxjs';\nimport { catchError, map, share } from 'rxjs/operators';\n\nimport {\n  dataFrameFromJSON,\n  DataFrameJSON,\n  getDefaultTimeRange,\n  LoadingState,\n  PanelData,\n  withLoadingIndicator,\n} from '@grafana/data';\nimport { getBackendSrv, toDataQueryError } from '@grafana/runtime';\n\nimport {\n  isCloudPreviewRequest,\n  isGrafanaPreviewRequest,\n  PreviewRuleRequest,\n  PreviewRuleResponse,\n} from '../types/preview';\nimport { RuleFormType } from '../types/rule-form';\nimport { GRAFANA_RULES_SOURCE_NAME } from '../utils/datasource';\n\nexport function previewAlertRule(request: PreviewRuleRequest): Observable<PreviewRuleResponse> {\n  if (isCloudPreviewRequest(request)) {\n    return fetchAlertRulePreview(request, request.dataSourceUid, RuleFormType.cloudAlerting);\n  }\n\n  if (isGrafanaPreviewRequest(request)) {\n    return fetchAlertRulePreview(request, GRAFANA_RULES_SOURCE_NAME, RuleFormType.grafana);\n  }\n\n  throw new Error('unsupported preview rule request');\n}\n\ntype AlertRulePreviewResponse = {\n  instances: DataFrameJSON[];\n};\n\nfunction fetchAlertRulePreview(\n  request: PreviewRuleRequest,\n  dataSourceUid: string,\n  ruleType: RuleFormType\n): Observable<PreviewRuleResponse> {\n  return withLoadingIndicator({\n    whileLoading: createResponse(ruleType),\n    source: getBackendSrv()\n      .fetch<AlertRulePreviewResponse>({\n        method: 'POST',\n        url: `/api/v1/rule/test/${dataSourceUid}`,\n        data: request,\n      })\n      .pipe(\n        map(({ data }) => {\n          return createResponse(ruleType, {\n            state: LoadingState.Done,\n            series: data.instances.map(dataFrameFromJSON),\n          });\n        }),\n        catchError((error: Error) => {\n          return of(\n            createResponse(ruleType, {\n              state: LoadingState.Error,\n              error: toDataQueryError(error),\n            })\n          );\n        }),\n        share()\n      ),\n  });\n}\n\nfunction createResponse(ruleType: RuleFormType, data: Partial<PanelData> = {}): PreviewRuleResponse {\n  return {\n    ruleType,\n    data: {\n      state: LoadingState.Loading,\n      series: [],\n      timeRange: getDefaultTimeRange(),\n      ...data,\n    },\n  };\n}\n","import { css } from '@emotion/css';\nimport * as React from 'react';\nimport AutoSizer from 'react-virtualized-auto-sizer';\n\nimport { FieldConfigSource, FieldMatcherID, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { PanelRenderer } from '@grafana/runtime';\nimport { TableCellDisplayMode, useStyles2 } from '@grafana/ui';\n\nimport { PreviewRuleResponse } from '../../types/preview';\nimport { RuleFormType } from '../../types/rule-form';\nimport { messageFromError } from '../../utils/redux';\n\ntype Props = {\n  preview: PreviewRuleResponse | undefined;\n};\n\nexport function PreviewRuleResult(props: Props): React.ReactElement | null {\n  const { preview } = props;\n  const styles = useStyles2(getStyles);\n  const fieldConfig: FieldConfigSource = {\n    defaults: {},\n    overrides: [\n      {\n        matcher: { id: FieldMatcherID.byName, options: 'Info' },\n        properties: [{ id: 'custom.displayMode', value: TableCellDisplayMode.JSONView }],\n      },\n    ],\n  };\n\n  if (!preview) {\n    return null;\n  }\n\n  const { data, ruleType } = preview;\n\n  if (data.state === LoadingState.Loading) {\n    return (\n      <div className={styles.container}>\n        <span>Loading preview...</span>\n      </div>\n    );\n  }\n\n  if (data.state === LoadingState.Error) {\n    return (\n      <div className={styles.container}>\n        {data.error ? messageFromError(data.error) : 'Failed to preview alert rule'}\n      </div>\n    );\n  }\n  return (\n    <div className={styles.container}>\n      <span>\n        Preview based on the result of running the query, for this moment.{' '}\n        {ruleType === RuleFormType.grafana ? 'Configuration for `no data` and `error handling` is not applied.' : null}\n      </span>\n      <div className={styles.table}>\n        <AutoSizer>\n          {({ width, height }) => (\n            <div style={{ width: `${width}px`, height: `${height}px` }}>\n              <PanelRenderer\n                title=\"\"\n                width={width}\n                height={height}\n                pluginId=\"table\"\n                data={data}\n                fieldConfig={fieldConfig}\n              />\n            </div>\n          )}\n        </AutoSizer>\n      </div>\n    </div>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      margin: `${theme.spacing(2)} 0`,\n    }),\n    table: css({\n      flex: '1 1 auto',\n      height: '135px',\n      marginTop: theme.spacing(2),\n      border: `1px solid ${theme.colors.border.medium}`,\n      borderRadius: theme.shape.radius.default,\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport * as React from 'react';\nimport { useCallback, useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\nimport { useMountedState } from 'react-use';\nimport { takeWhile } from 'rxjs/operators';\n\nimport { dateTimeFormatISO, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { Alert, Button, Stack, useStyles2 } from '@grafana/ui';\n\nimport { previewAlertRule } from '../../api/preview';\nimport { useAlertQueriesStatus } from '../../hooks/useAlertQueriesStatus';\nimport { PreviewRuleRequest, PreviewRuleResponse } from '../../types/preview';\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { isDataSourceManagedRuleByType } from '../../utils/rules';\n\nimport { PreviewRuleResult } from './PreviewRuleResult';\n\nconst fields: Array<keyof RuleFormValues> = ['type', 'dataSourceName', 'condition', 'queries', 'expression'];\n\nexport function PreviewRule(): React.ReactElement | null {\n  const styles = useStyles2(getStyles);\n  const [preview, onPreview] = usePreview();\n  const { watch } = useFormContext<RuleFormValues>();\n  const [type, condition, queries] = watch(['type', 'condition', 'queries']);\n  const { allDataSourcesAvailable } = useAlertQueriesStatus(queries);\n\n  if (!type || isDataSourceManagedRuleByType(type)) {\n    return null;\n  }\n\n  const isPreviewAvailable = Boolean(condition) && allDataSourcesAvailable;\n\n  return (\n    <div className={styles.container}>\n      <Stack>\n        {allDataSourcesAvailable && (\n          <Button disabled={!isPreviewAvailable} type=\"button\" variant=\"primary\" onClick={onPreview}>\n            Preview alerts\n          </Button>\n        )}\n        {!allDataSourcesAvailable && (\n          <Alert title=\"Preview is not available\" severity=\"warning\">\n            Cannot display the query preview. Some of the data sources used in the queries are not available.\n          </Alert>\n        )}\n      </Stack>\n      <PreviewRuleResult preview={preview} />\n    </div>\n  );\n}\n\nexport function usePreview(): [PreviewRuleResponse | undefined, () => void] {\n  const [preview, setPreview] = useState<PreviewRuleResponse | undefined>();\n  const { getValues } = useFormContext<RuleFormValues>();\n  const isMounted = useMountedState();\n\n  const onPreview = useCallback(() => {\n    const values = getValues(fields);\n    const request = createPreviewRequest(values);\n\n    previewAlertRule(request)\n      .pipe(takeWhile((response) => !isCompleted(response), true))\n      .subscribe((response) => {\n        if (!isMounted()) {\n          return;\n        }\n        setPreview(response);\n      });\n  }, [getValues, isMounted]);\n\n  return [preview, onPreview];\n}\n\nfunction createPreviewRequest(values: any[]): PreviewRuleRequest {\n  const [type, dataSourceName, condition, queries, expression] = values;\n  const dsSettings = getDataSourceSrv().getInstanceSettings(dataSourceName);\n  if (!dsSettings) {\n    throw new Error(`Cannot find data source settings for ${dataSourceName}`);\n  }\n\n  switch (type) {\n    case RuleFormType.cloudAlerting:\n      return {\n        dataSourceUid: dsSettings.uid,\n        dataSourceName,\n        expr: expression,\n      };\n\n    case RuleFormType.grafana:\n      return {\n        grafana_condition: {\n          condition,\n          data: queries,\n          now: dateTimeFormatISO(Date.now()),\n        },\n      };\n\n    default:\n      throw new Error(`Alert type ${type} not supported by preview.`);\n  }\n}\n\nfunction isCompleted(response: PreviewRuleResponse): boolean {\n  switch (response.data.state) {\n    case LoadingState.Done:\n    case LoadingState.Error:\n      return true;\n    default:\n      return false;\n  }\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css({\n      marginTop: theme.spacing(2),\n      maxWidth: `${theme.breakpoints.values.xxl}px`,\n    }),\n  };\n}\n","import { DataSourceInstanceSettings } from '@grafana/data';\nimport { PromBasedDataSource } from 'app/types/unified-alerting';\n\nimport { getDataSourceByName } from '../utils/datasource';\n\nimport { useUnifiedAlertingSelector } from './useUnifiedAlertingSelector';\n\nexport function useRulesSourcesWithRuler(): DataSourceInstanceSettings[] {\n  const dataSources = useUnifiedAlertingSelector((state) => state.dataSources);\n\n  const dataSourcesWithRuler = Object.values(dataSources)\n    .map((ds) => ds.result)\n    .filter((ds): ds is PromBasedDataSource => Boolean(ds?.rulerConfig));\n  // try fetching rules for each prometheus to see if it has ruler\n\n  return dataSourcesWithRuler\n    .map((ds) => getDataSourceByName(ds.name))\n    .filter((dsConfig): dsConfig is DataSourceInstanceSettings => Boolean(dsConfig));\n}\n","import { DataFrame } from '@grafana/data';\n\nimport { GrafanaAlertState, isGrafanaAlertState, Labels } from '../../../../../types/unified-alerting-dto';\n\ninterface AlertPreviewInstance {\n  state: GrafanaAlertState;\n  info?: string;\n  labels: Labels;\n}\n\ninterface AlertPreview {\n  instances: AlertPreviewInstance[];\n}\n\n// Alerts previews come in a DataFrame format which is more suited for displaying time series data\n// In order to display a list of tags we need to transform DataFrame into set of labels\nexport function mapDataFrameToAlertPreview({ fields }: DataFrame): AlertPreview {\n  const labelFields = fields.filter((field) => !['State', 'Info'].includes(field.name));\n  const stateFieldIndex = fields.findIndex((field) => field.name === 'State');\n  const infoFieldIndex = fields.findIndex((field) => field.name === 'Info');\n\n  const labelIndexes = labelFields.map((labelField) => fields.indexOf(labelField));\n\n  const instanceStatusCount = fields[stateFieldIndex]?.values.length ?? 0;\n\n  const instances: AlertPreviewInstance[] = [];\n\n  for (let index = 0; index < instanceStatusCount; index++) {\n    const labelValues = labelIndexes.map((labelIndex) => [fields[labelIndex].name, fields[labelIndex].values[index]]);\n    const state = fields[stateFieldIndex]?.values?.[index];\n    const info = fields[infoFieldIndex]?.values?.[index];\n\n    if (isGrafanaAlertState(state)) {\n      instances.push({\n        state: state,\n        info: info,\n        labels: Object.fromEntries(labelValues),\n      });\n    }\n  }\n\n  return { instances };\n}\n","import { css } from '@emotion/css';\n\nimport { DataFrame, GrafanaTheme2 } from '@grafana/data/src';\nimport { Icon, TagList, Tooltip, useStyles2 } from '@grafana/ui/src';\n\nimport { labelsToTags } from '../../utils/labels';\nimport { AlertStateTag } from '../rules/AlertStateTag';\n\nimport { mapDataFrameToAlertPreview } from './preview';\n\ninterface CloudAlertPreviewProps {\n  preview: DataFrame;\n}\n\nexport function CloudAlertPreview({ preview }: CloudAlertPreviewProps) {\n  const styles = useStyles2(getStyles);\n  const alertPreview = mapDataFrameToAlertPreview(preview);\n\n  return (\n    <table className={styles.table}>\n      <caption>\n        <div>Alerts preview</div>\n        <span>Preview based on the result of running the query for this moment.</span>\n      </caption>\n      <thead>\n        <tr>\n          <th>State</th>\n          <th>Labels</th>\n          <th>Info</th>\n        </tr>\n      </thead>\n      <tbody>\n        {alertPreview.instances.map(({ state, info, labels }, index) => {\n          const instanceTags = labelsToTags(labels);\n\n          return (\n            <tr key={index}>\n              <td>{<AlertStateTag state={state} />}</td>\n              <td>\n                <TagList tags={instanceTags} className={styles.tagList} />\n              </td>\n              <td>\n                {info && (\n                  <Tooltip content={info}>\n                    <Icon name=\"info-circle\" />\n                  </Tooltip>\n                )}\n              </td>\n            </tr>\n          );\n        })}\n      </tbody>\n    </table>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  table: css({\n    width: '100%',\n    margin: theme.spacing(2, 0),\n\n    caption: {\n      captionSide: 'top',\n      color: theme.colors.text.primary,\n\n      '& > span': {\n        fontSize: theme.typography.bodySmall.fontSize,\n        color: theme.colors.text.secondary,\n      },\n    },\n\n    'td, th': {\n      padding: theme.spacing(1, 1),\n    },\n\n    'td + td, th + th': {\n      paddingLeft: theme.spacing(3),\n    },\n\n    'thead th': {\n      '&:nth-child(1)': {\n        width: '80px',\n      },\n\n      '&:nth-child(2)': {\n        width: 'auto',\n      },\n\n      '&:nth-child(3)': {\n        width: '40px',\n      },\n    },\n\n    'td:nth-child(3)': {\n      textAlign: 'center',\n    },\n\n    'tbody tr:nth-child(2n + 1)': {\n      backgroundColor: theme.colors.background.secondary,\n    },\n  }),\n  tagList: css({\n    justifyContent: 'flex-start',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { noop } from 'lodash';\nimport { useCallback, useMemo } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { CoreApp, DataQuery, DataSourcePluginContextProvider, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { PromQuery } from '@grafana/prometheus';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { Alert, Button, useStyles2 } from '@grafana/ui';\nimport { LokiQuery } from 'app/plugins/datasource/loki/types';\n\nimport { CloudAlertPreview } from './CloudAlertPreview';\nimport { usePreview } from './PreviewRule';\n\nexport interface ExpressionEditorProps {\n  value?: string;\n  onChange: (value: string) => void;\n  dataSourceName: string; // will be a prometheus or loki datasource\n  showPreviewAlertsButton: boolean;\n}\n\nexport const ExpressionEditor = ({\n  value,\n  onChange,\n  dataSourceName,\n  showPreviewAlertsButton = true,\n}: ExpressionEditorProps) => {\n  const styles = useStyles2(getStyles);\n\n  const { mapToValue, mapToQuery } = useQueryMappers(dataSourceName);\n  const dataQuery = mapToQuery({ refId: 'A', hide: false }, value);\n\n  const {\n    error,\n    loading,\n    value: dataSource,\n  } = useAsync(() => {\n    return getDataSourceSrv().get(dataSourceName);\n  }, [dataSourceName]);\n\n  const onChangeQuery = useCallback(\n    (query: DataQuery) => {\n      onChange(mapToValue(query));\n    },\n    [onChange, mapToValue]\n  );\n\n  const [alertPreview, onPreview] = usePreview();\n\n  const onRunQueriesClick = async () => {\n    onPreview();\n  };\n\n  if (loading || dataSource?.name !== dataSourceName) {\n    return null;\n  }\n\n  const dsi = getDataSourceSrv().getInstanceSettings(dataSourceName);\n\n  if (error || !dataSource || !dataSource?.components?.QueryEditor || !dsi) {\n    const errorMessage = error?.message || 'Data source plugin does not export any Query Editor component';\n    return <div>Could not load query editor due to: {errorMessage}</div>;\n  }\n\n  const previewLoaded = alertPreview?.data.state === LoadingState.Done;\n\n  const QueryEditor = dataSource?.components?.QueryEditor;\n\n  // The Preview endpoint returns the preview as a single-element array of data frames\n  const previewDataFrame = alertPreview?.data?.series?.find((s) => s.name === 'evaluation results');\n  // The preview API returns arrays with empty elements when there are no firing alerts\n  const previewHasAlerts = previewDataFrame && previewDataFrame.fields.some((field) => field.values.length > 0);\n\n  return (\n    <>\n      <DataSourcePluginContextProvider instanceSettings={dsi}>\n        <QueryEditor\n          query={dataQuery}\n          queries={[dataQuery]}\n          app={CoreApp.CloudAlerting}\n          onChange={onChangeQuery}\n          onRunQuery={noop}\n          datasource={dataSource}\n        />\n      </DataSourcePluginContextProvider>\n      {showPreviewAlertsButton && (\n        <div className={styles.preview}>\n          <Button\n            type=\"button\"\n            onClick={onRunQueriesClick}\n            disabled={alertPreview?.data.state === LoadingState.Loading}\n          >\n            Preview alerts\n          </Button>\n          {previewLoaded && !previewHasAlerts && (\n            <Alert title=\"Alerts preview\" severity=\"info\" className={styles.previewAlert}>\n              There are no firing alerts for your query.\n            </Alert>\n          )}\n          {previewHasAlerts && <CloudAlertPreview preview={previewDataFrame} />}\n        </div>\n      )}\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  preview: css({\n    padding: theme.spacing(2, 0),\n    maxWidth: `${theme.breakpoints.values.xl}px`,\n  }),\n  previewAlert: css({\n    margin: theme.spacing(1, 0),\n  }),\n});\n\ntype QueryMappers<T extends DataQuery = DataQuery> = {\n  mapToValue: (query: T) => string;\n  mapToQuery: (existing: T, value: string | undefined) => T;\n};\n\nexport function useQueryMappers(dataSourceName: string): QueryMappers {\n  return useMemo(() => {\n    const settings = getDataSourceSrv().getInstanceSettings(dataSourceName);\n\n    switch (settings?.type) {\n      case 'loki':\n      case 'prometheus':\n        return {\n          mapToValue: (query: DataQuery) => (query as PromQuery | LokiQuery).expr,\n          mapToQuery: (existing: DataQuery, value: string | undefined) => ({ ...existing, expr: value }),\n        };\n      default:\n        throw new Error(`${dataSourceName} is not supported as an expression editor`);\n    }\n  }, [dataSourceName]);\n}\n","import { css } from '@emotion/css';\nimport { useMemo } from 'react';\n\nimport { GrafanaTheme2, PanelData } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { ExpressionQuery, ExpressionQueryType } from 'app/features/expressions/types';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { Expression } from '../expressions/Expression';\n\nimport { errorFromPreviewData, warningFromSeries } from './util';\n\ninterface Props {\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n  panelData: Record<string, PanelData | undefined>;\n  queries: AlertQuery[];\n  onRemoveExpression: (refId: string) => void;\n  onUpdateRefId: (oldRefId: string, newRefId: string) => void;\n  onUpdateExpressionType: (refId: string, type: ExpressionQueryType) => void;\n  onUpdateQueryExpression: (query: ExpressionQuery) => void;\n}\n\nexport const ExpressionsEditor = ({\n  condition,\n  onSetCondition,\n  queries,\n  panelData,\n  onUpdateRefId,\n  onRemoveExpression,\n  onUpdateExpressionType,\n  onUpdateQueryExpression,\n}: Props) => {\n  const expressionQueries = useMemo(() => {\n    return queries.reduce((acc: ExpressionQuery[], query) => {\n      return isExpressionQuery(query.model) ? acc.concat(query.model) : acc;\n    }, []);\n  }, [queries]);\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.wrapper}>\n      {expressionQueries.map((query) => {\n        const data = panelData[query.refId];\n\n        const isAlertCondition = condition === query.refId;\n        const error = data ? errorFromPreviewData(data) : undefined;\n        const warning = data ? warningFromSeries(data.series) : undefined;\n\n        return (\n          <Expression\n            key={query.refId}\n            isAlertCondition={isAlertCondition}\n            data={data}\n            error={error}\n            warning={warning}\n            queries={queries}\n            query={query}\n            onSetCondition={onSetCondition}\n            onRemoveExpression={onRemoveExpression}\n            onUpdateRefId={onUpdateRefId}\n            onUpdateExpressionType={onUpdateExpressionType}\n            onChangeQuery={onUpdateQueryExpression}\n          />\n        );\n      })}\n    </div>\n  );\n};\nconst getStyles = (theme: GrafanaTheme2) => ({\n  wrapper: css({\n    display: 'flex',\n    gap: theme.spacing(2),\n    alignContent: 'stretch',\n    flexWrap: 'wrap',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { useState } from 'react';\n\nimport { dateTime, getDefaultRelativeTimeRange, GrafanaTheme2, RelativeTimeRange } from '@grafana/data';\nimport { relativeToTimeRange } from '@grafana/data/src/datetime/rangeutil';\nimport { clearButtonStyles, Icon, InlineField, RelativeTimeRangePicker, Toggletip, useStyles2 } from '@grafana/ui';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { AlertQueryOptions, MaxDataPointsOption, MinIntervalOption } from './QueryWrapper';\n\nexport interface QueryOptionsProps {\n  query: AlertQuery;\n  queryOptions: AlertQueryOptions;\n  onChangeTimeRange?: (timeRange: RelativeTimeRange, index: number) => void;\n  onChangeQueryOptions: (options: AlertQueryOptions, index: number) => void;\n  index: number;\n}\n\nexport const QueryOptions = ({\n  query,\n  queryOptions,\n  onChangeTimeRange,\n  onChangeQueryOptions,\n  index,\n}: QueryOptionsProps) => {\n  const styles = useStyles2(getStyles);\n\n  const [showOptions, setShowOptions] = useState(false);\n\n  const timeRange = query.relativeTimeRange ? relativeToTimeRange(query.relativeTimeRange) : undefined;\n\n  return (\n    <>\n      <Toggletip\n        content={\n          <div className={styles.queryOptions}>\n            {onChangeTimeRange && (\n              <InlineField label=\"Time Range\">\n                <RelativeTimeRangePicker\n                  timeRange={query.relativeTimeRange ?? getDefaultRelativeTimeRange()}\n                  onChange={(range) => onChangeTimeRange(range, index)}\n                />\n              </InlineField>\n            )}\n            <MaxDataPointsOption options={queryOptions} onChange={(options) => onChangeQueryOptions(options, index)} />\n            <MinIntervalOption options={queryOptions} onChange={(options) => onChangeQueryOptions(options, index)} />\n          </div>\n        }\n        closeButton={true}\n        placement=\"bottom-start\"\n      >\n        <button type=\"button\" className={styles.actionLink} onClick={() => setShowOptions(!showOptions)}>\n          Options {showOptions ? <Icon name=\"angle-right\" /> : <Icon name=\"angle-down\" />}\n        </button>\n      </Toggletip>\n\n      <div className={styles.staticValues}>\n        <span>{dateTime(timeRange?.from).locale('en').fromNow(true)}</span>\n        {queryOptions.maxDataPoints && <span>, MD = {queryOptions.maxDataPoints}</span>}\n        {queryOptions.minInterval && <span>, Min. Interval = {queryOptions.minInterval}</span>}\n      </div>\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  const clearButton = clearButtonStyles(theme);\n\n  return {\n    queryOptions: css({\n      '> div': {\n        justifyContent: 'space-between',\n      },\n    }),\n\n    staticValues: css({\n      color: theme.colors.text.secondary,\n      marginRight: theme.spacing(1),\n    }),\n\n    actionLink: css(clearButton, {\n      color: theme.colors.text.link,\n      cursor: 'pointer',\n\n      '&:hover': {\n        textDecoration: 'underline',\n      },\n    }),\n  };\n};\n","import { css } from '@emotion/css';\nimport { cloneDeep } from 'lodash';\nimport * as React from 'react';\nimport { ChangeEvent, useState } from 'react';\nimport { useFormContext } from 'react-hook-form';\n\nimport {\n  CoreApp,\n  DataSourceApi,\n  DataSourceInstanceSettings,\n  GrafanaTheme2,\n  LoadingState,\n  PanelData,\n  RelativeTimeRange,\n  ThresholdsConfig,\n} from '@grafana/data';\nimport { DataQuery } from '@grafana/schema';\nimport { GraphThresholdsStyleMode, Icon, InlineField, Input, Stack, Tooltip, useStyles2 } from '@grafana/ui';\nimport { logInfo } from 'app/features/alerting/unified/Analytics';\nimport { QueryEditorRow } from 'app/features/query/components/QueryEditorRow';\nimport { AlertDataQuery, AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { RuleFormValues } from '../../types/rule-form';\nimport { msToSingleUnitDuration } from '../../utils/time';\nimport { ExpressionStatusIndicator } from '../expressions/ExpressionStatusIndicator';\n\nimport { QueryOptions } from './QueryOptions';\nimport { VizWrapper } from './VizWrapper';\n\nexport const DEFAULT_MAX_DATA_POINTS = 43200;\nexport const DEFAULT_MIN_INTERVAL = '1s';\n\nexport interface AlertQueryOptions {\n  maxDataPoints?: number | undefined;\n  minInterval?: string | undefined;\n}\n\ninterface Props {\n  data: PanelData;\n  error?: Error;\n  query: AlertQuery;\n  queries: AlertQuery[];\n  dsSettings: DataSourceInstanceSettings;\n  onChangeDataSource: (settings: DataSourceInstanceSettings, index: number) => void;\n  onChangeQuery: (query: DataQuery, index: number) => void;\n  onChangeTimeRange?: (timeRange: RelativeTimeRange, index: number) => void;\n  onRemoveQuery: (query: DataQuery) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  onRunQueries: () => void;\n  index: number;\n  thresholds: ThresholdsConfig;\n  thresholdsType?: GraphThresholdsStyleMode;\n  onChangeThreshold?: (thresholds: ThresholdsConfig, index: number) => void;\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n  onChangeQueryOptions: (options: AlertQueryOptions, index: number) => void;\n}\n\nexport const QueryWrapper = ({\n  data,\n  error,\n  dsSettings,\n  index,\n  onChangeDataSource,\n  onChangeQuery,\n  onChangeTimeRange,\n  onRunQueries,\n  onRemoveQuery,\n  onDuplicateQuery,\n  query,\n  queries,\n  thresholds,\n  thresholdsType,\n  onChangeThreshold,\n  condition,\n  onSetCondition,\n  onChangeQueryOptions,\n}: Props) => {\n  const styles = useStyles2(getStyles);\n  const [dsInstance, setDsInstance] = useState<DataSourceApi>();\n  const defaults = dsInstance?.getDefaultQuery ? dsInstance.getDefaultQuery(CoreApp.UnifiedAlerting) : {};\n\n  const { getValues } = useFormContext<RuleFormValues>();\n  const isAdvancedMode = getValues('editorSettings.simplifiedQueryEditor') !== true;\n\n  const queryWithDefaults = {\n    ...defaults,\n    ...cloneDeep(query.model),\n  };\n\n  if (queryWithDefaults.datasource && queryWithDefaults.datasource?.uid !== query.datasourceUid) {\n    logInfo('rule query datasource and datasourceUid mismatch', {\n      queryModelDatasourceUid: queryWithDefaults.datasource?.uid || '',\n      queryDatasourceUid: query.datasourceUid,\n      datasourceType: query.model.datasource?.type || 'unknown type',\n    });\n    // There are occasions when the rule query model datasource UID and the datasourceUid do not match\n    // It's unclear as to why this happens, but we need better visibility on why this happens,\n    // so we log when it does, and make the query model datasource UID match the datasource UID\n    // We already elsewhere work under the assumption that the datasource settings are fetched from the datasourceUid property\n    queryWithDefaults.datasource.uid = query.datasourceUid;\n  }\n\n  function SelectingDataSourceTooltip() {\n    const styles = useStyles2(getStyles);\n    return (\n      <div className={styles.dsTooltip}>\n        <Tooltip\n          content={\n            <>\n              Not finding the data source you want? Some data sources are not supported for alerting. Click on the icon\n              for more information.\n            </>\n          }\n        >\n          <Icon\n            name=\"info-circle\"\n            onClick={() =>\n              window.open(\n                ' https://grafana.com/docs/grafana/latest/alerting/fundamentals/data-source-alerting/',\n                '_blank'\n              )\n            }\n          />\n        </Tooltip>\n      </div>\n    );\n  }\n\n  // TODO add a warning label here too when the data looks like time series data and is used as an alert condition\n  function HeaderExtras({\n    query,\n    error,\n    index,\n    isAdvancedMode = true,\n  }: {\n    query: AlertQuery<AlertDataQuery>;\n    error?: Error;\n    index: number;\n    isAdvancedMode?: boolean;\n  }) {\n    const queryOptions: AlertQueryOptions = {\n      maxDataPoints: query.model.maxDataPoints,\n      minInterval: query.model.intervalMs ? msToSingleUnitDuration(query.model.intervalMs) : undefined,\n    };\n    const alertQueryOptions: AlertQueryOptions = {\n      maxDataPoints: queryOptions.maxDataPoints,\n      minInterval: queryOptions.minInterval,\n    };\n\n    const isAlertCondition = condition === query.refId;\n\n    return (\n      <Stack direction=\"row\" alignItems=\"center\" gap={1}>\n        <SelectingDataSourceTooltip />\n        <QueryOptions\n          onChangeTimeRange={onChangeTimeRange}\n          query={query}\n          queryOptions={alertQueryOptions}\n          onChangeQueryOptions={onChangeQueryOptions}\n          index={index}\n        />\n        {isAdvancedMode && (\n          <ExpressionStatusIndicator\n            onSetCondition={() => onSetCondition(query.refId)}\n            isCondition={isAlertCondition}\n          />\n        )}\n      </Stack>\n    );\n  }\n\n  const showVizualisation = data.state !== LoadingState.NotStarted;\n  // ⚠️ the query editors want the entire array of queries passed as \"DataQuery\" NOT \"AlertQuery\"\n  // TypeScript isn't complaining here because the interfaces just happen to be compatible\n  const editorQueries = cloneDeep(queries.map((query) => query.model));\n\n  return (\n    <Stack direction=\"column\" gap={0.5}>\n      <div className={styles.wrapper}>\n        <QueryEditorRow<AlertDataQuery>\n          alerting\n          hideRefId={!isAdvancedMode}\n          hideActionButtons={!isAdvancedMode}\n          collapsable={false}\n          dataSource={dsSettings}\n          onDataSourceLoaded={setDsInstance}\n          onChangeDataSource={(settings) => onChangeDataSource(settings, index)}\n          id={query.refId}\n          index={index}\n          key={query.refId}\n          data={data}\n          query={queryWithDefaults}\n          onChange={(query) => onChangeQuery(query, index)}\n          onRemoveQuery={onRemoveQuery}\n          onAddQuery={() => onDuplicateQuery(cloneDeep(query))}\n          onRunQuery={onRunQueries}\n          queries={editorQueries}\n          renderHeaderExtras={() => (\n            <HeaderExtras query={query} index={index} error={error} isAdvancedMode={isAdvancedMode} />\n          )}\n          app={CoreApp.UnifiedAlerting}\n          hideHideQueryButton={true}\n        />\n      </div>\n      {showVizualisation && <VizWrapper data={data} thresholds={thresholds} thresholdsType={thresholdsType} />}\n    </Stack>\n  );\n};\n\nexport const EmptyQueryWrapper = ({ children }: React.PropsWithChildren<{}>) => {\n  const styles = useStyles2(getStyles);\n  return <div className={styles.wrapper}>{children}</div>;\n};\n\nexport function MaxDataPointsOption({\n  options,\n  onChange,\n}: {\n  options: AlertQueryOptions;\n  onChange: (options: AlertQueryOptions) => void;\n}) {\n  const value = options.maxDataPoints ?? '';\n\n  const onMaxDataPointsBlur = (event: ChangeEvent<HTMLInputElement>) => {\n    const maxDataPointsNumber = parseInt(event.target.value, 10);\n\n    const maxDataPoints = isNaN(maxDataPointsNumber) || maxDataPointsNumber === 0 ? undefined : maxDataPointsNumber;\n\n    if (maxDataPoints !== options.maxDataPoints) {\n      onChange({\n        ...options,\n        maxDataPoints,\n      });\n    }\n  };\n\n  return (\n    <InlineField\n      labelWidth={24}\n      label=\"Max data points\"\n      tooltip=\"The maximum data points per series. Used directly by some data sources and used in calculation of auto interval. With streaming data this value is used for the rolling buffer.\"\n    >\n      <Input\n        type=\"number\"\n        width={10}\n        placeholder={DEFAULT_MAX_DATA_POINTS.toString()}\n        spellCheck={false}\n        onBlur={onMaxDataPointsBlur}\n        defaultValue={value}\n      />\n    </InlineField>\n  );\n}\n\nexport function MinIntervalOption({\n  options,\n  onChange,\n}: {\n  options: AlertQueryOptions;\n  onChange: (options: AlertQueryOptions) => void;\n}) {\n  const value = options.minInterval ?? '';\n\n  const onMinIntervalBlur = (event: ChangeEvent<HTMLInputElement>) => {\n    const minInterval = event.target.value;\n    if (minInterval !== value) {\n      onChange({\n        ...options,\n        minInterval,\n      });\n    }\n  };\n\n  return (\n    <InlineField\n      label=\"Interval\"\n      labelWidth={24}\n      tooltip={\n        <>\n          Interval sent to the data source. Recommended to be set to write frequency, for example <code>1m</code> if\n          your data is written every minute.\n        </>\n      }\n    >\n      <Input\n        type=\"text\"\n        width={10}\n        placeholder={DEFAULT_MIN_INTERVAL}\n        spellCheck={false}\n        onBlur={onMinIntervalBlur}\n        defaultValue={value}\n      />\n    </InlineField>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  wrapper: css({\n    label: 'AlertingQueryWrapper',\n    marginBottom: theme.spacing(1),\n    border: `1px solid ${theme.colors.border.weak}`,\n    borderRadius: theme.shape.radius.default,\n\n    button: {\n      overflow: 'visible',\n    },\n  }),\n  dsTooltip: css({\n    display: 'flex',\n    alignItems: 'center',\n    '&:hover': {\n      opacity: 0.85,\n      cursor: 'pointer',\n    },\n  }),\n});\n","import { DragDropContext, Droppable, DropResult } from '@hello-pangea/dnd';\nimport { omit } from 'lodash';\nimport { PureComponent, useState } from 'react';\n\nimport {\n  DataQuery,\n  DataSourceInstanceSettings,\n  getDataSourceRef,\n  LoadingState,\n  PanelData,\n  rangeUtil,\n  RelativeTimeRange,\n} from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { Button, Card, Icon, Stack } from '@grafana/ui';\nimport { QueryOperationRow } from 'app/core/components/QueryOperationRow/QueryOperationRow';\nimport { getDatasourceSrv } from 'app/features/plugins/datasource_srv';\nimport { AlertDataQuery, AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { AlertQueryOptions, EmptyQueryWrapper, QueryWrapper } from './QueryWrapper';\nimport { errorFromCurrentCondition, errorFromPreviewData, getThresholdsForQueries } from './util';\n\ninterface Props {\n  // The query configuration\n  queries: AlertQuery[];\n  expressions: AlertQuery[];\n  data: Record<string, PanelData>;\n  onRunQueries: () => void;\n\n  // Query editing\n  onQueriesChange: (queries: AlertQuery[]) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n}\n\nexport class QueryRows extends PureComponent<Props> {\n  constructor(props: Props) {\n    super(props);\n  }\n\n  onRemoveQuery = (query: DataQuery) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(queries.filter((q) => q.refId !== query.refId));\n  };\n\n  onChangeTimeRange = (timeRange: RelativeTimeRange, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n        return {\n          ...item,\n          relativeTimeRange: timeRange,\n        };\n      })\n    );\n  };\n\n  onChangeQueryOptions = (options: AlertQueryOptions, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n        return {\n          ...item,\n          model: {\n            ...item.model,\n            maxDataPoints: options.maxDataPoints,\n            intervalMs: options.minInterval ? rangeUtil.intervalToMs(options.minInterval) : undefined,\n          },\n        };\n      })\n    );\n  };\n\n  onChangeDataSource = (settings: DataSourceInstanceSettings, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n\n    const updatedQueries = queries.map((item, itemIndex) => {\n      if (itemIndex !== index) {\n        return item;\n      }\n\n      const previousSettings = this.getDataSourceSettings(item);\n\n      // Copy model if changing to a datasource of same type.\n      if (settings.type === previousSettings?.type) {\n        return copyModel(item, settings);\n      }\n      return newModel(item, settings);\n    });\n\n    onQueriesChange(updatedQueries);\n  };\n\n  onChangeQuery = (query: DataQuery, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n\n        return {\n          ...item,\n          refId: query.refId,\n          queryType: item.model.queryType ?? '',\n          model: {\n            ...item.model,\n            ...query,\n            datasource: query.datasource!,\n          },\n        };\n      })\n    );\n  };\n\n  onDragEnd = (result: DropResult) => {\n    const { queries, onQueriesChange } = this.props;\n\n    if (!result || !result.destination) {\n      return;\n    }\n\n    const startIndex = result.source.index;\n    const endIndex = result.destination.index;\n    if (startIndex === endIndex) {\n      return;\n    }\n\n    const update = Array.from(queries);\n    const [removed] = update.splice(startIndex, 1);\n    update.splice(endIndex, 0, removed);\n    onQueriesChange(update);\n  };\n\n  getDataSourceSettings = (query: AlertQuery): DataSourceInstanceSettings | undefined => {\n    return getDataSourceSrv().getInstanceSettings(query.datasourceUid);\n  };\n\n  render() {\n    const { queries, expressions, condition } = this.props;\n    const thresholdByRefId = getThresholdsForQueries([...queries, ...expressions], condition);\n\n    return (\n      <DragDropContext onDragEnd={this.onDragEnd}>\n        <Droppable droppableId=\"alerting-queries\" direction=\"vertical\">\n          {(provided) => {\n            return (\n              <div ref={provided.innerRef} {...provided.droppableProps}>\n                <Stack direction=\"column\">\n                  {queries.map((query, index) => {\n                    const isCondition = this.props.condition === query.refId;\n                    const data: PanelData = this.props.data?.[query.refId] ?? {\n                      series: [],\n                      state: LoadingState.NotStarted,\n                    };\n                    const dsSettings = this.getDataSourceSettings(query);\n                    let error: Error | undefined = undefined;\n                    if (data && isCondition) {\n                      error = errorFromCurrentCondition(data);\n                    } else if (data) {\n                      error = errorFromPreviewData(data);\n                    }\n\n                    if (!dsSettings) {\n                      return (\n                        <DatasourceNotFound\n                          key={`${query.refId}-${index}`}\n                          index={index}\n                          model={query.model}\n                          onUpdateDatasource={() => {\n                            const defaultDataSource = getDatasourceSrv().getInstanceSettings(null);\n                            if (defaultDataSource) {\n                              this.onChangeDataSource(defaultDataSource, index);\n                            }\n                          }}\n                          onRemoveQuery={() => {\n                            this.onRemoveQuery(query);\n                          }}\n                        />\n                      );\n                    }\n\n                    return (\n                      <QueryWrapper\n                        index={index}\n                        key={query.refId}\n                        dsSettings={dsSettings}\n                        data={data}\n                        error={error}\n                        query={query}\n                        onChangeQuery={this.onChangeQuery}\n                        onRemoveQuery={this.onRemoveQuery}\n                        queries={[...queries, ...expressions]}\n                        onChangeDataSource={this.onChangeDataSource}\n                        onDuplicateQuery={this.props.onDuplicateQuery}\n                        onChangeTimeRange={this.onChangeTimeRange}\n                        onChangeQueryOptions={this.onChangeQueryOptions}\n                        thresholds={thresholdByRefId[query.refId]?.config}\n                        thresholdsType={thresholdByRefId[query.refId]?.mode}\n                        onRunQueries={this.props.onRunQueries}\n                        condition={this.props.condition}\n                        onSetCondition={this.props.onSetCondition}\n                      />\n                    );\n                  })}\n                  {provided.placeholder}\n                </Stack>\n              </div>\n            );\n          }}\n        </Droppable>\n      </DragDropContext>\n    );\n  }\n}\n\nfunction copyModel(item: AlertQuery, settings: DataSourceInstanceSettings): Omit<AlertQuery, 'datasource'> {\n  return {\n    ...item,\n    model: {\n      ...omit(item.model, 'datasource'),\n      datasource: getDataSourceRef(settings),\n    },\n    datasourceUid: settings.uid,\n  };\n}\n\nfunction newModel(item: AlertQuery, settings: DataSourceInstanceSettings): Omit<AlertQuery, 'datasource'> {\n  return {\n    refId: item.refId,\n    relativeTimeRange: item.relativeTimeRange,\n    queryType: '',\n    datasourceUid: settings.uid,\n    model: {\n      refId: item.refId,\n      hide: false,\n      datasource: getDataSourceRef(settings),\n    },\n  };\n}\n\ninterface DatasourceNotFoundProps {\n  index: number;\n  model: AlertDataQuery;\n  onUpdateDatasource: () => void;\n  onRemoveQuery: () => void;\n}\n\nconst DatasourceNotFound = ({ index, onUpdateDatasource, onRemoveQuery, model }: DatasourceNotFoundProps) => {\n  const refId = model.refId;\n\n  const [showDetails, setShowDetails] = useState<boolean>(false);\n\n  const toggleDetails = () => {\n    setShowDetails((show) => !show);\n  };\n\n  const handleUpdateDatasource = () => {\n    onUpdateDatasource();\n  };\n\n  return (\n    <EmptyQueryWrapper>\n      <QueryOperationRow title={refId} draggable index={index} id={refId} isOpen collapsable={false}>\n        <Card>\n          <Card.Heading>This datasource has been removed</Card.Heading>\n          <Card.Description>\n            The datasource for this query was not found, it was either removed or is not installed correctly.\n          </Card.Description>\n          <Card.Figure>\n            <Icon name=\"question-circle\" />\n          </Card.Figure>\n          <Card.Actions>\n            <Button key=\"update\" variant=\"secondary\" onClick={handleUpdateDatasource}>\n              Update datasource\n            </Button>\n            <Button key=\"remove\" variant=\"destructive\" onClick={onRemoveQuery}>\n              Remove query\n            </Button>\n          </Card.Actions>\n          <Card.SecondaryActions>\n            <Button\n              key=\"details\"\n              onClick={toggleDetails}\n              icon={showDetails ? 'angle-up' : 'angle-down'}\n              fill=\"text\"\n              size=\"sm\"\n            >\n              Show details\n            </Button>\n          </Card.SecondaryActions>\n        </Card>\n        {showDetails && (\n          <div>\n            <pre>\n              <code>{JSON.stringify(model, null, 2)}</code>\n            </pre>\n          </div>\n        )}\n      </QueryOperationRow>\n    </EmptyQueryWrapper>\n  );\n};\n","import { css } from '@emotion/css';\n\nimport { GrafanaTheme2, PanelData } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { QueryRows } from './QueryRows';\n\ninterface Props {\n  panelData: Record<string, PanelData>;\n  queries: AlertQuery[];\n  expressions: AlertQuery[];\n  onRunQueries: () => void;\n  onChangeQueries: (queries: AlertQuery[]) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  condition: string | null;\n  onSetCondition: (refId: string) => void;\n}\n\nexport const QueryEditor = ({\n  queries,\n  expressions,\n  panelData,\n  onRunQueries,\n  onChangeQueries,\n  onDuplicateQuery,\n  condition,\n  onSetCondition,\n}: Props) => {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.container}>\n      <QueryRows\n        data={panelData}\n        queries={queries}\n        expressions={expressions}\n        onRunQueries={onRunQueries}\n        onQueriesChange={onChangeQueries}\n        onDuplicateQuery={onDuplicateQuery}\n        condition={condition}\n        onSetCondition={onSetCondition}\n      />\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  container: css({\n    backgroundColor: theme.colors.background.primary,\n    height: '100%',\n  }),\n});\n","import { css } from '@emotion/css';\nimport { FC, useEffect, useState } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { PanelData, CoreApp, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { DataQuery } from '@grafana/schema';\nimport { useStyles2 } from '@grafana/ui';\nimport { DataSourceType } from 'app/features/alerting/unified/utils/datasource';\nimport { getTimeSrv } from 'app/features/dashboard/services/TimeSrv';\nimport { QueryErrorAlert } from 'app/features/query/components/QueryErrorAlert';\nimport { LokiQueryType } from 'app/plugins/datasource/loki/dataquery.gen';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { isPromOrLokiQuery } from '../../utils/rule-form';\n\nimport { VizWrapper } from './VizWrapper';\n\nexport interface RecordingRuleEditorProps {\n  queries: AlertQuery[];\n  onChangeQuery: (updatedQueries: AlertQuery[]) => void;\n  runQueries: () => void;\n  panelData: Record<string, PanelData>;\n  dataSourceName: string;\n}\n\nexport const RecordingRuleEditor: FC<RecordingRuleEditorProps> = ({\n  queries,\n  onChangeQuery,\n  runQueries,\n  panelData,\n  dataSourceName,\n}) => {\n  const [data, setData] = useState<PanelData>({\n    series: [],\n    state: LoadingState.NotStarted,\n    timeRange: getTimeSrv().timeRange(),\n  });\n\n  const styles = useStyles2(getStyles);\n\n  useEffect(() => {\n    setData(panelData?.[queries[0]?.refId]);\n  }, [panelData, queries]);\n\n  const {\n    error,\n    loading,\n    value: dataSource,\n  } = useAsync(() => {\n    return getDataSourceSrv().get(dataSourceName);\n  }, [dataSourceName]);\n\n  const handleChangedQuery = (changedQuery: DataQuery) => {\n    if (!isPromOrLokiQuery(changedQuery) || !dataSource) {\n      return;\n    }\n\n    const [query] = queries;\n    const { uid: dataSourceId, type } = dataSource;\n    const isLoki = type === DataSourceType.Loki;\n    const expr = changedQuery.expr;\n\n    const merged = {\n      ...query,\n      ...changedQuery,\n      datasourceUid: dataSourceId,\n      expr,\n      model: {\n        expr,\n        datasource: changedQuery.datasource,\n        refId: changedQuery.refId,\n        editorMode: changedQuery.editorMode,\n        // Instant and range are used by Prometheus queries\n        instant: changedQuery.instant,\n        range: changedQuery.range,\n        // Query type is used by Loki queries\n        // On first render/when creating a recording rule, the query type is not set\n        // unless the user has changed it betwee range/instant. The cleanest way to handle this\n        // is to default to instant, or whatever the changed type is\n        queryType: isLoki ? changedQuery.queryType || LokiQueryType.Instant : changedQuery.queryType,\n        legendFormat: changedQuery.legendFormat,\n      },\n    };\n    onChangeQuery([merged]);\n  };\n\n  if (loading || dataSource?.name !== dataSourceName) {\n    return null;\n  }\n\n  const dsi = getDataSourceSrv().getInstanceSettings(dataSourceName);\n\n  if (error || !dataSource || !dataSource?.components?.QueryEditor || !dsi) {\n    const errorMessage = error?.message || 'Data source plugin does not export any Query Editor component';\n    return <div>Could not load query editor due to: {errorMessage}</div>;\n  }\n\n  const QueryEditor = dataSource.components.QueryEditor;\n\n  return (\n    <>\n      {queries.length && (\n        <>\n          <QueryEditor\n            query={queries[0]}\n            queries={queries}\n            app={CoreApp.UnifiedAlerting}\n            onChange={handleChangedQuery}\n            onRunQuery={runQueries}\n            datasource={dataSource}\n          />\n          {(data?.errors || []).map((err) => {\n            return <QueryErrorAlert key={err.message} error={err} />;\n          })}\n        </>\n      )}\n\n      {data && (\n        <div className={styles.vizWrapper}>\n          <VizWrapper data={data} />\n        </div>\n      )}\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  vizWrapper: css({\n    margin: theme.spacing(1, 0),\n  }),\n});\n","import { useCallback } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { DataSourceInstanceSettings } from '@grafana/data';\nimport { DataSourcePicker } from 'app/features/datasources/components/picker/DataSourcePicker';\nimport { dispatch } from 'app/store/store';\n\nimport { useRulesSourcesWithRuler } from '../../hooks/useRuleSourcesWithRuler';\nimport { fetchAllPromBuildInfoAction } from '../../state/actions';\n\ninterface Props {\n  disabled?: boolean;\n  onChange: (ds: DataSourceInstanceSettings) => void;\n  value: string | null;\n  onBlur?: () => void;\n  name?: string;\n}\n\nexport function CloudRulesSourcePicker({ value, disabled, ...props }: Props): JSX.Element {\n  const rulesSourcesWithRuler = useRulesSourcesWithRuler();\n\n  const { loading = true } = useAsync(() => dispatch(fetchAllPromBuildInfoAction()), [dispatch]);\n\n  const dataSourceFilter = useCallback(\n    (ds: DataSourceInstanceSettings): boolean => {\n      return !!rulesSourcesWithRuler.find(({ id }) => id === ds.id);\n    },\n    [rulesSourcesWithRuler]\n  );\n\n  return (\n    <DataSourcePicker\n      disabled={loading || disabled}\n      noDefault\n      alerting\n      filter={dataSourceFilter}\n      current={value}\n      {...props}\n    />\n  );\n}\n","import { css } from '@emotion/css';\nimport { useFormContext, Controller } from 'react-hook-form';\n\nimport { DataSourceInstanceSettings, GrafanaTheme2 } from '@grafana/data';\nimport { Field, useStyles2 } from '@grafana/ui';\n\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { CloudRulesSourcePicker } from '../CloudRulesSourcePicker';\n\nexport interface CloudDataSourceSelectorProps {\n  disabled?: boolean;\n  onChangeCloudDatasource: (datasourceUid: string) => void;\n}\nexport const CloudDataSourceSelector = ({ disabled, onChangeCloudDatasource }: CloudDataSourceSelectorProps) => {\n  const {\n    control,\n    formState: { errors },\n    setValue,\n    watch,\n  } = useFormContext<RuleFormValues>();\n\n  const styles = useStyles2(getStyles);\n  const ruleFormType = watch('type');\n\n  return (\n    <>\n      <div className={styles.flexRow}>\n        {(ruleFormType === RuleFormType.cloudAlerting || ruleFormType === RuleFormType.cloudRecording) && (\n          <Field\n            className={styles.formInput}\n            label={disabled ? 'Data source' : 'Select data source'}\n            error={errors.dataSourceName?.message}\n            invalid={!!errors.dataSourceName?.message}\n          >\n            <Controller\n              render={({ field: { onChange, ref, ...field } }) => (\n                <CloudRulesSourcePicker\n                  {...field}\n                  disabled={disabled}\n                  onChange={(ds: DataSourceInstanceSettings) => {\n                    // reset expression as they don't need to persist after changing datasources\n                    setValue('expression', '');\n                    onChange(ds?.name ?? null);\n                    onChangeCloudDatasource(ds?.uid ?? null);\n                  }}\n                />\n              )}\n              name=\"dataSourceName\"\n              control={control}\n              rules={{\n                required: { value: true, message: 'Please select a data source' },\n              }}\n            />\n          </Field>\n        )}\n      </div>\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  formInput: css({\n    width: '330px',\n    '& + &': {\n      marginLeft: theme.spacing(3),\n    },\n  }),\n  flexRow: css({\n    display: 'flex',\n    flexDirection: 'row',\n    justifyContent: 'flex-start',\n    alignItems: 'flex-end',\n  }),\n});\n","import { createAction, createReducer, original } from '@reduxjs/toolkit';\n\nimport {\n  DataQuery,\n  getDataSourceRef,\n  getDefaultRelativeTimeRange,\n  getNextRefId,\n  rangeUtil,\n  RelativeTimeRange,\n} from '@grafana/data';\nimport { dataSource as expressionDatasource } from 'app/features/expressions/ExpressionDatasource';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { ExpressionDatasourceUID, ExpressionQuery, ExpressionQueryType } from 'app/features/expressions/types';\nimport { defaultCondition } from 'app/features/expressions/utils/expressionTypes';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { logError } from '../../../Analytics';\nimport { getDefaultOrFirstCompatibleDataSource } from '../../../utils/datasource';\nimport { getDefaultQueries } from '../../../utils/rule-form';\nimport { createDagFromQueries, getOriginOfRefId } from '../dag';\nimport { queriesWithUpdatedReferences, refIdExists } from '../util';\n\nexport interface QueriesAndExpressionsState {\n  queries: AlertQuery[];\n}\n\nconst findDataSourceFromExpression = (queries: AlertQuery[], refId: string): AlertQuery | undefined => {\n  const dag = createDagFromQueries(queries);\n  const dataSource = getOriginOfRefId(refId, dag)[0];\n  if (!dataSource) {\n    return;\n  }\n\n  const originQuery = queries.find((query) => query.refId === dataSource);\n  if (originQuery && 'relativeTimeRange' in originQuery) {\n    return originQuery;\n  }\n\n  return;\n};\n\nconst initialState: QueriesAndExpressionsState = {\n  queries: [],\n};\n\nexport const duplicateQuery = createAction<AlertQuery>('duplicateQuery');\nexport const addNewDataQuery = createAction('addNewDataQuery');\nexport const setDataQueries = createAction<AlertQuery[]>('setDataQueries');\n\nexport const addNewExpression = createAction<ExpressionQueryType>('addNewExpression');\nexport const removeExpression = createAction<string>('removeExpression');\nexport const removeExpressions = createAction('removeExpressions');\nexport const addExpressions = createAction<AlertQuery[]>('addExpressions');\nexport const updateExpression = createAction<ExpressionQuery>('updateExpression');\nexport const updateExpressionRefId = createAction<{ oldRefId: string; newRefId: string }>('updateExpressionRefId');\nexport const rewireExpressions = createAction<{ oldRefId: string; newRefId: string }>('rewireExpressions');\nexport const updateExpressionType = createAction<{ refId: string; type: ExpressionQueryType }>('updateExpressionType');\nexport const updateExpressionTimeRange = createAction('updateExpressionTimeRange');\nexport const updateMaxDataPoints = createAction<{ refId: string; maxDataPoints: number }>('updateMaxDataPoints');\nexport const updateMinInterval = createAction<{ refId: string; minInterval: string }>('updateMinInterval');\n\nexport const resetToSimpleCondition = createAction('resetToSimpleCondition');\n\nexport const setRecordingRulesQueries = createAction<{ recordingRuleQueries: AlertQuery[]; expression: string }>(\n  'setRecordingRulesQueries'\n);\n\nexport const queriesAndExpressionsReducer = createReducer(initialState, (builder) => {\n  // data queries actions\n  builder\n    // simple condition actions\n    .addCase(resetToSimpleCondition, (state) => {\n      state.queries = getDefaultQueries();\n    })\n    .addCase(duplicateQuery, (state, { payload }) => {\n      state.queries = addQuery(state.queries, payload);\n    })\n    .addCase(addNewDataQuery, (state) => {\n      const datasource = getDefaultOrFirstCompatibleDataSource();\n      if (!datasource) {\n        return;\n      }\n\n      state.queries = addQuery(state.queries, {\n        datasourceUid: datasource.uid,\n        model: {\n          refId: '',\n          datasource: getDataSourceRef(datasource),\n        },\n      });\n    })\n    .addCase(setDataQueries, (state, { payload }) => {\n      const expressionQueries = state.queries.filter((query) => isExpressionQuery(query.model));\n      state.queries = [...payload, ...expressionQueries];\n    })\n    .addCase(setRecordingRulesQueries, (state, { payload }) => {\n      const query = payload.recordingRuleQueries[0];\n      const recordingRuleQuery = {\n        ...query,\n        ...{ expr: payload.expression, model: query?.model },\n      };\n\n      state.queries = [recordingRuleQuery];\n    })\n    .addCase(updateMaxDataPoints, (state, action) => {\n      state.queries = state.queries.map((query) => {\n        return query.refId === action.payload.refId\n          ? {\n              ...query,\n              model: {\n                ...query.model,\n                maxDataPoints: action.payload.maxDataPoints,\n              },\n            }\n          : query;\n      });\n    })\n    .addCase(updateMinInterval, (state, action) => {\n      state.queries = state.queries.map((query) => {\n        return query.refId === action.payload.refId\n          ? {\n              ...query,\n              model: {\n                ...query.model,\n                intervalMs: action.payload.minInterval ? rangeUtil.intervalToMs(action.payload.minInterval) : undefined,\n              },\n            }\n          : query;\n      });\n    });\n\n  // expressions actions\n  builder\n    .addCase(addNewExpression, (state, { payload }) => {\n      state.queries = addQuery(state.queries, {\n        datasourceUid: ExpressionDatasourceUID,\n        model: expressionDatasource.newQuery({\n          type: payload,\n          conditions: [{ ...defaultCondition, query: { params: [] } }],\n          expression: '',\n        }),\n      });\n    })\n    .addCase(removeExpression, (state, { payload }) => {\n      state.queries = state.queries.filter((query) => query.refId !== payload);\n    })\n    .addCase(removeExpressions, (state) => {\n      state.queries = state.queries.filter((query) => !isExpressionQuery(query.model));\n    })\n    .addCase(addExpressions, (state, { payload }) => {\n      state.queries = [...state.queries, ...payload];\n    })\n    .addCase(updateExpression, (state, { payload }) => {\n      const queryToUpdate = state.queries.find((query) => query.refId === payload.refId);\n      if (!queryToUpdate) {\n        return;\n      }\n\n      queryToUpdate.model = payload;\n\n      // the resample expression needs to also know what the relative time range is to work with, this means we have to copy it from the source node (data source query)\n      if (payload.type === ExpressionQueryType.resample && payload.expression) {\n        // findDataSourceFromExpression uses memoization and it doesn't always work with proxies when the proxy has been revoked\n        const originalQueries = original(state)?.queries ?? [];\n\n        let relativeTimeRange = getDefaultRelativeTimeRange();\n        try {\n          const dataSourceAlertQuery = findDataSourceFromExpression(originalQueries, payload.expression);\n          if (dataSourceAlertQuery?.relativeTimeRange) {\n            relativeTimeRange = dataSourceAlertQuery.relativeTimeRange;\n          }\n        } catch (error) {\n          if (error instanceof Error) {\n            logError(error);\n          } else {\n            logError(new Error('Error while trying to find data source from expression'));\n          }\n        }\n\n        queryToUpdate.relativeTimeRange = relativeTimeRange;\n      }\n    })\n    .addCase(updateExpressionTimeRange, (state) => {\n      state.queries.forEach((query) => {\n        // Resample expression needs to get the relativeTimeRange with its dataSource relativeTimeRange\n        if (\n          isExpressionQuery(query.model) &&\n          query.model.type === ExpressionQueryType.resample &&\n          query.model.expression\n        ) {\n          // findDataSourceFromExpression uses memoization and doesn't work with proxies\n          const originalQueries = original(state)?.queries ?? [];\n\n          const dataSource = findDataSourceFromExpression(originalQueries, query.model.expression);\n          const relativeTimeRange = dataSource ? dataSource.relativeTimeRange : getDefaultRelativeTimeRange();\n          query.relativeTimeRange = relativeTimeRange;\n        }\n      });\n    })\n    .addCase(updateExpressionRefId, (state, { payload }) => {\n      const { newRefId, oldRefId } = payload;\n\n      // if the new refId already exists we just refuse to update the state\n      const newRefIdExists = refIdExists(state.queries, newRefId);\n      if (newRefIdExists) {\n        return;\n      }\n\n      const updatedQueries = queriesWithUpdatedReferences(state.queries, oldRefId, newRefId);\n      state.queries = updatedQueries.map((query) => {\n        if (query.refId === oldRefId) {\n          return {\n            ...query,\n            refId: newRefId,\n            model: {\n              ...query.model,\n              refId: newRefId,\n            },\n          };\n        }\n\n        return query;\n      });\n    })\n    .addCase(rewireExpressions, (state, { payload }) => {\n      state.queries = queriesWithUpdatedReferences(state.queries, payload.oldRefId, payload.newRefId);\n    })\n    .addCase(updateExpressionType, (state, action) => {\n      state.queries = state.queries.map((query) => {\n        return query.refId === action.payload.refId\n          ? {\n              ...query,\n              model: {\n                ...expressionDatasource.newQuery({\n                  type: action.payload.type,\n                  conditions: [{ ...defaultCondition, query: { params: [] } }],\n                  expression: '',\n                }),\n                refId: action.payload.refId,\n              },\n            }\n          : query;\n      });\n    });\n});\n\nconst addQuery = (\n  queries: AlertQuery[],\n  queryToAdd: Pick<AlertQuery, 'model' | 'datasourceUid' | 'relativeTimeRange'>\n): AlertQuery[] => {\n  const refId = getNextRefId(queries);\n  const query: AlertQuery = {\n    ...queryToAdd,\n    refId,\n    queryType: '',\n    model: {\n      ...queryToAdd.model,\n      hide: false,\n      refId,\n    },\n    relativeTimeRange: queryToAdd.relativeTimeRange ?? defaultTimeRange(queryToAdd.model),\n  };\n\n  return [...queries, query];\n};\n\nconst defaultTimeRange = (model: DataQuery): RelativeTimeRange | undefined => {\n  if (isExpressionQuery(model)) {\n    return;\n  }\n\n  return getDefaultRelativeTimeRange();\n};\n","import { css } from '@emotion/css';\nimport { produce } from 'immer';\nimport { Dispatch, FormEvent } from 'react';\nimport { UnknownAction } from 'redux';\n\nimport { GrafanaTheme2, PanelData, ReducerID, SelectableValue } from '@grafana/data';\nimport { ButtonSelect, InlineField, InlineFieldRow, Input, Select, Stack, Text, useStyles2 } from '@grafana/ui';\nimport { Trans } from 'app/core/internationalization';\nimport { EvalFunction } from 'app/features/alerting/state/alertDef';\nimport { ExpressionQuery, ExpressionQueryType, reducerTypes, thresholdFunctions } from 'app/features/expressions/types';\nimport { getReducerType } from 'app/features/expressions/utils/expressionTypes';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { ExpressionResult } from '../../expressions/Expression';\n\nimport { updateExpression } from './reducer';\n\nexport const SIMPLE_CONDITION_QUERY_ID = 'A';\nexport const SIMPLE_CONDITION_REDUCER_ID = 'B';\nexport const SIMPLE_CONDITION_THRESHOLD_ID = 'C';\n\nexport interface SimpleCondition {\n  whenField: string;\n  evaluator: {\n    params: number[];\n    type: EvalFunction;\n  };\n}\n\n/**\n * This is the simple condition editor if the user is in the simple mode in the query section\n */\nexport interface SimpleConditionEditorProps {\n  simpleCondition: SimpleCondition;\n  onChange: (condition: SimpleCondition) => void;\n  expressionQueriesList: Array<AlertQuery<ExpressionQuery>>;\n  dispatch: Dispatch<UnknownAction>;\n  previewData?: PanelData;\n}\n\n/**\n *\n * This represents the simple condition editor for the alerting query section\n * The state for this simple condition is kept in the parent component\n * But we have also to keep the reducer state in sync with this condition state (both kept in the parent)\n */\n\nexport const SimpleConditionEditor = ({\n  simpleCondition,\n  onChange,\n  expressionQueriesList,\n  dispatch,\n  previewData,\n}: SimpleConditionEditorProps) => {\n  const onReducerTypeChange = (value: SelectableValue<string>) => {\n    onChange({ ...simpleCondition, whenField: value.value ?? ReducerID.last });\n    updateReduceExpression(value.value ?? ReducerID.last, expressionQueriesList, dispatch);\n  };\n\n  const isRange =\n    simpleCondition.evaluator.type === EvalFunction.IsWithinRange ||\n    simpleCondition.evaluator.type === EvalFunction.IsOutsideRange;\n\n  const thresholdFunction = thresholdFunctions.find((fn) => fn.value === simpleCondition.evaluator?.type);\n\n  const onEvalFunctionChange = (value: SelectableValue<EvalFunction>) => {\n    // change the condition kept in the parent\n    onChange({\n      ...simpleCondition,\n      evaluator: { ...simpleCondition.evaluator, type: value.value ?? EvalFunction.IsAbove },\n    });\n    // update the reducer state where we store the queries\n    updateThresholdFunction(value.value ?? EvalFunction.IsAbove, expressionQueriesList, dispatch);\n  };\n\n  const onEvaluateValueChange = (event: FormEvent<HTMLInputElement>, index?: number) => {\n    if (isRange) {\n      const newParams = produce(simpleCondition.evaluator.params, (draft) => {\n        draft[index ?? 0] = parseFloat(event.currentTarget.value);\n      });\n      // update the condition kept in the parent\n      onChange({ ...simpleCondition, evaluator: { ...simpleCondition.evaluator, params: newParams } });\n      // update the reducer state where we store the queries\n      updateThresholdValue(parseFloat(event.currentTarget.value), index ?? 0, expressionQueriesList, dispatch);\n    } else {\n      // update the condition kept in the parent\n      onChange({\n        ...simpleCondition,\n        evaluator: { ...simpleCondition.evaluator, params: [parseFloat(event.currentTarget.value)] },\n      });\n      // update the reducer state where we store the queries\n      updateThresholdValue(parseFloat(event.currentTarget.value), 0, expressionQueriesList, dispatch);\n    }\n  };\n\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.condition.wrapper}>\n      <Stack direction=\"column\" gap={0} width=\"100%\">\n        <header className={styles.condition.header}>\n          <Text variant=\"body\">\n            <Trans i18nKey=\"alerting.simpleCondition.alertCondition\">Alert condition</Trans>\n          </Text>\n        </header>\n        <InlineFieldRow className={styles.condition.container}>\n          <InlineField label=\"WHEN\">\n            <Select\n              options={reducerTypes}\n              value={reducerTypes.find((o) => o.value === simpleCondition.whenField)}\n              onChange={onReducerTypeChange}\n              width={20}\n            />\n          </InlineField>\n          <InlineField label=\"OF QUERY\">\n            <Stack direction=\"row\" gap={1} alignItems=\"center\">\n              <ButtonSelect\n                className={styles.buttonSelectText}\n                options={thresholdFunctions}\n                onChange={onEvalFunctionChange}\n                value={thresholdFunction}\n              />\n              {isRange ? (\n                <>\n                  <Input\n                    type=\"number\"\n                    width={10}\n                    value={simpleCondition.evaluator.params[0]}\n                    onChange={(event) => onEvaluateValueChange(event, 0)}\n                  />\n                  <div className={styles.condition.button}>\n                    <Trans i18nKey=\"alerting.simpleCondition.ofQuery.To\">TO</Trans>\n                  </div>\n                  <Input\n                    type=\"number\"\n                    width={10}\n                    value={simpleCondition.evaluator.params[1]}\n                    onChange={(event) => onEvaluateValueChange(event, 1)}\n                  />\n                </>\n              ) : (\n                <Input\n                  type=\"number\"\n                  width={10}\n                  onChange={onEvaluateValueChange}\n                  value={simpleCondition.evaluator.params[0]}\n                />\n              )}\n            </Stack>\n          </InlineField>\n        </InlineFieldRow>\n        {previewData?.series && <ExpressionResult series={previewData?.series} isAlertCondition={true} />}\n      </Stack>\n    </div>\n  );\n};\n\nfunction updateReduceExpression(\n  reducer: string,\n  expressionQueriesList: Array<AlertQuery<ExpressionQuery>>,\n  dispatch: Dispatch<UnknownAction>\n) {\n  const reduceExpression = expressionQueriesList.find(\n    (query) => query.model.type === ExpressionQueryType.reduce && query.model.refId === SIMPLE_CONDITION_REDUCER_ID\n  );\n\n  const newReduceExpression = reduceExpression\n    ? produce(reduceExpression?.model, (draft) => {\n        if (draft && draft.conditions) {\n          draft.reducer = reducer;\n          draft.conditions[0].reducer.type = getReducerType(reducer) ?? ReducerID.last;\n        }\n      })\n    : undefined;\n  newReduceExpression && dispatch(updateExpression(newReduceExpression));\n}\n\nfunction updateThresholdFunction(\n  evaluator: EvalFunction,\n  expressionQueriesList: Array<AlertQuery<ExpressionQuery>>,\n  dispatch: Dispatch<UnknownAction>\n) {\n  const thresholdExpression = expressionQueriesList.find(\n    (query) => query.model.type === ExpressionQueryType.threshold && query.model.refId === SIMPLE_CONDITION_THRESHOLD_ID\n  );\n\n  const newThresholdExpression = produce(thresholdExpression, (draft) => {\n    if (draft && draft.model.conditions) {\n      draft.model.conditions[0].evaluator.type = evaluator;\n    }\n  });\n  newThresholdExpression && dispatch(updateExpression(newThresholdExpression.model));\n}\n\nfunction updateThresholdValue(\n  value: number,\n  index: number,\n  expressionQueriesList: Array<AlertQuery<ExpressionQuery>>,\n  dispatch: Dispatch<UnknownAction>\n) {\n  const thresholdExpression = expressionQueriesList.find(\n    (query) => query.model.type === ExpressionQueryType.threshold && query.model.refId === SIMPLE_CONDITION_THRESHOLD_ID\n  );\n\n  const newThresholdExpression = produce(thresholdExpression, (draft) => {\n    if (draft && draft.model.conditions) {\n      draft.model.conditions[0].evaluator.params[index] = value;\n    }\n  });\n  newThresholdExpression && dispatch(updateExpression(newThresholdExpression.model));\n}\n\nexport function getSimpleConditionFromExpressions(expressions: Array<AlertQuery<ExpressionQuery>>): SimpleCondition {\n  const reduceExpression = expressions.find(\n    (query) => query.model.type === ExpressionQueryType.reduce && query.refId === SIMPLE_CONDITION_REDUCER_ID\n  );\n  const thresholdExpression = expressions.find(\n    (query) => query.model.type === ExpressionQueryType.threshold && query.refId === SIMPLE_CONDITION_THRESHOLD_ID\n  );\n  const conditionsFromThreshold = thresholdExpression?.model.conditions ?? [];\n  return {\n    whenField: reduceExpression?.model.reducer ?? ReducerID.last,\n    evaluator: {\n      params: [...conditionsFromThreshold[0]?.evaluator?.params] ?? [0],\n      type: conditionsFromThreshold[0]?.evaluator?.type ?? EvalFunction.IsAbove,\n    },\n  };\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  buttonSelectText: css({\n    color: theme.colors.primary.text,\n    fontSize: theme.typography.bodySmall.fontSize,\n    textTransform: 'uppercase',\n    padding: `0 ${theme.spacing(1)}`,\n  }),\n  condition: {\n    wrapper: css({\n      display: 'flex',\n      border: `solid 1px ${theme.colors.border.medium}`,\n      flex: 1,\n      height: 'fit-content',\n      borderRadius: theme.shape.radius.default,\n    }),\n    container: css({\n      display: 'flex',\n      flexDirection: 'row',\n      padding: theme.spacing(1),\n      flex: 1,\n      width: '100%',\n    }),\n    header: css({\n      background: theme.colors.background.secondary,\n      padding: `${theme.spacing(0.5)} ${theme.spacing(1)}`,\n      borderBottom: `solid 1px ${theme.colors.border.weak}`,\n      flex: 1,\n    }),\n    button: css({\n      height: '32px',\n      color: theme.colors.primary.text,\n      fontSize: theme.typography.bodySmall.fontSize,\n      textTransform: 'uppercase',\n      display: 'flex',\n      alignItems: 'center',\n      borderRadius: theme.shape.radius.default,\n      fontWeight: theme.typography.fontWeightBold,\n      border: `1px solid ${theme.colors.border.medium}`,\n      whiteSpace: 'nowrap',\n      padding: `0 ${theme.spacing(1)}`,\n      backgroundColor: theme.colors.background.primary,\n    }),\n  },\n});\n","import { useFormContext } from 'react-hook-form';\n\nimport { DataSourceInstanceSettings } from '@grafana/data';\nimport { DataSourceJsonData } from '@grafana/schema';\nimport { RadioButtonGroup, Text, Stack } from '@grafana/ui';\nimport { contextSrv } from 'app/core/core';\nimport { ExpressionDatasourceUID } from 'app/features/expressions/types';\nimport { AccessControlAction } from 'app/types';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { NeedHelpInfo } from '../NeedHelpInfo';\n\nfunction getAvailableRuleTypes() {\n  const canCreateGrafanaRules = contextSrv.hasPermission(AccessControlAction.AlertingRuleCreate);\n  const canCreateCloudRules = contextSrv.hasPermission(AccessControlAction.AlertingRuleExternalWrite);\n  const defaultRuleType = canCreateGrafanaRules ? RuleFormType.grafana : RuleFormType.cloudAlerting;\n\n  const enabledRuleTypes: RuleFormType[] = [];\n  if (canCreateGrafanaRules) {\n    enabledRuleTypes.push(RuleFormType.grafana);\n  }\n  if (canCreateCloudRules) {\n    enabledRuleTypes.push(RuleFormType.cloudAlerting, RuleFormType.cloudRecording);\n  }\n\n  return { enabledRuleTypes, defaultRuleType };\n}\n\nconst onlyOneDSInQueries = (queries: AlertQuery[]) => {\n  return queries.filter((q) => q.datasourceUid !== ExpressionDatasourceUID).length === 1;\n};\nconst getCanSwitch = ({\n  queries,\n  ruleFormType,\n  rulesSourcesWithRuler,\n}: {\n  rulesSourcesWithRuler: Array<DataSourceInstanceSettings<DataSourceJsonData>>;\n  queries: AlertQuery[];\n  ruleFormType: RuleFormType | undefined;\n}) => {\n  // get available rule types\n  const availableRuleTypes = getAvailableRuleTypes();\n\n  // check if we have only one query in queries and if it's a cloud datasource\n  const onlyOneDS = onlyOneDSInQueries(queries);\n  const dataSourceIdFromQueries = queries[0]?.datasourceUid ?? '';\n  const isRecordingRuleType = ruleFormType === RuleFormType.cloudRecording;\n\n  //let's check if we switch to cloud type\n  const canSwitchToCloudRule =\n    !isRecordingRuleType &&\n    onlyOneDS &&\n    rulesSourcesWithRuler.some((dsJsonData) => dsJsonData.uid === dataSourceIdFromQueries);\n\n  const canSwitchToGrafanaRule = !isRecordingRuleType;\n  // check for enabled types\n  const grafanaTypeEnabled = availableRuleTypes.enabledRuleTypes.includes(RuleFormType.grafana);\n  const cloudTypeEnabled = availableRuleTypes.enabledRuleTypes.includes(RuleFormType.cloudAlerting);\n\n  // can we switch to the other type? (cloud or grafana)\n  const canSwitchFromCloudToGrafana =\n    ruleFormType === RuleFormType.cloudAlerting && grafanaTypeEnabled && canSwitchToGrafanaRule;\n  const canSwitchFromGrafanaToCloud =\n    ruleFormType === RuleFormType.grafana && canSwitchToCloudRule && cloudTypeEnabled && canSwitchToCloudRule;\n\n  return canSwitchFromCloudToGrafana || canSwitchFromGrafanaToCloud;\n};\n\nexport interface SmartAlertTypeDetectorProps {\n  editingExistingRule: boolean;\n  rulesSourcesWithRuler: Array<DataSourceInstanceSettings<DataSourceJsonData>>;\n  queries: AlertQuery[];\n  onClickSwitch: () => void;\n}\n\nexport function SmartAlertTypeDetector({\n  editingExistingRule,\n  rulesSourcesWithRuler,\n  queries,\n  onClickSwitch,\n}: SmartAlertTypeDetectorProps) {\n  const { getValues } = useFormContext<RuleFormValues>();\n  const [ruleFormType] = getValues(['type']);\n  const canSwitch = getCanSwitch({ queries, ruleFormType, rulesSourcesWithRuler });\n\n  const options = [\n    { label: 'Grafana-managed', value: RuleFormType.grafana },\n    { label: 'Data source-managed', value: RuleFormType.cloudAlerting },\n  ];\n\n  // if we can't switch to data-source managed, disable it\n  // TODO figure out how to show a popover to the user to indicate _why_ it's disabled\n  const disabledOptions = canSwitch ? [] : [RuleFormType.cloudAlerting];\n\n  return (\n    <Stack direction=\"column\" gap={1} alignItems=\"flex-start\">\n      <Stack direction=\"column\" gap={0}>\n        <Text variant=\"h5\">Rule type</Text>\n        <Stack direction=\"row\" gap={0.5} alignItems=\"center\">\n          <Text variant=\"bodySmall\" color=\"secondary\">\n            Select where the alert rule will be managed.\n          </Text>\n          <NeedHelpInfo\n            contentText={\n              <>\n                <Text color=\"primary\" variant=\"h6\">\n                  Grafana-managed alert rules\n                </Text>\n                <p>\n                  Grafana-managed alert rules allow you to create alerts that can act on data from any of our supported\n                  data sources, including having multiple data sources in the same rule. You can also add expressions to\n                  transform your data and set alert conditions. Using images in alert notifications is also supported.\n                </p>\n                <Text color=\"primary\" variant=\"h6\">\n                  Data source-managed alert rules\n                </Text>\n                <p>\n                  Data source-managed alert rules can be used for Grafana Mimir or Grafana Loki data sources which have\n                  been configured to support rule creation. The use of expressions or multiple queries is not supported.\n                </p>\n              </>\n            }\n            externalLink=\"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/alert-rule-types/\"\n            linkText=\"Read about alert rule types\"\n            title=\"Alert rule types\"\n          />\n        </Stack>\n      </Stack>\n      <RadioButtonGroup\n        options={options}\n        disabled={editingExistingRule}\n        disabledOptions={disabledOptions}\n        value={ruleFormType}\n        onChange={onClickSwitch}\n      />\n      {/* editing an existing rule, we just show \"cannot be changed\" */}\n      {editingExistingRule && (\n        <Text color=\"secondary\">The alert rule type cannot be changed for an existing rule.</Text>\n      )}\n      {/* in regular alert creation we tell the user what options they have when using a cloud data source */}\n      {!editingExistingRule && (\n        <>\n          {canSwitch ? (\n            <Text color=\"secondary\">\n              {ruleFormType === RuleFormType.grafana\n                ? 'The data source selected in your query supports alert rule management. Switch to data source-managed if you want the alert rule to be managed by the data source instead of Grafana.'\n                : 'Switch to Grafana-managed to use expressions, multiple queries, images in notifications and various other features.'}\n            </Text>\n          ) : (\n            <Text color=\"secondary\">Based on the selected data sources this alert rule will be Grafana-managed.</Text>\n          )}\n        </>\n      )}\n    </Stack>\n  );\n}\n","import { RuleFormType } from '../../../types/rule-form';\n\ntype FormDescriptions = {\n  sectionTitle: string;\n  helpLabel: string;\n  helpContent: string;\n  helpLink: string;\n};\n\nexport const DESCRIPTIONS: Record<RuleFormType, FormDescriptions> = {\n  [RuleFormType.cloudRecording]: {\n    sectionTitle: 'Define recording rule',\n    helpLabel: 'Define your recording rule',\n    helpContent:\n      'Pre-compute frequently needed or computationally expensive expressions and save their result as a new set of time series.',\n    helpLink: '',\n  },\n  [RuleFormType.grafanaRecording]: {\n    sectionTitle: 'Define recording rule',\n    helpLabel: 'Define your recording rule',\n    helpContent:\n      'Pre-compute frequently needed or computationally expensive expressions and save their result as a new set of time series.',\n    helpLink: '',\n  },\n  [RuleFormType.grafana]: {\n    sectionTitle: 'Define query and alert condition',\n    helpLabel: 'Define query and alert condition',\n    helpContent:\n      'An alert rule consists of one or more queries and expressions that select the data you want to measure. Define queries and/or expressions and then choose one of them as the alert rule condition. This is the threshold that an alert rule must meet or exceed in order to fire. For more information on queries and expressions, see Query and transform data.',\n    helpLink: 'https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/',\n  },\n  [RuleFormType.cloudAlerting]: {\n    sectionTitle: 'Define query and alert condition',\n    helpLabel: 'Define query and alert condition',\n    helpContent:\n      'An alert rule consists of one or more queries and expressions that select the data you want to measure. Define queries and/or expressions and then choose one of them as the alert rule condition. This is the threshold that an alert rule must meet or exceed in order to fire. For more information on queries and expressions, see Query and transform data.',\n    helpLink: 'https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/',\n  },\n};\n","import { useCallback, useEffect, useMemo, useRef, useState } from 'react';\n\nimport { LoadingState, PanelData } from '@grafana/data';\n\nimport { AlertQuery } from '../../../../../../types/unified-alerting-dto';\nimport { AlertingQueryRunner } from '../../../state/AlertingQueryRunner';\n\nexport function useAlertQueryRunner() {\n  const [queryPreviewData, setQueryPreviewData] = useState<Record<string, PanelData>>({});\n\n  const runner = useRef(new AlertingQueryRunner());\n\n  useEffect(() => {\n    const currentRunner = runner.current;\n\n    currentRunner.get().subscribe((data) => {\n      setQueryPreviewData(data);\n    });\n\n    return () => {\n      currentRunner.destroy();\n    };\n  }, []);\n\n  const clearPreviewData = useCallback(() => {\n    setQueryPreviewData({});\n  }, []);\n\n  const cancelQueries = useCallback(() => {\n    runner.current.cancel();\n  }, []);\n\n  const runQueries = useCallback((queriesToPreview: AlertQuery[], condition: string) => {\n    runner.current.run(queriesToPreview, condition);\n  }, []);\n\n  const isPreviewLoading = useMemo(() => {\n    return Object.values(queryPreviewData).some((d) => d.state === LoadingState.Loading);\n  }, [queryPreviewData]);\n\n  return { queryPreviewData, runQueries, cancelQueries, isPreviewLoading, clearPreviewData };\n}\n","import { css } from '@emotion/css';\nimport { cloneDeep } from 'lodash';\nimport { useCallback, useEffect, useMemo, useReducer, useState } from 'react';\nimport { Controller, useFormContext } from 'react-hook-form';\n\nimport { getDefaultRelativeTimeRange, GrafanaTheme2, ReducerID } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { config, getDataSourceSrv } from '@grafana/runtime';\nimport {\n  Alert,\n  Button,\n  ConfirmModal,\n  Dropdown,\n  Field,\n  Icon,\n  Menu,\n  MenuItem,\n  Stack,\n  Tooltip,\n  useStyles2,\n} from '@grafana/ui';\nimport { Text } from '@grafana/ui/src/components/Text/Text';\nimport { t, Trans } from 'app/core/internationalization';\nimport { EvalFunction } from 'app/features/alerting/state/alertDef';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport {\n  ExpressionDatasourceUID,\n  ExpressionQuery,\n  ExpressionQueryType,\n  expressionTypes,\n  ReducerMode,\n} from 'app/features/expressions/types';\nimport { useDispatch } from 'app/types';\nimport { AlertDataQuery, AlertQuery } from 'app/types/unified-alerting-dto';\n\nimport { useRulesSourcesWithRuler } from '../../../hooks/useRuleSourcesWithRuler';\nimport { fetchAllPromBuildInfoAction } from '../../../state/actions';\nimport { RuleFormType, RuleFormValues } from '../../../types/rule-form';\nimport { getDefaultOrFirstCompatibleDataSource } from '../../../utils/datasource';\nimport { isPromOrLokiQuery, PromOrLokiQuery } from '../../../utils/rule-form';\nimport {\n  isCloudAlertingRuleByType,\n  isCloudRecordingRuleByType,\n  isDataSourceManagedRuleByType,\n  isGrafanaAlertingRuleByType,\n  isGrafanaManagedRuleByType,\n} from '../../../utils/rules';\nimport { ExpressionEditor } from '../ExpressionEditor';\nimport { ExpressionsEditor } from '../ExpressionsEditor';\nimport { NeedHelpInfo } from '../NeedHelpInfo';\nimport { QueryEditor } from '../QueryEditor';\nimport { RecordingRuleEditor } from '../RecordingRuleEditor';\nimport { RuleEditorSection } from '../RuleEditorSection';\nimport { errorFromCurrentCondition, errorFromPreviewData, findRenamedDataQueryReferences, refIdExists } from '../util';\n\nimport { CloudDataSourceSelector } from './CloudDataSourceSelector';\nimport {\n  getSimpleConditionFromExpressions,\n  SIMPLE_CONDITION_QUERY_ID,\n  SIMPLE_CONDITION_REDUCER_ID,\n  SIMPLE_CONDITION_THRESHOLD_ID,\n  SimpleCondition,\n  SimpleConditionEditor,\n} from './SimpleCondition';\nimport { SmartAlertTypeDetector } from './SmartAlertTypeDetector';\nimport { DESCRIPTIONS } from './descriptions';\nimport {\n  addExpressions,\n  addNewDataQuery,\n  addNewExpression,\n  duplicateQuery,\n  queriesAndExpressionsReducer,\n  removeExpression,\n  removeExpressions,\n  resetToSimpleCondition,\n  rewireExpressions,\n  setDataQueries,\n  setRecordingRulesQueries,\n  updateExpression,\n  updateExpressionRefId,\n  updateExpressionTimeRange,\n  updateExpressionType,\n} from './reducer';\nimport { useAlertQueryRunner } from './useAlertQueryRunner';\n\nexport function areQueriesTransformableToSimpleCondition(\n  dataQueries: Array<AlertQuery<AlertDataQuery | ExpressionQuery>>,\n  expressionQueries: Array<AlertQuery<ExpressionQuery>>\n) {\n  if (dataQueries.length !== 1) {\n    return false;\n  }\n\n  if (expressionQueries.length !== 2) {\n    return false;\n  }\n\n  const query = dataQueries[0];\n\n  if (query.refId !== SIMPLE_CONDITION_QUERY_ID) {\n    return false;\n  }\n\n  const reduceExpressionIndex = expressionQueries.findIndex(\n    (query) => query.model.type === ExpressionQueryType.reduce && query.refId === SIMPLE_CONDITION_REDUCER_ID\n  );\n  const reduceExpression = expressionQueries.at(reduceExpressionIndex);\n  const reduceOk =\n    reduceExpression &&\n    reduceExpressionIndex === 0 &&\n    (reduceExpression.model.settings?.mode === ReducerMode.Strict ||\n      reduceExpression.model.settings?.mode === undefined);\n\n  const thresholdExpressionIndex = expressionQueries.findIndex(\n    (query) => query.model.type === ExpressionQueryType.threshold && query.refId === SIMPLE_CONDITION_THRESHOLD_ID\n  );\n  const thresholdExpression = expressionQueries.at(thresholdExpressionIndex);\n  const conditions = thresholdExpression?.model.conditions ?? [];\n  const thresholdOk =\n    thresholdExpression && thresholdExpressionIndex === 1 && conditions[0]?.unloadEvaluator === undefined;\n  return Boolean(reduceOk) && Boolean(thresholdOk);\n}\n\ninterface Props {\n  editingExistingRule: boolean;\n  onDataChange: (error: string) => void;\n}\n\nexport const QueryAndExpressionsStep = ({ editingExistingRule, onDataChange }: Props) => {\n  const {\n    setValue,\n    getValues,\n    watch,\n    formState: { errors },\n    control,\n  } = useFormContext<RuleFormValues>();\n\n  const { queryPreviewData, runQueries, cancelQueries, isPreviewLoading, clearPreviewData } = useAlertQueryRunner();\n  const isSwitchModeEnabled = config.featureToggles.alertingQueryAndExpressionsStepMode ?? false;\n\n  const initialState = {\n    queries: getValues('queries'),\n  };\n\n  const [{ queries }, dispatch] = useReducer(queriesAndExpressionsReducer, initialState);\n\n  // data queries only\n  const dataQueries = useMemo(() => {\n    return queries.filter((query) => !isExpressionQuery(query.model));\n  }, [queries]);\n\n  // expression queries only\n  const expressionQueries = useMemo(() => {\n    return queries.filter((query) => isExpressionQueryInAlert(query));\n  }, [queries]);\n\n  const [type, condition, dataSourceName, editorSettings] = watch([\n    'type',\n    'condition',\n    'dataSourceName',\n    'editorSettings',\n  ]);\n  //if its a new rule, look at the local storage\n\n  const isGrafanaAlertingType = isGrafanaAlertingRuleByType(type);\n  const isRecordingRuleType = isCloudRecordingRuleByType(type);\n  const isCloudAlertRuleType = isCloudAlertingRuleByType(type);\n\n  const isAdvancedMode = editorSettings?.simplifiedQueryEditor !== true || !isGrafanaAlertingType;\n\n  const [showResetModeModal, setShowResetModal] = useState(false);\n\n  const [simpleCondition, setSimpleCondition] = useState<SimpleCondition>(\n    isGrafanaAlertingType && areQueriesTransformableToSimpleCondition(dataQueries, expressionQueries)\n      ? getSimpleConditionFromExpressions(expressionQueries)\n      : {\n          whenField: ReducerID.last,\n          evaluator: {\n            params: [0],\n            type: EvalFunction.IsAbove,\n          },\n        }\n  );\n\n  // If we switch to simple mode we need to update the simple condition with the data in the queries reducer\n  useEffect(() => {\n    if (!isAdvancedMode && isGrafanaAlertingType) {\n      setSimpleCondition(getSimpleConditionFromExpressions(expressionQueries));\n    }\n  }, [isAdvancedMode, expressionQueries, isGrafanaAlertingType]);\n\n  const dispatchReduxAction = useDispatch();\n  useEffect(() => {\n    dispatchReduxAction(fetchAllPromBuildInfoAction());\n  }, [dispatchReduxAction]);\n\n  const rulesSourcesWithRuler = useRulesSourcesWithRuler();\n\n  const runQueriesPreview = useCallback(\n    (condition?: string) => {\n      if (isCloudAlertRuleType) {\n        // we will skip preview for cloud rules, these do not have any time series preview\n        // Grafana Managed rules and recording rules do\n        return;\n      }\n      // we need to be sure the condition is set once we switch to simple mode\n      if (!isAdvancedMode) {\n        setValue('condition', SIMPLE_CONDITION_THRESHOLD_ID);\n        runQueries(getValues('queries'), SIMPLE_CONDITION_THRESHOLD_ID);\n      } else {\n        runQueries(getValues('queries'), condition || (getValues('condition') ?? ''));\n      }\n    },\n    [isCloudAlertRuleType, runQueries, getValues, isAdvancedMode, setValue]\n  );\n\n  // whenever we update the queries we have to update the form too\n  useEffect(() => {\n    setValue('queries', queries, { shouldValidate: false });\n  }, [queries, runQueries, setValue]);\n\n  const noCompatibleDataSources = getDefaultOrFirstCompatibleDataSource() === undefined;\n\n  const emptyQueries = queries.length === 0;\n\n  // apply some validations and asserts to the results of the evaluation when creating or editing\n  // Grafana-managed alert rules and Grafa-managed recording rules\n  useEffect(() => {\n    if (type && !isGrafanaManagedRuleByType(type)) {\n      return;\n    }\n\n    const currentCondition = getValues('condition');\n    if (!currentCondition) {\n      return;\n    }\n\n    const previewData = queryPreviewData[currentCondition];\n    if (!previewData) {\n      return;\n    }\n\n    const error = errorFromPreviewData(previewData) ?? errorFromCurrentCondition(previewData);\n\n    onDataChange(error?.message || '');\n  }, [queryPreviewData, getValues, onDataChange, type]);\n\n  const handleSetCondition = useCallback(\n    (refId: string | null) => {\n      if (!refId) {\n        return;\n      }\n\n      runQueriesPreview(refId); //we need to run the queries to know if the condition is valid\n\n      setValue('condition', refId);\n    },\n    [runQueriesPreview, setValue]\n  );\n\n  const onUpdateRefId = useCallback(\n    (oldRefId: string, newRefId: string) => {\n      const newRefIdExists = refIdExists(queries, newRefId);\n      // TODO we should set an error and explain what went wrong instead of just refusing to update\n      if (newRefIdExists) {\n        return;\n      }\n\n      dispatch(updateExpressionRefId({ oldRefId, newRefId }));\n\n      // update condition too if refId was updated\n      if (condition === oldRefId) {\n        handleSetCondition(newRefId);\n      }\n    },\n    [condition, queries, handleSetCondition]\n  );\n\n  const updateExpressionAndDatasource = useSetExpressionAndDataSource();\n\n  const onChangeQueries = useCallback(\n    (updatedQueries: AlertQuery[]) => {\n      // Most data sources triggers onChange and onRunQueries consecutively\n      // It means our reducer state is always one step behind when runQueries is invoked\n      // Invocation cycle => onChange -> dispatch(setDataQueries) -> onRunQueries -> setDataQueries Reducer\n      // As a workaround we update form values as soon as possible to avoid stale state\n      // This way we can access up to date queries in runQueriesPreview without waiting for re-render\n      const previousQueries = getValues('queries');\n      const expressionQueries = previousQueries.filter((query) => isExpressionQuery(query.model));\n      setValue('queries', [...updatedQueries, ...expressionQueries], { shouldValidate: false });\n      updateExpressionAndDatasource(updatedQueries);\n\n      dispatch(setDataQueries(updatedQueries));\n      dispatch(updateExpressionTimeRange());\n\n      // check if we need to rewire expressions (and which ones)\n      const [oldRefId, newRefId] = findRenamedDataQueryReferences(queries, updatedQueries);\n      if (oldRefId && newRefId) {\n        dispatch(rewireExpressions({ oldRefId, newRefId }));\n      }\n    },\n    [queries, updateExpressionAndDatasource, getValues, setValue]\n  );\n\n  const onChangeRecordingRulesQueries = useCallback(\n    (updatedQueries: AlertQuery[]) => {\n      const query = updatedQueries[0];\n\n      if (!isPromOrLokiQuery(query.model)) {\n        return;\n      }\n\n      const expression = query.model.expr;\n\n      setValue('queries', updatedQueries, { shouldValidate: false });\n      updateExpressionAndDatasource(updatedQueries);\n\n      dispatch(setRecordingRulesQueries({ recordingRuleQueries: updatedQueries, expression }));\n      runQueriesPreview();\n    },\n    [runQueriesPreview, setValue, updateExpressionAndDatasource]\n  );\n\n  const recordingRuleDefaultDatasource = rulesSourcesWithRuler[0];\n\n  useEffect(() => {\n    clearPreviewData();\n    if (type === RuleFormType.cloudRecording) {\n      const expr = getValues('expression');\n\n      if (!recordingRuleDefaultDatasource) {\n        return;\n      }\n\n      const datasourceUid =\n        (editingExistingRule && getDataSourceSrv().getInstanceSettings(dataSourceName)?.uid) ||\n        recordingRuleDefaultDatasource.uid;\n\n      const defaultQuery = {\n        refId: 'A',\n        datasourceUid,\n        queryType: '',\n        relativeTimeRange: getDefaultRelativeTimeRange(),\n        expr,\n        instant: true,\n        model: {\n          refId: 'A',\n          hide: false,\n          expr,\n        },\n      };\n      dispatch(setRecordingRulesQueries({ recordingRuleQueries: [defaultQuery], expression: expr }));\n    }\n  }, [type, recordingRuleDefaultDatasource, editingExistingRule, getValues, dataSourceName, clearPreviewData]);\n\n  const onDuplicateQuery = useCallback((query: AlertQuery) => {\n    dispatch(duplicateQuery(query));\n  }, []);\n\n  // update the condition if it's been removed\n  useEffect(() => {\n    if (!refIdExists(queries, condition)) {\n      const lastRefId = queries.at(-1)?.refId ?? null;\n      handleSetCondition(lastRefId);\n    }\n  }, [condition, queries, handleSetCondition]);\n\n  const onClickType = useCallback(\n    (type: ExpressionQueryType) => {\n      dispatch(addNewExpression(type));\n    },\n    [dispatch]\n  );\n\n  const styles = useStyles2(getStyles);\n\n  // Cloud alerts load data from form values\n  // whereas Grafana managed alerts load data from reducer\n  //when data source is changed in the cloud selector we need to update the queries in the reducer\n\n  const onChangeCloudDatasource = useCallback(\n    (datasourceUid: string) => {\n      const newQueries = cloneDeep(queries);\n      newQueries[0].datasourceUid = datasourceUid;\n      setValue('queries', newQueries, { shouldValidate: false });\n\n      updateExpressionAndDatasource(newQueries);\n\n      dispatch(setDataQueries(newQueries));\n    },\n    [queries, setValue, updateExpressionAndDatasource, dispatch]\n  );\n\n  // ExpressionEditor for cloud query needs to update queries in the reducer and in the form\n  // otherwise the value is not updated for Grafana managed alerts\n\n  const onChangeExpression = (value: string) => {\n    const newQueries = cloneDeep(queries);\n\n    if (newQueries[0].model) {\n      if (isPromOrLokiQuery(newQueries[0].model)) {\n        newQueries[0].model.expr = value;\n      } else {\n        // first time we come from grafana-managed type\n        // we need to convert the model to PromOrLokiQuery\n        const promLoki: PromOrLokiQuery = {\n          ...cloneDeep(newQueries[0].model),\n          expr: value,\n        };\n        newQueries[0].model = promLoki;\n      }\n    }\n\n    setValue('queries', newQueries, { shouldValidate: false });\n\n    updateExpressionAndDatasource(newQueries);\n\n    dispatch(setDataQueries(newQueries));\n    runQueriesPreview();\n  };\n\n  const removeExpressionsInQueries = useCallback(() => dispatch(removeExpressions()), [dispatch]);\n\n  const addExpressionsInQueries = useCallback(\n    (expressions: AlertQuery[]) => dispatch(addExpressions(expressions)),\n    [dispatch]\n  );\n\n  // we need to keep track of the previous expressions and condition reference to be able to restore them when switching back to grafana managed\n  const [prevExpressions, setPrevExpressions] = useState<AlertQuery[]>([]);\n  const [prevCondition, setPrevCondition] = useState<string | null>(null);\n\n  const restoreExpressionsInQueries = useCallback(() => {\n    addExpressionsInQueries(prevExpressions);\n  }, [prevExpressions, addExpressionsInQueries]);\n\n  const onClickSwitch = useCallback(() => {\n    const typeInForm = getValues('type');\n    if (typeInForm === RuleFormType.cloudAlerting) {\n      setValue('type', RuleFormType.grafana);\n      setValue('dataSourceName', null); // set data source name back to \"null\"\n\n      prevExpressions.length > 0 && restoreExpressionsInQueries();\n      prevCondition && setValue('condition', prevCondition);\n    } else {\n      setValue('type', RuleFormType.cloudAlerting);\n      // dataSourceName is used only by Mimir/Loki alerting and recording rules\n      // It should be empty for Grafana managed alert rules\n      const newDsName = getDataSourceSrv().getInstanceSettings(queries[0].datasourceUid)?.name;\n      if (newDsName) {\n        setValue('dataSourceName', newDsName);\n      }\n\n      updateExpressionAndDatasource(queries);\n\n      const expressions = queries.filter((query) => query.datasourceUid === ExpressionDatasourceUID);\n      setPrevExpressions(expressions);\n      removeExpressionsInQueries();\n      setPrevCondition(condition);\n    }\n  }, [\n    getValues,\n    setValue,\n    prevExpressions.length,\n    restoreExpressionsInQueries,\n    prevCondition,\n    updateExpressionAndDatasource,\n    queries,\n    removeExpressionsInQueries,\n    condition,\n  ]);\n\n  const { sectionTitle, helpLabel, helpContent, helpLink } = DESCRIPTIONS[type ?? RuleFormType.grafana];\n\n  if (!type) {\n    return null;\n  }\n\n  const switchMode =\n    isGrafanaAlertingType && isSwitchModeEnabled\n      ? {\n          isAdvancedMode,\n          setAdvancedMode: (isAdvanced: boolean) => {\n            if (!isAdvanced) {\n              if (!areQueriesTransformableToSimpleCondition(dataQueries, expressionQueries)) {\n                setShowResetModal(true);\n                return;\n              }\n            }\n            setValue('editorSettings', { simplifiedQueryEditor: !isAdvanced });\n          },\n        }\n      : undefined;\n\n  return (\n    <>\n      <RuleEditorSection\n        stepNo={2}\n        title={sectionTitle}\n        fullWidth={true}\n        description={\n          <Stack direction=\"row\" gap={0.5} alignItems=\"center\">\n            <Text variant=\"bodySmall\" color=\"secondary\">\n              {helpLabel}\n            </Text>\n            <NeedHelpInfo\n              contentText={helpContent}\n              externalLink={helpLink}\n              linkText={'Read more on our documentation website'}\n              title={helpLabel}\n            />\n          </Stack>\n        }\n        switchMode={switchMode}\n      >\n        {/* This is the cloud data source selector */}\n        {isDataSourceManagedRuleByType(type) && (\n          <CloudDataSourceSelector onChangeCloudDatasource={onChangeCloudDatasource} disabled={editingExistingRule} />\n        )}\n\n        {/* This is the PromQL Editor for recording rules */}\n        {isRecordingRuleType && dataSourceName && (\n          <Field error={errors.expression?.message} invalid={!!errors.expression?.message}>\n            <RecordingRuleEditor\n              dataSourceName={dataSourceName}\n              queries={queries}\n              runQueries={() => runQueriesPreview()}\n              onChangeQuery={onChangeRecordingRulesQueries}\n              panelData={queryPreviewData}\n            />\n          </Field>\n        )}\n\n        {/* This is the PromQL Editor for Cloud rules */}\n        {isCloudAlertRuleType && dataSourceName && (\n          <Stack direction=\"column\">\n            <Field error={errors.expression?.message} invalid={!!errors.expression?.message}>\n              <Controller\n                name=\"expression\"\n                render={({ field: { ref, ...field } }) => {\n                  return (\n                    <ExpressionEditor\n                      {...field}\n                      dataSourceName={dataSourceName}\n                      showPreviewAlertsButton={!isRecordingRuleType}\n                      onChange={onChangeExpression}\n                    />\n                  );\n                }}\n                control={control}\n                rules={{\n                  required: { value: true, message: 'A valid expression is required' },\n                }}\n              />\n            </Field>\n            <SmartAlertTypeDetector\n              editingExistingRule={editingExistingRule}\n              queries={queries}\n              rulesSourcesWithRuler={rulesSourcesWithRuler}\n              onClickSwitch={onClickSwitch}\n            />\n          </Stack>\n        )}\n\n        {/* This is the editor for Grafana managed rules and Grafana managed recording rules */}\n        {isGrafanaManagedRuleByType(type) && (\n          <Stack direction=\"column\">\n            {/* Data Queries */}\n            <QueryEditor\n              queries={dataQueries}\n              expressions={expressionQueries}\n              onRunQueries={() => runQueriesPreview()}\n              onChangeQueries={onChangeQueries}\n              onDuplicateQuery={onDuplicateQuery}\n              panelData={queryPreviewData}\n              condition={condition}\n              onSetCondition={handleSetCondition}\n            />\n            {isAdvancedMode && (\n              <Tooltip content={'You appear to have no compatible data sources'} show={noCompatibleDataSources}>\n                <Button\n                  type=\"button\"\n                  onClick={() => {\n                    dispatch(addNewDataQuery());\n                  }}\n                  variant=\"secondary\"\n                  data-testid={selectors.components.QueryTab.addQuery}\n                  disabled={noCompatibleDataSources}\n                  className={styles.addQueryButton}\n                >\n                  Add query\n                </Button>\n              </Tooltip>\n            )}\n            {/* We only show Switch for Grafana managed alerts */}\n            {isGrafanaAlertingType && isAdvancedMode && (\n              <SmartAlertTypeDetector\n                editingExistingRule={editingExistingRule}\n                rulesSourcesWithRuler={rulesSourcesWithRuler}\n                queries={queries}\n                onClickSwitch={onClickSwitch}\n              />\n            )}\n            {/* Expression Queries */}\n            {isAdvancedMode && (\n              <>\n                <Stack direction=\"column\" gap={0}>\n                  <Text element=\"h5\">Expressions</Text>\n                  <Text variant=\"bodySmall\" color=\"secondary\">\n                    Manipulate data returned from queries with math and other operations.\n                  </Text>\n                </Stack>\n\n                <ExpressionsEditor\n                  queries={queries}\n                  panelData={queryPreviewData}\n                  condition={condition}\n                  onSetCondition={handleSetCondition}\n                  onRemoveExpression={(refId) => {\n                    dispatch(removeExpression(refId));\n                  }}\n                  onUpdateRefId={onUpdateRefId}\n                  onUpdateExpressionType={(refId, type) => {\n                    dispatch(updateExpressionType({ refId, type }));\n                  }}\n                  onUpdateQueryExpression={(model) => {\n                    dispatch(updateExpression(model));\n                  }}\n                />\n              </>\n            )}\n            {/* action buttons */}\n            <Stack direction=\"column\">\n              {!isAdvancedMode && (\n                <SimpleConditionEditor\n                  simpleCondition={simpleCondition}\n                  onChange={setSimpleCondition}\n                  expressionQueriesList={expressionQueries}\n                  dispatch={dispatch}\n                  previewData={queryPreviewData[condition ?? '']}\n                />\n              )}\n              <Stack direction=\"row\">\n                {isAdvancedMode && config.expressionsEnabled && <TypeSelectorButton onClickType={onClickType} />}\n\n                {isPreviewLoading && (\n                  <Button icon=\"spinner\" type=\"button\" variant=\"destructive\" onClick={cancelQueries}>\n                    Cancel\n                  </Button>\n                )}\n                {!isPreviewLoading && (\n                  <Button\n                    data-testid={selectors.components.AlertRules.previewButton}\n                    icon=\"sync\"\n                    type=\"button\"\n                    onClick={() => runQueriesPreview()}\n                    disabled={emptyQueries}\n                  >\n                    {isAdvancedMode\n                      ? t('alerting.queryAndExpressionsStep.preview', 'Preview')\n                      : t('alerting.queryAndExpressionsStep.previewCondition', 'Preview alert rule condition')}\n                  </Button>\n                )}\n              </Stack>\n            </Stack>\n\n            {/* No Queries */}\n            {emptyQueries && (\n              <Alert title=\"No queries or expressions have been configured\" severity=\"warning\">\n                Create at least one query or expression to be alerted on\n              </Alert>\n            )}\n          </Stack>\n        )}\n      </RuleEditorSection>\n\n      <ConfirmModal\n        isOpen={showResetModeModal}\n        title=\"Deactivate advanced options\"\n        body={\n          <div>\n            <Text element=\"p\">\n              <Trans i18nKey=\"alerting.queryAndExpressionsStep.disableAdvancedOptions.text\">\n                The selected queries and expressions cannot be converted to default. If you deactivate advanced options,\n                your query and condition will be reset to default settings.\n              </Trans>\n            </Text>\n            <br />\n          </div>\n        }\n        confirmText=\"Deactivate\"\n        icon=\"exclamation-triangle\"\n        onConfirm={() => {\n          setValue('editorSettings', { simplifiedQueryEditor: true });\n          setShowResetModal(false);\n          dispatch(resetToSimpleCondition());\n        }}\n        onDismiss={() => setShowResetModal(false)}\n      />\n    </>\n  );\n};\n\nfunction TypeSelectorButton({ onClickType }: { onClickType: (type: ExpressionQueryType) => void }) {\n  const newMenu = (\n    <Menu>\n      {expressionTypes.map((type) => (\n        <Tooltip key={type.value} content={type.description ?? ''} placement=\"right\">\n          <MenuItem\n            key={type.value}\n            onClick={() => onClickType(type.value ?? ExpressionQueryType.math)}\n            label={type.label ?? ''}\n          />\n        </Tooltip>\n      ))}\n    </Menu>\n  );\n\n  return (\n    <Dropdown overlay={newMenu}>\n      <Button variant=\"secondary\">\n        Add expression\n        <Icon name=\"angle-down\" />\n      </Button>\n    </Dropdown>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  addQueryButton: css({\n    width: 'fit-content',\n  }),\n  helpInfo: css({\n    display: 'flex',\n    flexDirection: 'row',\n    alignItems: 'center',\n    width: 'fit-content',\n    fontWeight: theme.typography.fontWeightMedium,\n    marginLeft: theme.spacing(1),\n    fontSize: theme.typography.size.sm,\n    cursor: 'pointer',\n  }),\n  helpInfoText: css({\n    marginLeft: theme.spacing(0.5),\n    textDecoration: 'underline',\n  }),\n  infoLink: css({\n    color: theme.colors.text.link,\n  }),\n});\n\nconst useSetExpressionAndDataSource = () => {\n  const { setValue } = useFormContext<RuleFormValues>();\n\n  return (updatedQueries: AlertQuery[]) => {\n    // update data source name and expression if it's been changed in the queries from the reducer when prom or loki query\n    const query = updatedQueries[0];\n    if (!query) {\n      return;\n    }\n\n    const dataSourceSettings = getDataSourceSrv().getInstanceSettings(query.datasourceUid);\n    if (!dataSourceSettings) {\n      throw new Error('The Data source has not been defined.');\n    }\n\n    if (isPromOrLokiQuery(query.model)) {\n      const expression = query.model.expr;\n      setValue('expression', expression);\n    }\n  };\n};\n\nfunction isExpressionQueryInAlert(\n  query: AlertQuery<AlertDataQuery | ExpressionQuery>\n): query is AlertQuery<ExpressionQuery> {\n  return isExpressionQuery(query.model);\n}\n","export function generateCopiedName(originalName: string, exisitingNames: string[]) {\n  const nonDuplicateName = originalName.replace(/\\(copy( [0-9]+)?\\)$/, '').trim();\n\n  let newName = `${nonDuplicateName} (copy)`;\n\n  for (let i = 2; exisitingNames.includes(newName); i++) {\n    newName = `${nonDuplicateName} (copy ${i})`;\n  }\n\n  return newName;\n}\n","import { css } from '@emotion/css';\nimport { CSSProperties } from 'react';\nimport * as React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\n\ninterface StackProps {\n  direction?: CSSProperties['flexDirection'];\n  alignItems?: CSSProperties['alignItems'];\n  wrap?: boolean;\n  gap?: number;\n  flexGrow?: CSSProperties['flexGrow'];\n  children: React.ReactNode;\n}\n\nexport function Stack(props: StackProps) {\n  const styles = useStyles2(getStyles, props);\n  return <div className={styles.root}>{props.children}</div>;\n}\n\nconst getStyles = (theme: GrafanaTheme2, props: StackProps) => ({\n  root: css({\n    display: 'flex',\n    flexDirection: props.direction ?? 'row',\n    flexWrap: (props.wrap ?? true) ? 'wrap' : undefined,\n    alignItems: props.alignItems,\n    gap: theme.spacing(props.gap ?? 2),\n    flexGrow: props.flexGrow,\n  }),\n});\n"],"names":["AlertWarning","title","children","Alert","warningStyles","theme","useAddRuleToRuleGroup","produceNewRuleGroup","useProduceNewRuleGroup","upsertRuleGroup","alertRuleApi","successMessage","ruleGroup","rule","interval","namespaceName","action","newRuleGroupDefinition","rulerConfig","useUpdateRuleInRuleGroup","moveRuleToGroup","useMoveRuleToRuleGroup","ruleIdentifier","ruleDefinition","targetRuleGroup","finalRuleDefinition","copyGrafanaUID","sameTargetRuleGroup","deleteRuleFromGroup","useDeleteRuleFromGroup","currentRuleGroup","addRuleToGroup","newTargetGroup","targetGroupRulerConfig","result","isGrafanaManagedRuleIdentifier","draft","isGrafanaManagedRuleDefinition","GrafanaRuleExportPreview","alertUid","exportFormat","onClose","ruleTextDefinition","isFetching","downloadFileName","LoadingPlaceholder","FileExportPreview","GrafanaRuleExporter","activeTab","setActiveTab","GrafanaExportDrawer","GroupAndNamespaceFields","rulesSourceName","control","watch","errors","setValue","style","getStyle","namespaceGroups","isLoading","useAlertRuleSuggestions","namespace","namespaceOptions","groupOptions","group","Field","onChange","ref","field","value","CloudEvaluationBehavior","styles","getStyles","register","type","dataSourceName","RuleEditorSection","Input","Select","time","PreviewRule","RecordingRulesNameSpaceAndGroupStep","prometheusRulesPrimary","AlertRuleForm","existing","prefill","notifyApp","queryParams","useURLSearchParams","showEditYaml","setShowEditYaml","evaluateEvery","setEvaluateEvery","addRuleToRuleGroup","updateRuleInRuleGroup","routeParams","ruleType","uidFromParams","showDeleteModal","setShowDeleteModal","defaultValues","formValuesFromPrefill","formValuesFromQueryParams","formAPI","handleSubmit","isSubmitting","grafanaTypeRule","showDataSourceDependantStep","conditionErrorMsg","setConditionErrorMsg","checkAlertCondition","msg","submit","values","exitOnSave","ruleGroupIdentifier","storeInLocalStorageValues","targetRuleGroupIdentifier","groupName","returnTo","getReturnToUrl","updatedRuleIdentifier","deleteRule","onInvalid","config","cancelRuleCreation","evaluateEveryInForm","actionButtons","Stack","Button","Spinner","isCortexLokiOrRecordingRule","isPaused","AppChromeUpdate","e","InfoPausedRule","CustomScrollbar","QueryAndExpressionsStep","GrafanaEvaluationBehavior","NotificationsStep","AnnotationsStep","ConfirmModal","RuleInspector","groupId","createViewLinkFromIdentifier","identifier","paramId","paramSource","ruleFromQueryParams","CloneRuleEditor","sourceRuleId","loading","error","ruleClone","cloneRuleDefinition","formPrefill","changeRuleName","newName","ExistingRuleEditor","id","loadingAlertRule","ruleWithLocation","ruleSourceName","isEditable","loadingEditable","useIsRuleEditable","defaultPageNav","getPageNav","RuleEditor","dispatch","searchParams","params","copyFromId","copyFromIdentifier","useAsync","canCreateGrafanaRules","canCreateCloudRules","canEditRules","getContent","AlertingPageWrapper","ModifyExportRuleForm","ruleForm","useQueryParams","exportData","setExportData","formValues","GrafanaRuleDesignExporter","useGetGroup","nameSpaceUID","dsFeatures","getPayloadToExport","uid","existingGroup","grafanaRuleDto","updatedRule","alreadyExistsInGroup","updatedRules","useGetPayloadToExport","rulerGroupDto","GrafanaRuleDesignExportPreview","exportValues","getExport","loadingGroup","payload","GrafanaModifyExport","ModifyExportWrapper","RuleModifyExport","rulerRule","recordingRuleNameValidationPattern","AlertRuleNameAndMetric","ruleFormType","isRecording","isGrafanaRecordingRule","isCloudRecordingRule","recordingLabel","namePlaceholder","entityName","ContactPointDetails","receivers","receiver","index","metadata","pluginMetadata","key","ContactPoint","alertManager","onSelectContactPoint","trigger","contactPointInForm","validateContactPoint","ContactPointSelector","_","LinkToContactPoints","FieldValidationMessage","TextLink","MuteTimingFields","alertmanager","MuteTimingsSelector","RouteTimings","formStyles","getValues","routeTimingsFields","PromDurationInput","groupInterval","REQUIRED_FIELDS_IN_GROUPBY","DEFAULTS_TIMINGS","DISABLE_GROUPING","RoutingSettings","groupByOptions","setGroupByOptions","groupIntervalValue","groupWaitValue","repeatIntervalValue","overrideGrouping","overrideTimings","groupByCount","InlineField","Switch","Text","opt","opts","props","data","MultiValue","AlertManagerManualRouting","alertManagerName","selectedContactPointWithMetadata","setSelectedContactPointWithMetadata","contactPoint","hasRouteSettings","CollapsableSection","SimplifiedRouting","contactPointsInAlert","alertManagersDataSourcesWithConfigAPI","am","selectedContactPoint","alertManagerContactPoint","LabelsEditorModal","isOpen","initialLabels","Modal","LabelsFieldInForm","onEditClick","labels","hasLabels","label","NeedHelpInfo","NotificationPreviewByAlertManager","NotificationPreview","alertQueries","customLabels","condition","folder","alertName","disabled","previewEndpoint","previewUninitialized","potentialInstances","onPreview","alertManagerDataSources","onlyOneAM","alertManagerSource","RoutingOptions","useHasInternalAlertmanagerEnabled","useGetGrafanaAlertingConfigurationStatusQuery","alertmanagerApi","amChoiceStatus","showLabelsEditor","setShowLabelsEditor","simplifiedRoutingToggleEnabled","shouldRenderpreview","hasInternalAlertmanagerEnabled","shouldAllowSimplifiedRouting","onCloseLabelsEditor","labelsToUpdate","ManualAndAutomaticRouting","AutomaticRooting","manualRouting","routingOptions","onRoutingOptionChange","option","RadioButtonGroup","RoutingOptionDescription","queries","NeedHelpInfoForNotificationPolicy","Icon","NeedHelpInfoForContactpoint","isCloudPreviewRequest","request","isGrafanaPreviewRequest","previewAlertRule","fetchAlertRulePreview","dataSourceUid","withLoadingIndicator","createResponse","map","catchError","of","toDataQueryError","share","PreviewRuleResult","preview","fieldConfig","width","height","PanelRenderer","fields","usePreview","allDataSourcesAvailable","useAlertQueriesStatus","isPreviewAvailable","setPreview","isMounted","useMountedState","createPreviewRequest","takeWhile","response","isCompleted","expression","dsSettings","useRulesSourcesWithRuler","dataSources","useUnifiedAlertingSelector","state","ds","dsConfig","mapDataFrameToAlertPreview","labelFields","stateFieldIndex","infoFieldIndex","labelIndexes","labelField","instanceStatusCount","instances","labelValues","labelIndex","info","CloudAlertPreview","alertPreview","instanceTags","AlertStateTag","TagList","Tooltip","ExpressionEditor","showPreviewAlertsButton","mapToValue","mapToQuery","useQueryMappers","dataQuery","dataSource","onChangeQuery","query","onRunQueriesClick","dsi","errorMessage","previewLoaded","QueryEditor","previewDataFrame","s","previewHasAlerts","DataSourcePluginContextProvider","ExpressionsEditor","onSetCondition","panelData","onUpdateRefId","onRemoveExpression","onUpdateExpressionType","onUpdateQueryExpression","expressionQueries","acc","isAlertCondition","warning","Expression","QueryOptions","queryOptions","onChangeTimeRange","onChangeQueryOptions","showOptions","setShowOptions","timeRange","Toggletip","RelativeTimeRangePicker","range","MaxDataPointsOption","options","MinIntervalOption","clearButton","DEFAULT_MAX_DATA_POINTS","DEFAULT_MIN_INTERVAL","QueryWrapper","onChangeDataSource","onRunQueries","onRemoveQuery","onDuplicateQuery","thresholds","thresholdsType","onChangeThreshold","dsInstance","setDsInstance","defaults","isAdvancedMode","queryWithDefaults","SelectingDataSourceTooltip","HeaderExtras","alertQueryOptions","ExpressionStatusIndicator","showVizualisation","editorQueries","QueryEditorRow","settings","VizWrapper","EmptyQueryWrapper","onMaxDataPointsBlur","event","maxDataPointsNumber","maxDataPoints","onMinIntervalBlur","minInterval","QueryRows","onQueriesChange","q","item","itemIndex","updatedQueries","previousSettings","copyModel","newModel","startIndex","endIndex","update","removed","expressions","thresholdByRefId","provided","isCondition","DatasourceNotFound","defaultDataSource","onUpdateDatasource","model","refId","showDetails","setShowDetails","toggleDetails","show","handleUpdateDatasource","QueryOperationRow","Card","onChangeQueries","RecordingRuleEditor","runQueries","setData","handleChangedQuery","changedQuery","dataSourceId","isLoki","expr","merged","err","QueryErrorAlert","CloudRulesSourcePicker","rulesSourcesWithRuler","dataSourceFilter","DataSourcePicker","CloudDataSourceSelector","onChangeCloudDatasource","findDataSourceFromExpression","dag","originQuery","initialState","duplicateQuery","addNewDataQuery","setDataQueries","addNewExpression","removeExpression","removeExpressions","addExpressions","updateExpression","updateExpressionRefId","rewireExpressions","updateExpressionType","updateExpressionTimeRange","updateMaxDataPoints","updateMinInterval","resetToSimpleCondition","setRecordingRulesQueries","queriesAndExpressionsReducer","builder","addQuery","datasource","recordingRuleQuery","queryToUpdate","originalQueries","relativeTimeRange","dataSourceAlertQuery","newRefId","oldRefId","queryToAdd","defaultTimeRange","SIMPLE_CONDITION_QUERY_ID","SIMPLE_CONDITION_REDUCER_ID","SIMPLE_CONDITION_THRESHOLD_ID","SimpleConditionEditor","simpleCondition","expressionQueriesList","previewData","onReducerTypeChange","updateReduceExpression","isRange","thresholdFunction","fn","onEvalFunctionChange","updateThresholdFunction","onEvaluateValueChange","newParams","updateThresholdValue","InlineFieldRow","o","ButtonSelect","reducer","reduceExpression","newReduceExpression","evaluator","thresholdExpression","newThresholdExpression","getSimpleConditionFromExpressions","conditionsFromThreshold","getAvailableRuleTypes","defaultRuleType","enabledRuleTypes","onlyOneDSInQueries","getCanSwitch","availableRuleTypes","onlyOneDS","dataSourceIdFromQueries","isRecordingRuleType","canSwitchToCloudRule","dsJsonData","canSwitchToGrafanaRule","grafanaTypeEnabled","cloudTypeEnabled","canSwitchFromCloudToGrafana","canSwitchFromGrafanaToCloud","SmartAlertTypeDetector","editingExistingRule","onClickSwitch","canSwitch","disabledOptions","DESCRIPTIONS","useAlertQueryRunner","queryPreviewData","setQueryPreviewData","runner","AlertingQueryRunner","currentRunner","clearPreviewData","cancelQueries","queriesToPreview","isPreviewLoading","d","areQueriesTransformableToSimpleCondition","dataQueries","reduceExpressionIndex","reduceOk","thresholdExpressionIndex","conditions","thresholdOk","onDataChange","isSwitchModeEnabled","isExpressionQueryInAlert","editorSettings","isGrafanaAlertingType","isCloudAlertRuleType","showResetModeModal","setShowResetModal","setSimpleCondition","dispatchReduxAction","runQueriesPreview","noCompatibleDataSources","emptyQueries","currentCondition","handleSetCondition","updateExpressionAndDatasource","useSetExpressionAndDataSource","onChangeRecordingRulesQueries","recordingRuleDefaultDatasource","defaultQuery","lastRefId","onClickType","datasourceUid","newQueries","onChangeExpression","promLoki","removeExpressionsInQueries","addExpressionsInQueries","prevExpressions","setPrevExpressions","prevCondition","setPrevCondition","restoreExpressionsInQueries","newDsName","sectionTitle","helpLabel","helpContent","helpLink","switchMode","isAdvanced","selectors","TypeSelectorButton","newMenu","Menu","MenuItem","Dropdown","generateCopiedName","originalName","exisitingNames","nonDuplicateName","i"],"sourceRoot":""}